<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Stock System</title>

  <style>
  :root{
    --pink-1:#ff6fae;
    --pink-2:#ff9fcf;
    --pink-3:#ffe1ef;
    --glass-bg:rgba(255,255,255,.65);
    --glass-br:rgba(255,255,255,.45);
    --text-dark:#5a2240;
  }

  *{box-sizing:border-box}
  html,body{margin:0;padding:0}
  body{
    font-family: system-ui, -apple-system, "Noto Sans Thai", sans-serif;
    color:var(--text-dark);
    min-height:100vh;
    background:
      radial-gradient(1200px 600px at 10% -10%, #ffd6ea 0%, transparent 60%),
      linear-gradient(135deg, #ffb3d9 0%, #ffe4f0 50%, #ffffff 100%);
  }

  header{
    position:sticky; top:0; z-index:10;
    padding:14px 16px;
    font-weight:700;
    backdrop-filter: blur(10px);
    background: linear-gradient(135deg, rgba(255,255,255,.55), rgba(255,255,255,.25));
    border-bottom:1px solid var(--glass-br);
  }

  #app{
    padding:14px;
    display:grid;
    grid-template-columns: repeat(2, minmax(0,1fr));
    gap:12px;
  }

  .card{
    background: linear-gradient(135deg, var(--glass-bg), rgba(255,255,255,.35));
    backdrop-filter: blur(14px);
    border:1px solid var(--glass-br);
    border-radius:18px;
    padding:10px;
    box-shadow:
      0 10px 28px rgba(255,111,174,.22),
      inset 0 1px 0 rgba(255,255,255,.6);
    transition: transform .15s ease;
  }
  .card:active{ transform: scale(.98); }

  .card img{
    width:100%;
    aspect-ratio:1/1;
    object-fit:cover;
    border-radius:14px;
    background:#fff;
  }

  .card h3{
    font-size:14px;
    margin:8px 0 2px;
    line-height:1.25;
  }
  .meta{ font-size:12px; opacity:.85; }
  .cost{ font-size:13px; font-weight:700; margin-top:4px; }

  .badge{
    display:inline-block;
    margin-top:6px;
    padding:4px 8px;
    font-size:11px;
    font-weight:700;
    border-radius:999px;
    color:#fff;
    background: linear-gradient(135deg, var(--pink-1), #ff4f9a);
    box-shadow: 0 6px 16px rgba(255,79,154,.35);
  }

  .empty{
    grid-column:1/-1;
    text-align:center;
    padding:24px 8px;
    opacity:.8;
  }

  @media (min-width:768px){
    #app{ grid-template-columns: repeat(4, minmax(0,1fr)); }
  }
    /* ===== Detail Page ===== */
.detail{
  padding:14px;
}

.back-btn{
  display:inline-block;
  margin-bottom:10px;
  font-size:14px;
  font-weight:600;
  cursor:pointer;
}

.detail-card{
  background: linear-gradient(135deg, var(--glass-bg), rgba(255,255,255,.35));
  backdrop-filter: blur(16px);
  border:1px solid var(--glass-br);
  border-radius:20px;
  padding:14px;
  box-shadow:
    0 14px 32px rgba(255,111,174,.25),
    inset 0 1px 0 rgba(255,255,255,.6);
}

.detail-card img{
  width:100%;
  aspect-ratio:1/1;
  object-fit:cover;
  border-radius:16px;
  margin-bottom:12px;
}

.detail-title{
  font-size:18px;
  font-weight:700;
}

.detail-meta{
  font-size:13px;
  opacity:.85;
  margin-top:4px;
}

.detail-cost{
  margin-top:8px;
  font-size:16px;
  font-weight:700;
}

.detail-status{
  margin-top:10px;
}

    /* ===== Admin ===== */
.admin-bar{
  position:fixed;
  bottom:16px;
  left:50%;
  transform:translateX(-50%);
  z-index:20;
}

.stock-btn{
  padding:14px 20px;
  font-size:16px;
  font-weight:700;
  border-radius:999px;
  border:1px solid var(--glass-br);
  background: linear-gradient(135deg, var(--pink-1), #ff4f9a);
  color:#fff;
  box-shadow:0 14px 32px rgba(255,79,154,.45);
  cursor:pointer;
}

/* ===== Modal ===== */
.modal-bg{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.35);
  backdrop-filter: blur(6px);
  display:flex;
  align-items:flex-end;
  z-index:30;
}

.modal{
  width:100%;
  background: linear-gradient(135deg, var(--glass-bg), rgba(255,255,255,.35));
  border-radius:24px 24px 0 0;
  padding:20px;
  box-shadow:0 -20px 40px rgba(0,0,0,.25);
}

.modal h3{
  margin:0 0 12px;
}

.modal button{
  width:100%;
  padding:14px;
  margin-top:10px;
  font-size:15px;
  font-weight:700;
  border-radius:14px;
  border:0;
  cursor:pointer;
}

.btn-in{ background:#4caf50; color:#fff; }
.btn-out{ background:#ff4f9a; color:#fff; }
.btn-close{ background:#ccc; }
/* ===== Logs View (STEP 9.2-B) ===== */
.logs{
  padding:14px;
}

.log-item{
  background: linear-gradient(135deg, var(--glass-bg), rgba(255,255,255,.35));
  border:1px solid var(--glass-br);
  border-radius:16px;
  padding:12px;
  margin-bottom:10px;
  font-size:13px;
  box-shadow:0 8px 20px rgba(255,111,174,.18);
}

.log-item .row{
  display:flex;
  justify-content:space-between;
  margin-bottom:4px;
}

.log-in{
  color:#2e7d32;
  font-weight:700;
}

.log-out{
  color:#c62828;
  font-weight:700;
}

.log-time{
  font-size:11px;
  opacity:.7;
}

    /* ===== Upload Progress ===== */
.upload-progress-wrap{
  margin-top:10px;
  display:none;
}

.upload-progress-bar{
  width:100%;
  height:10px;
  border-radius:999px;
  background:rgba(0,0,0,.08);
  overflow:hidden;
}

.upload-progress{
  height:100%;
  width:0%;
  background:linear-gradient(135deg,#ff6fae,#ff4f9a);
  transition:width .15s ease;
}

.upload-progress-text{
  margin-top:6px;
  font-size:12px;
  text-align:center;
  opacity:.8;
}

  </style>
</head>
<body>

<header>Stock System</header>

<div id="adminLogin" style="padding:14px; display:none">
  <input id="adminId" placeholder="Admin ID" style="padding:8px; width:120px">
  <input id="adminPw" type="password" placeholder="Password" style="padding:8px; width:120px">
  <button onclick="loginAdmin()">üîê Login</button>
</div>

<div id="adminLogout" style="padding:14px; display:none">
  <button onclick="logoutAdmin()">üö™ Logout</button>
</div>


<main id="app"></main>

<!-- üîò ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏≠‡∏¢‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô -->
<div id="adminBar" class="admin-bar" style="display:none">
  <button class="stock-btn" onclick="openAddProductModal()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
  <button class="stock-btn" style="margin-left:8px" onclick="openStockModal()">üì¶ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πä‡∏≠‡∏Å</button>
  <button class="stock-btn" style="margin-left:8px" onclick="openLogs()">üìä ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
</div>

<!-- üßæ Modal (‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏≠‡∏Å adminBar) -->
<div id="stockModal" class="modal-bg" style="display:none">
  <div class="modal">

    <h3>üì¶ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πä‡∏≠‡∏Å</h3>

    <div id="stockInfo" style="font-size:14px; margin-bottom:10px;"></div>

    <input
      id="stockQty"
      type="number"
      min="1"
      placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô"
      style="
        width:100%;
        padding:14px;
        font-size:16px;
        border-radius:14px;
        border:1px solid #ddd;
        margin-bottom:12px;
      "
    >

    <button class="btn-in" onclick="confirmStockIn()">‚ûï ‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤</button>
    <button class="btn-out" onclick="confirmStockOut()">‚ûñ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å</button>

    <button class="btn-close" onclick="closeStockModal()">‡∏õ‡∏¥‡∏î</button>
    
  </div>
</div>

  
<script>
const API = "https://script.google.com/macros/s/AKfycby8s440W72bqx8khrsDZnCo0FQelouKbs8bdFoNfqDkUPfXwdshGg16K3sbJbxRKArf3A/exec";
let currentProduct = null;

/* ===== LOAD PRODUCTS ===== */
fetch(API + "?action=list")
  .then(r => r.json())
  .then(res => res.ok && renderProducts(res.data));

applyAdminSession();

/* ===== LIST ===== */
function renderProducts(items){
  const app = document.getElementById("app");

  if (!items || items.length === 0) {
    app.innerHTML = `<div class="empty">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>`;
    return;
  }

  app.innerHTML = items.map(p => `
    <div class="card" onclick='openDetail(${JSON.stringify(p)})'>
      <img src="${p.image || 'https://via.placeholder.com/300'}" alt="">
      <h3>${p.name}</h3>
      <div class="meta">SKU: ${p.sku}</div>
      <div class="cost">üí∞ ‡∏ó‡∏∏‡∏ô: ‡∏ø${p.cost}</div>
      <span class="badge">${p.status}</span>
    </div>
  `).join("");
}

/* ===== DETAIL + UPLOAD ===== */
function openDetail(p){
  currentProduct = p;

  const app = document.getElementById("app"); // ‚úÖ FIX: ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏® app ‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î
  const isAdmin = localStorage.getItem("isAdmin") === "1";

  app.innerHTML = `
    <div class="detail">

      <div class="back-btn" onclick="goBack()">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</div>

      <div class="detail-card">

        <img id="detailImage"
             src="${p.image || 'https://via.placeholder.com/400'}"
             alt="">

        ${isAdmin ? `
<div style="margin:10px 0">

  <input type="file"
         id="uploadInput"
         accept="image/*"
         hidden
         onchange="uploadImageFile()">

  <button id="uploadBtn"
          class="stock-btn"
          style="width:100%; padding:12px; font-size:14px"
          onclick="document.getElementById('uploadInput').click()">
    üì∑ ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î / ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
  </button>

  <div class="upload-progress-wrap" id="uploadProgressWrap">
    <div class="upload-progress-bar">
      <div class="upload-progress" id="uploadProgress"></div>
    </div>
    <div class="upload-progress-text" id="uploadProgressText">
      ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏£‡∏π‡∏õ‚Ä¶
    </div>
  </div>

</div>
` : ""}

        <div class="detail-title">${p.name}</div>
        <div class="detail-meta">SKU: ${p.sku}</div>
        <div class="detail-cost">üí∞ ‡∏ø${p.cost}</div>
        <span class="badge">${p.status}</span>

      </div>
    </div>
  `;
}

/* ===== UPLOAD IMAGE (WITH COMPRESSION) ===== */
function uploadImageFile(){
  const input = document.getElementById("uploadInput");
  const img = document.getElementById("detailImage");
  const btn = document.getElementById("uploadBtn");
  if (btn.disabled) return;
  const wrap = document.getElementById("uploadProgressWrap");
  const bar = document.getElementById("uploadProgress");
  const text = document.getElementById("uploadProgressText");

  if (!input || !input.files.length) return;

  const file = input.files[0];
  if (!file.type.startsWith("image/")) {
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û");
    return;
  }

  // ===== CONFIG =====
  const MAX_WIDTH = 1280;
  const JPEG_QUALITY = 0.75;

  // UI start
  wrap.style.display = "block";
  bar.style.width = "0%";
  text.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡∏£‡∏π‡∏õ‚Ä¶";
  btn.disabled = true;
  btn.style.opacity = ".6";

  const reader = new FileReader();
  reader.onload = function(e){
    const image = new Image();
    image.onload = function(){

      let w = image.width;
      let h = image.height;
      if (w > MAX_WIDTH) {
        h = Math.round(h * (MAX_WIDTH / w));
        w = MAX_WIDTH;
      }

      const canvas = document.createElement("canvas");
      canvas.width = w;
      canvas.height = h;
      canvas.getContext("2d").drawImage(image, 0, 0, w, h);

      canvas.toBlob(blob => {
        if (!blob) {
          alert("‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
          return;
        }

        text.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‚Ä¶";

        const fd = new FormData();
        fd.append("file", blob, file.name.replace(/\.\w+$/, ".jpg"));
        fd.append("sku", currentProduct.sku);

        const xhr = new XMLHttpRequest();
        xhr.open("POST", API + "?action=uploadimage");

        xhr.upload.onprogress = e => {
          if (e.lengthComputable) {
            const percent = Math.round((e.loaded / e.total) * 100);
            bar.style.width = percent + "%";
            text.textContent = `‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î ${percent}%`;
          }
        };

        xhr.onload = () => {
          btn.disabled = false;
          btn.style.opacity = "1";

          if (xhr.status !== 200) {
            alert("‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
            return;
          }

          const res = JSON.parse(xhr.responseText);
          if (!res.ok) {
            alert("‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
            return;
          }

          bar.style.width = "100%";
          text.textContent = "‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå ‚úî";

          img.src = res.image;
          currentProduct.image = res.image;

          setTimeout(() => {
            wrap.style.display = "none";
            input.value = "";
          }, 1200);
        };

        xhr.onerror = () => {
          alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î");
          btn.disabled = false;
          btn.style.opacity = "1";
        };

        xhr.send(fd);

      }, "image/jpeg", JPEG_QUALITY);
    };
    image.src = e.target.result;
  };

  reader.readAsDataURL(file);
}

/* ===== STOCK ===== */
function openStockModal(){
  if (!currentProduct) return alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô");
  stockInfo.innerHTML = `${currentProduct.name}<br>SKU:${currentProduct.sku}`;
  stockModal.style.display = "flex";
}
  function closeStockModal(){
  stockModal.style.display = "none";
}

function confirmStockIn(){ updateStock(+stockQty.value); }
function confirmStockOut(){ updateStock(-stockQty.value); }

function updateStock(delta){
  fetch(`${API}?action=updateStock&sku=${currentProduct.sku}&delta=${delta}`)
    .then(r=>r.json())
    .then(()=>{ closeStockModal(); goBack(); });
}

/* ===== LOGS ===== */
function openLogs(){
  fetch(API + "?action=getlogs")
    .then(r=>r.json())
    .then(res=>renderLogs(res.data));
}

function renderLogs(logs){
  const app = document.getElementById("app");

  if (!logs || logs.length === 0) {
    app.innerHTML = `<div class="empty">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</div>`;
    return;
  }

  app.innerHTML = `
    <div class="logs">
      <div class="back-btn" onclick="goBack()">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</div>
      ${logs.map(l => `
        <div class="log-item">
          <b>${l.name}</b> (${l.sku})<br>
          ${l.action} ${l.delta} ‚Üí ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${l.stock_after}
        </div>
      `).join("")}
    </div>
  `;
}

/* ===== NAV ===== */
function goBack(){ fetch(API+"?action=list").then(r=>r.json()).then(res=>renderProducts(res.data)); }

/* ===== ADMIN ===== */
function loginAdmin(){
  fetch(`${API}?action=login&id=${adminId.value}&password=${adminPw.value}`)
    .then(r=>r.json())
    .then(res=>{
      if(!res.ok) return alert("Login fail");
      localStorage.setItem("isAdmin","1");
      applyAdminSession();
    });
}
function logoutAdmin(){
  localStorage.removeItem("isAdmin");
  applyAdminSession();
}
function applyAdminSession(){
  const a = localStorage.getItem("isAdmin")==="1";
  adminLogin.style.display = a?"none":"block";
  adminLogout.style.display = a?"block":"none";
  adminBar.style.display = a?"block":"none";
}
  /* ===== ADD PRODUCT ===== */
function openAddProductModal(){
  addProductModal.style.display = "flex";
}

function closeAddProductModal(){
  addProductModal.style.display = "none";
}

/* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏ö‡∏ö Draft */
function confirmAddProduct(){
  const sku = newSku.value.trim();
  const name = newName.value.trim();
  const cost = newCost.value || 0;
  const note = newNote.value || "";

  if (!sku || !name) {
    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å SKU ‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤");
    return;
  }

  fetch(`${API}?action=addproduct&sku=${encodeURIComponent(sku)}&name=${encodeURIComponent(name)}&cost=${cost}&note=${encodeURIComponent(note)}`)
    .then(r => r.json())
    .then(res => {
      if (!res.ok) {
        alert(res.error || "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        return;
      }

      alert("‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà (Draft) ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
      closeAddProductModal();
      goBack(); // reload list
    });
}

</script>
  <!-- üÜï Modal ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ -->
<div id="addProductModal" class="modal-bg" style="display:none">
  <div class="modal">

    <h3>‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</h3>

    <input id="newSku" placeholder="SKU (‡πÄ‡∏ä‡πà‡∏ô SKU002)"
      style="width:100%;padding:14px;border-radius:14px;border:1px solid #ddd;margin-bottom:10px">

    <input id="newName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤"
      style="width:100%;padding:14px;border-radius:14px;border:1px solid #ddd;margin-bottom:10px">

    <input id="newCost" type="number" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏∏‡∏ô"
      style="width:100%;padding:14px;border-radius:14px;border:1px solid #ddd;margin-bottom:10px">

    <textarea id="newNote" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)"
      style="width:100%;padding:14px;border-radius:14px;border:1px solid #ddd"></textarea>

    <button class="btn-in" onclick="confirmAddProduct()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (Draft)</button>
    <button class="btn-close" onclick="closeAddProductModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>

  </div>
</div>

</body>
</html>
