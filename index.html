<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>StockBuilder</title>
</head>
  <body>
  <!-- ========================= -->
<!-- UI STYLE (STEP 2) -->
<!-- ========================= -->
<style>
  :root {
    --bg: #0b1020;
    --glass: rgba(255,255,255,0.08);
    --glass-border: rgba(255,255,255,0.18);
    --glow: 0 0 30px rgba(56,189,248,0.25);
    --primary: #38bdf8;
    --text-muted: #94a3b8;
  }

  * {
    box-sizing: border-box;
  }

  body {
    margin: 0;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    background: radial-gradient(circle at top, #0f172a, var(--bg));
    color: #fff;
    min-height: 100vh;
  }

  #app {
    padding: 16px;
    max-width: 480px;
    margin: 0 auto;
  }

  h1 {
    font-size: 1.4rem;
    margin: 0 0 12px;
  }

  p {
    margin: 0;
    color: var(--text-muted);
    font-size: 0.9rem;
  }

  /* ===== Glass Card ===== */
  .card {
    background: var(--glass);
    border: 1px solid var(--glass-border);
    border-radius: 18px;
    padding: 16px;
    margin-bottom: 14px;
    backdrop-filter: blur(14px);
    -webkit-backdrop-filter: blur(14px);
    box-shadow: var(--glow);
  }

  /* ===== Header ===== */
  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
  }

  .badge {
    background: rgba(56,189,248,0.15);
    color: var(--primary);
    padding: 4px 10px;
    border-radius: 999px;
    font-size: 0.75rem;
    border: 1px solid rgba(56,189,248,0.4);
  }

  /* ===== Product Grid (‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÑ‡∏ß‡πâ STEP 5) ===== */
  .grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
  }

  .product-card {
    background: var(--glass);
    border: 1px solid var(--glass-border);
    border-radius: 16px;
    padding: 12px;
    backdrop-filter: blur(12px);
    box-shadow: 0 0 20px rgba(0,0,0,0.3);
  }

  .product-img {
    width: 100%;
    height: 110px;
    background: linear-gradient(135deg, #1e293b, #020617);
    border-radius: 12px;
    margin-bottom: 8px;
  }

  .product-name {
    font-size: 0.9rem;
    margin-bottom: 4px;
  }

  .product-price {
    color: var(--primary);
    font-weight: 600;
    font-size: 0.95rem;
  }

  /* ===== Admin Accent ===== */
  .admin {
    border-left: 3px solid var(--primary);
  }
</style>


  <!-- ========================= -->
  <!-- APP ROOT -->
  <!-- ========================= -->
  <div id="app"></div>

<!-- ========================= -->
<!-- GLOBAL STATE -->
<!-- ========================= -->
<script>
  const state = {
    mode: 'viewer',
    token: null,

    products: [],
    filteredProducts: [],

    search: '',
    category: 'all',

    loading: false,
    error: null,

    submitting: false,   // üîí ‡∏Å‡∏±‡∏ô‡∏Å‡∏î‡∏ã‡πâ‡∏≥
    logs: []              // üßæ ‡πÄ‡∏Å‡πá‡∏ö log ‡∏ù‡∏±‡πà‡∏á‡∏´‡∏ô‡πâ‡∏≤
  };
</script>


  <!-- ========================= -->
<!-- API CONFIG -->
<!-- ========================= -->
<script>
  const API_URL = 'PASTE_YOUR_APPS_SCRIPT_URL_HERE';
</script>


  <!-- ========================= -->
<!-- STATE INIT -->
<!-- ========================= -->
<script>
  function initState() {
    const savedToken = localStorage.getItem('admin_token');

    if (savedToken) {
      state.mode = 'admin';
      state.token = savedToken;
    } else {
      state.mode = 'viewer';
      state.token = null;
    }
  }

  function logoutAdmin() {
    localStorage.removeItem('admin_token');
    state.mode = 'viewer';
    state.token = null;
    renderUI();
  }
</script>

<!-- ========================= -->
<!-- API FUNCTIONS -->
<!-- ========================= -->
<script>
  async function apiRequest(action, payload = {}) {
    state.loading = true;
    state.error = null;
    renderUI();

    try {
      const res = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          action,
          token: state.token,
          payload
        })
      });

      const data = await res.json();

      if (!data.success) {
        throw new Error(data.message || 'API Error');
      }

      return data.data;
    } catch (err) {
      state.error = err.message;
      console.error(err);
      return null;
    } finally {
      state.loading = false;
      renderUI();
    }
  }

  /* ===== API WRAPPERS ===== */

  function apiListProducts() {
    return apiRequest('list');
  }

  function apiLogin(username, password) {
    return apiRequest('login', { username, password });
  }

  function apiAddProduct(product) {
    return apiRequest('add', product);
  }

  function apiUpdateProduct(product) {
    return apiRequest('update', product);
  }

  function apiUpdateStock(code, diff) {
    return apiRequest('updateStock', { code, diff });
  }
</script>

    <!-- ===== IMAGE UPLOAD ===== -->
<script>
  async function apiUploadImage(file) {
    state.loading = true;
    state.error = null;
    renderUI();

    try {
      const base64 = await fileToBase64(file);

      const res = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          action: 'upload',
          token: state.token,
          payload: {
            filename: file.name,
            mimeType: file.type,
            data: base64
          }
        })
      });

      const json = await res.json();
      if (!json.success) throw new Error(json.message);

      return json.data.url;
    } catch (e) {
      state.error = e.message;
      return null;
    } finally {
      state.loading = false;
      renderUI();
    }
  }

  function fileToBase64(file) {
    return new Promise(res => {
      const reader = new FileReader();
      reader.onload = () => res(reader.result.split(',')[1]);
      reader.readAsDataURL(file);
    });
  }
</script>

    <!-- ===== PRODUCTION HELPERS ===== -->
<script>
  function validateProduct(p) {
    if (!p.code) return '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
    if (!p.name) return '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
    if (isNaN(p.price) || p.price < 0) return '‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ú‡∏¥‡∏î';
    if (isNaN(p.stock)) return '‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏ú‡∏¥‡∏î';
    if (!p.category) return '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏°‡∏ß‡∏î';
    return null;
  }

  function logAction(action, payload) {
    const log = {
      time: new Date().toISOString(),
      action,
      payload
    };
    state.logs.push(log);
    console.log('LOG:', log);
    // STEP 9: ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á backend ‚Üí ‡πÄ‡∏û‡∏¥‡πà‡∏° apiRequest('log', log)
  }
</script>

<!-- ========================= -->
<!-- RENDER FUNCTIONS -->
<!-- ========================= -->
<script>
  /* =========================
     VIEWER SUPPORT
  ========================= */

  async function loadProducts() {
    const data = await apiListProducts();
    if (!data) return;
    state.products = data;
    applyFilter();
    renderUI();
  }

  function applyFilter() {
    state.filteredProducts = state.products.filter(p => {
      const matchSearch =
        p.name.toLowerCase().includes(state.search.toLowerCase());
      const matchCategory =
        state.category === 'all' || p.category === state.category;
      return matchSearch && matchCategory;
    });
  }

  function onSearch(value) {
    state.search = value;
    applyFilter();
    renderUI();
  }

  function onFilterCategory(value) {
    state.category = value;
    applyFilter();
    renderUI();
  }

  function renderCategoryOptions() {
    const categories = [...new Set(state.products.map(p => p.category))];
    return categories.map(c => `<option value="${c}">${c}</option>`).join('');
  }

  /* =========================
     ADMIN LOGIN
  ========================= */

  function renderAdminLogin() {
    const app = document.getElementById('app');
    app.innerHTML = '';

    const header = document.createElement('div');
    header.className = 'header';
    header.innerHTML = `
      <h1>üîê Admin Login</h1>
      <button class="badge" onclick="renderUI()">Back</button>
    `;

    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <input id="login-user" placeholder="Username"
        style="width:100%;padding:10px;margin-bottom:8px;" />
      <input id="login-pass" type="password" placeholder="Password"
        style="width:100%;padding:10px;margin-bottom:8px;" />
      <button onclick="submitLogin()"
        style="width:100%;padding:12px;background:#38bdf8;">
        Login
      </button>
    `;

    app.appendChild(header);
    app.appendChild(card);
  }

  async function submitLogin() {
    const u = document.getElementById('login-user').value;
    const p = document.getElementById('login-pass').value;

    if (!u || !p) {
      alert('‡∏Å‡∏£‡∏≠‡∏Å username ‡πÅ‡∏•‡∏∞ password');
      return;
    }

    const data = await apiLogin(u, p);
    if (!data) return;

    localStorage.setItem('admin_token', data.token);
    state.token = data.token;
    state.mode = 'admin';
    renderUI();
  }

  /* =========================
     MAIN RENDER
  ========================= */

  function renderUI() {
    const app = document.getElementById('app');
    app.innerHTML = '';

    if (state.mode === 'viewer') renderViewer(app);
    if (state.mode === 'admin') renderAdmin(app);

    if (state.loading || state.submitting) {
      renderOverlay(app);
    }
  }

  /* =========================
     VIEWER
  ========================= */

  async function renderViewer(root) {
    const header = document.createElement('div');
    header.className = 'header';
    header.innerHTML = `
      <h1>üì¶ StockBuilder</h1>
      <button class="badge" onclick="renderAdminLogin()">Admin</button>
    `;
    root.appendChild(header);

    if (state.loading) return root.appendChild(renderLoading());
    if (state.error) return root.appendChild(renderError());

    if (state.products.length === 0) {
      await loadProducts();
      return;
    }

    const searchCard = document.createElement('div');
    searchCard.className = 'card';
    searchCard.innerHTML = `
      <input placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤..."
        value="${state.search}"
        oninput="onSearch(this.value)"
        style="width:100%;padding:10px;border-radius:12px;border:none;" />
      <select onchange="onFilterCategory(this.value)"
        style="width:100%;margin-top:10px;padding:10px;border-radius:12px;border:none;">
        <option value="all">‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏ß‡∏î</option>
        ${renderCategoryOptions()}
      </select>
    `;
    root.appendChild(searchCard);
    root.appendChild(renderProductGrid());
  }

  function renderProductGrid() {
    const grid = document.createElement('div');
    grid.className = 'grid';

    state.filteredProducts.forEach(p => {
      const card = document.createElement('div');
      card.className = 'product-card';
      card.innerHTML = `
        <div class="product-img"
          style="background-image:url('${p.image || ''}');
                 background-size:cover;
                 background-position:center;">
        </div>
        <div class="product-name">${p.name}</div>
        <div class="product-price">‡∏ø${p.price}</div>
      `;
      grid.appendChild(card);
    });

    return grid;
  }

  /* =========================
     ADMIN DASHBOARD
  ========================= */

  async function renderAdmin(root) {
    const header = document.createElement('div');
    header.className = 'header';
    header.innerHTML = `
      <h1>üßë‚Äçüíº Admin Dashboard</h1>
      <button class="badge" onclick="logoutAdmin()">Logout</button>
    `;
    root.appendChild(header);

    const addBtn = document.createElement('button');
    addBtn.className = 'card';
    addBtn.innerHTML = '‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà';
    addBtn.onclick = () => openProductForm();
    root.appendChild(addBtn);

    if (state.loading) return root.appendChild(renderLoading());
    if (state.error) return root.appendChild(renderError());

    const data = await apiListProducts();
    if (!data) return;

    state.products = data;

    state.products.forEach(p => {
      const card = document.createElement('div');
      card.className = 'card admin';
      card.innerHTML = `
        <b>${p.name}</b> (${p.code})<br/>
        ‡∏£‡∏≤‡∏Ñ‡∏≤: ‡∏ø${p.price}<br/>
        ‡∏´‡∏°‡∏ß‡∏î: ${p.category}<br/>
        ‡∏™‡∏ï‡πä‡∏≠‡∏Å: <b>${p.stock}</b><br/>
        ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${p.status}<br/><br/>
        <button onclick="adjustStock('${p.code}',1)">Ôºã</button>
        <button onclick="adjustStock('${p.code}',-1)">Ôºç</button>
        <button onclick="openProductForm(${JSON.stringify(p).replace(/"/g,'&quot;')})">‚úèÔ∏è</button>
      `;
      root.appendChild(card);
    });
  }

  /* =========================
     PRODUCT FORM
  ========================= */

  function openProductForm(product = null) {
    const app = document.getElementById('app');
    app.innerHTML = '';

    const isEdit = !!product;

    const header = document.createElement('div');
    header.className = 'header';
    header.innerHTML = `
      <h1>${isEdit ? '‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' : '‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'}</h1>
      <button class="badge" onclick="renderUI()">Back</button>
    `;

    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <input id="p-code" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤"
        value="${product?.code || ''}" ${isEdit ? 'disabled' : ''} />
      <input id="p-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" value="${product?.name || ''}" />
      <input id="p-price" type="number" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤" value="${product?.price || ''}" />
      <input id="p-stock" type="number" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô" value="${product?.stock || 0}" />
      <input id="p-category" placeholder="‡∏´‡∏°‡∏ß‡∏î" value="${product?.category || ''}" />

      <select id="p-status">
        ${['‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á','‡∏´‡∏°‡∏î','‡πÇ‡∏Å‡∏î‡∏±‡∏á‡πÑ‡∏ó‡∏¢','‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á']
          .map(s => `<option ${product?.status===s?'selected':''}>${s}</option>`).join('')}
      </select>

      <input id="p-image" type="file" accept="image/*" />
      ${product?.image ? `<img src="${product.image}" style="width:100%;border-radius:12px;margin-top:8px;" />` : ''}

      <button onclick="submitProduct(${isEdit})"
        style="margin-top:12px;width:100%;padding:12px;background:#38bdf8;">
        ${isEdit ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'}
      </button>
    `;
    app.appendChild(header);
    app.appendChild(card);
  }

  async function submitProduct(isEdit) {
    if (state.submitting) return;
    state.submitting = true;

    const file = document.getElementById('p-image').files[0];
    let imageUrl = null;

    if (file) {
      imageUrl = await apiUploadImage(file);
      if (!imageUrl) {
        state.submitting = false;
        return;
      }
    }

    const product = {
      code: document.getElementById('p-code').value,
      name: document.getElementById('p-name').value,
      price: Number(document.getElementById('p-price').value),
      stock: Number(document.getElementById('p-stock').value),
      category: document.getElementById('p-category').value,
      status: document.getElementById('p-status').value,
      image: imageUrl
    };

    const err = validateProduct(product);
    if (err) {
      state.error = err;
      state.submitting = false;
      renderUI();
      return;
    }

    if (isEdit) {
      await apiUpdateProduct(product);
      logAction('update', product);
    } else {
      await apiAddProduct(product);
      logAction('add', product);
    }

    state.submitting = false;
    renderUI();
  }

  async function adjustStock(code, diff) {
    if (state.submitting) return;
    state.submitting = true;

    await apiUpdateStock(code, diff);
    logAction('updateStock', { code, diff });

    state.submitting = false;
    renderUI();
  }

  /* =========================
     COMMON
  ========================= */

  function renderLoading() {
    const div = document.createElement('div');
    div.className = 'card';
    div.innerHTML = `<p>‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>`;
    return div;
  }

  function renderError() {
    const div = document.createElement('div');
    div.className = 'card';
    div.innerHTML = `<p>‚ùå ${state.error}</p>`;
    return div;
  }

  function renderOverlay(root) {
    const overlay = document.createElement('div');
    overlay.style = `
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.5);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:9999;
    `;
    overlay.innerHTML = `
      <div class="card">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</div>
    `;
    root.appendChild(overlay);
  }
</script>
<!-- ========================= -->
<!-- APP START -->
<!-- ========================= -->
<script>
  initState();
  renderUI();
</script>

</body>
</html>
