<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>StockBuilder</title>
  <link rel="icon" href="data:,">  
</head>
  <body>
  <!-- ========================= -->
<!-- UI STYLE (STEP 2) -->
<!-- ========================= -->
<style>
/* =========================
   CATEGORY COLORS
========================= */
.code-bag {
  background: linear-gradient(90deg,#fbcfe8,#f472b6);
  color: #831843;
}

.code-jewelry {
  background: linear-gradient(90deg,#fde68a,#facc15);
  color: #713f12;
}

.code-utility {
  background: linear-gradient(90deg,#bfdbfe,#60a5fa);
  color: #1e3a8a;
}

.code-doll {
  background: linear-gradient(90deg,#ddd6fe,#a78bfa);
  color: #4c1d95;
}

.code-other {
  background: linear-gradient(90deg,#e5e7eb,#9ca3af);
  color: #1f2933;
}
/* ===== FONT ===== */
@import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');

:root {
  --bg-main: radial-gradient(
    circle at top,
    #7c3aed,
    #2e1065 55%,
    #020617
  );

  --glass: rgba(255,255,255,0.14);
  --glass-strong: rgba(255,255,255,0.22);
  --glass-border: rgba(255,255,255,0.28);

  --gold-soft: #fde68a;
  --gold: #facc15;
  --gold-deep: #92400e;

  --text-main: #ffffff;
  --text-muted: rgba(255,255,255,0.65);

  --glow-soft: 0 0 20px rgba(250,204,21,0.25);
  --glow: 0 0 36px rgba(250,204,21,0.45);
  --primary-gold: #facc15;
  --primary-admin: #38bdf8;


}


* {
  box-sizing: border-box;
}

body {
  margin: 0;
  font-family: 'Sarabun', 'Anuphan', system-ui, sans-serif;
  background: var(--bg-main);
  color: var(--text-main);
  min-height: 100vh;
}

#app {
  padding: 18px;
  max-width: 480px;
  margin: 0 auto;
}

/* ===== TYPO ===== */
h1 {
  font-size: 1.6rem;
  margin: 0 0 14px;
  font-weight: 700;
  letter-spacing: 0.3px;
}

p {
  margin: 0;
  font-size: 0.95rem;
  color: var(--text-muted);
}

/* ===== GLASS CARD ===== */
.card {
  background: linear-gradient(
    180deg,
    rgba(255,255,255,0.35),
    rgba(255,255,255,0.12)
  );
  border: 1px solid var(--glass-border);
  border-radius: 22px;
  padding: 16px;
  margin-bottom: 14px;
  backdrop-filter: blur(18px);
  -webkit-backdrop-filter: blur(18px);
  box-shadow: var(--glow-soft);
}

/* ===== HEADER ===== */
.header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 16px;
}

/* ===== BADGE / BUTTON ===== */
.badge,
button {
  font-family: inherit;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,0.55);
  background: linear-gradient(
    160deg,
    rgba(255,255,255,0.55),
    rgba(255,255,255,0.25)
  );
  color: #4a044e;
  padding: 10px 18px;
  font-size: 0.85rem;
  font-weight: 600;
  cursor: pointer;
  box-shadow: var(--glow-soft);
  transition: all 0.25s ease;
}

button:hover,
.badge:hover {
  transform: translateY(-1px) scale(1.02);
  box-shadow: var(--glow);
}


/* ===== ADMIN ACCENT ===== */
.admin {
  border-left: 4px solid var(--primary-gold);
}

  /* ===== BRAND TITLE ===== */
.brand-title {
  padding: 10px 22px;
  border-radius: 999px;
  font-weight: 800;
  font-size: 1.2rem;
  letter-spacing: 1px;
  color: #7c2d12;
  background: linear-gradient(90deg,#fff3c4,#ffd54f);
  border: 2px solid rgba(255,255,255,0.7);
  box-shadow: 0 0 30px rgba(255,215,79,0.6);
}

  /* ===== HAMBURGER ===== */
.hamburger {
  font-size: 1.6rem;
  cursor: pointer;
  padding: 8px 12px;
  border-radius: 12px;
  background: rgba(255,255,255,0.25);
  box-shadow: 0 0 15px rgba(255,255,255,0.3);
}

/* ===== SIDEBAR ===== */
.sidebar {
  position: fixed;
  top: 0;
  right: -280px;
  width: 260px;
  height: 100vh;
  background: linear-gradient(180deg,#ffb3d9,#d946ef);
  padding: 20px;
  z-index: 10000; /* ‚úÖ ‡∏™‡∏π‡∏á‡∏Å‡∏ß‡πà‡∏≤ modal */
  transition: right 0.3s ease;
}

.sidebar.show {
  right: 0;
}

.sidebar h3 {
  margin-top: 0;
}

.sidebar button {
  width: 100%;
  margin-bottom: 10px;
}

/* ===== PRODUCT CARD (FINAL SINGLE SOURCE) ===== */

.grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 14px;
  align-items: stretch;
}

.product-card {
  background: linear-gradient(
    180deg,
    rgba(255,255,255,0.22),
    rgba(255,255,255,0.08)
  );
  border: 1px solid var(--glass-border);
  border-radius: 22px;
  padding: 16px;

  backdrop-filter: blur(18px);
  -webkit-backdrop-filter: blur(18px);

  box-shadow:
    inset 0 0 0 1px rgba(255,255,255,0.25),
    var(--glow-soft);

  transition: transform .25s ease, box-shadow .25s ease;
}

.product-card:hover {
  transform: translateY(-2px);
  box-shadow: var(--glow);
}


.product-img {
  width: 100%;
  aspect-ratio: 1 / 1;
  border-radius: 14px;
  background-color: rgba(255,255,255,0.25);
  background-size: contain;
  background-repeat: no-repeat;
  background-position: center;
  margin-bottom: 6px;
}

.product-name {
  font-size: 1rem;
  font-weight: 700;
  line-height: 1.35;

  margin: 6px 0 4px;
  color: var(--text-main);
}

  .product-code {
  font-size: 0.65rem;
  font-weight: 600;

  color: var(--text-muted);
  background: transparent;

  padding: 0;
  margin: 2px auto 8px;

  box-shadow: none;
}

.product-category {
  display: inline-flex;
  align-items: center;
  justify-content: center;

  font-size: 0.65rem;
  font-weight: 800;
  letter-spacing: 0.4px;

  padding: 4px 10px;
  border-radius: 8px;

  background: linear-gradient(
    160deg,
    rgba(250,204,21,0.95),
    rgba(253,230,138,0.9)
  );
  color: var(--gold-deep);

  margin: 6px auto 2px;

  box-shadow:
    inset 0 0 0 1px rgba(255,255,255,0.6),
    0 0 18px rgba(250,204,21,0.45);
}

.product-price {
  font-size: 1.05rem;
  font-weight: 900;

  color: var(--gold);
  background: transparent;

  margin: 6px 0 4px;

  text-shadow: 0 0 12px rgba(250,204,21,0.6);
}

.product-meta {
  display: flex;
  justify-content: center;
  margin-top: 4px;
}

.meta-pill {
  font-size: 0.65rem;
  color: var(--text-muted);
  background: transparent;
  padding: 0;
}
/* ===== ADMIN PRODUCT IMAGE ===== */
.admin-product-img {
  width: 110px;
  border-radius: 16px;

  background-color: rgba(255,255,255,0.18);
  background-size: contain;
  background-repeat: no-repeat;
  background-position: center;

  border: 1px solid rgba(255,255,255,0.35);

  box-shadow:
    inset 0 0 0 1px rgba(255,255,255,0.25),
    0 0 22px rgba(255,255,255,0.25);

  backdrop-filter: blur(12px);
}
/* ===== ADMIN PRIMARY STOCK BUTTON ===== */
.admin-stock-btn {
  width: 100%;
  margin-bottom: 10px;

  background: linear-gradient(
    160deg,
    rgba(250,204,21,0.95),
    rgba(253,230,138,0.9)
  );
  color: #7c2d12;

  border: 1px solid rgba(255,255,255,0.65);
  border-radius: 999px;

  font-weight: 800;
  letter-spacing: 0.3px;

  box-shadow:
    inset 0 0 0 1px rgba(255,255,255,0.5),
    0 0 24px rgba(250,204,21,0.45);
}

.admin-stock-btn:hover {
  transform: translateY(-1px) scale(1.02);
  box-shadow: 0 0 36px rgba(250,204,21,0.6);
}

  /* ===== REAL SPINNER (BUTTON) ===== */
.spinner {
  width: 18px;
  height: 18px;
  border: 3px solid rgba(255,255,255,0.5);
  border-top-color: #7c2d12;
  border-radius: 50%;
  animation: spin 0.9s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.loading-btn {
  pointer-events: none;
  opacity: 0.8;
}

.loading-btn-content {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

  .spinner.in {
  border-top-color: #16a34a; /* ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß ‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ */
}

.spinner.out {
  border-top-color: #dc2626; /* ‡πÅ‡∏î‡∏á ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å */
}

  .product-card {
  position: relative;
}

/* ===== ORDER SLIP BUTTON (IN-CARD) ===== */
.order-fab {
  position: absolute;

  /* üëâ ‡∏¢‡πâ‡∏≤‡∏¢‡∏à‡∏≤‡∏Å‡∏°‡∏∏‡∏°‡∏ö‡∏ô ‚Üí ‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏•‡πà‡∏≤‡∏á */
  bottom: 18px;
  right: 18px;

  width: 56px;
  height: 56px;
  border-radius: 16px;

  background: linear-gradient(135deg,#fff7cc,#facc15);
  display: flex;
  align-items: center;
  justify-content: center;

  font-size: 26px;
  cursor: pointer;

  box-shadow:
    inset 0 0 0 1px rgba(255,255,255,0.7),
    0 0 28px rgba(250,204,21,0.65);

  transition: all .25s ease;
}

.order-fab:hover {
  transform: translateY(-2px) scale(1.05);
  box-shadow: 0 0 40px rgba(250,204,21,0.85);
}


</style>

    
    <style>
/* ===== PRODUCT DETAIL MODAL ===== */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  backdrop-filter: blur(6px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.modal-card {
  background: var(--glass);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
  width: 92%;
  max-width: 420px;
  padding: 16px;
  box-shadow: var(--glow);
}

.modal-img {
  width: 100%;
  aspect-ratio: 1 / 1;
  border-radius: 14px;
  background-size: contain;
  background-repeat: no-repeat;
  background-position: center;
  background-color: #020617;
  margin-bottom: 12px;
}

.modal-close {
  text-align: right;
  font-size: 0.8rem;
  color: var(--primary-gold);
  cursor: pointer;
}


</style>



  <!-- ========================= -->
  <!-- APP ROOT -->
  <!-- ========================= -->
  <div id="app"></div>

<!-- ========================= -->
<!-- GLOBAL STATE -->
<!-- ========================= -->
<script>
  let sessionExpiredHandled = false; // ‚úÖ ‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ

  const state = {
  mode: 'viewer',
  token: null,
  role: 'viewer',
  username: null,

  products: [],
  filteredProducts: [],
  pendingOrders: [], // ‚úÖ STEP 3 ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ

  search: '',
  category: 'all',

  loading: false,
  error: null,

  submitting: false,
  logs: []
};

  const SESSION_MAX_AGE = 24 * 60 * 60 * 1000;
  const SESSION_WARN_BEFORE = 5 * 60 * 1000;
  
  let sessionTimer = null;
  let pingTimer = null;
</script>

      
    <script>
function startSessionWatcher() {
  clearInterval(sessionTimer);

  sessionTimer = setInterval(() => {
    const loginTime = Number(localStorage.getItem('admin_login_time'));
    if (!loginTime) return;

    const now = Date.now();
    const age = now - loginTime;

    // ‚õî session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏
    if (age >= SESSION_MAX_AGE) {

  // üõë ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤ admin ‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
  if (state.mode !== 'admin') {
    clearInterval(sessionTimer);
    return;
  }

  if (!sessionExpiredHandled) {
    sessionExpiredHandled = true;
    alert('Session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ login ‡πÉ‡∏´‡∏°‡πà');
    logoutAdmin();
  }
  clearInterval(sessionTimer);
  return;
}

    // ‚ö†Ô∏è ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏
    if (SESSION_MAX_AGE - age <= SESSION_WARN_BEFORE) {
      console.warn('Session ‡∏à‡∏∞‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÉ‡∏ô‡πÑ‡∏°‡πà‡∏Å‡∏µ‡πà‡∏ô‡∏≤‡∏ó‡∏µ');
      // (‡∏ñ‡πâ‡∏≤‡∏à‡∏∞‡∏ó‡∏≥ popup ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô ‚Üí ‡∏ó‡∏≥‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ)
    }

  }, 60 * 1000); // ‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏∏‡∏Å 1 ‡∏ô‡∏≤‡∏ó‡∏µ
}      
</script>

<script>
  
    let pingRunning = false;

function startPingSession() {
  if (pingRunning) return;
  pingRunning = true;

  clearInterval(pingTimer);

  pingTimer = setInterval(async () => {
    if (state.mode !== 'admin' || !state.token) {
      clearInterval(pingTimer);
      pingRunning = false;
      return;
    }

    try {
      await apiPing();
    } catch (e) {
      if (!sessionExpiredHandled) {
        sessionExpiredHandled = true;
        alert('Session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ login ‡πÉ‡∏´‡∏°‡πà');
        logoutAdmin();
      }
    }
  }, 5 * 60 * 1000);
}

 </script>
  

  <!-- ========================= -->
<!-- API CONFIG -->
<!-- ========================= -->
<script>
  const API_URL = 'https://script.google.com/macros/s/AKfycby8s440W72bqx8khrsDZnCo0FQelouKbs8bdFoNfqDkUPfXwdshGg16K3sbJbxRKArf3A/exec';

  // ‚úÖ STEP 29.1 ‚Äî Client Signature
  const CLIENT_KEY = 'stockbuilder-v1';
</script>


  <!-- ========================= -->
<!-- STATE INIT -->
<!-- ========================= -->
<script>
  function initState() {
  const savedToken = localStorage.getItem('admin_token');
  const savedRole  = localStorage.getItem('admin_role');
  const savedUser  = localStorage.getItem('admin_username');
    const savedOrders = localStorage.getItem('pendingOrders');
if (savedOrders) {
  state.pendingOrders = JSON.parse(savedOrders);
}

  if (savedToken && savedRole && savedUser) {
    state.mode = 'admin';
    state.token = savedToken;
    state.role = savedRole;
    state.username = savedUser;

    startSessionWatcher(); // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
    startPingSession();   // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°
  } else {
    state.mode = 'viewer';
    state.token = null;
    state.role = 'viewer';
    state.username = null;
  }
}

  async function logoutAdmin() {
  if (state.token) {
    try {
      await apiLogout();
    } catch (e) {
      console.warn('Logout backend failed:', e.message);
    }
  }

  clearInterval(sessionTimer); // ‚úÖ ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç
  clearInterval(pingTimer); // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°  

  localStorage.removeItem('admin_token');
  localStorage.removeItem('admin_role');
  localStorage.removeItem('admin_username');
  localStorage.removeItem('admin_login_time');

  state.mode = 'viewer';
  state.token = null;
  state.role = 'viewer';
  state.username = null;

  sessionExpiredHandled = false;  
  renderUI();
}

</script>


<!-- ========================= -->
<!-- API FUNCTIONS -->
<!-- ========================= -->
<script>
  async function apiRequest(action, payload = {}) {
  try {
    const res = await fetch(API_URL, {
      method: 'POST',
      body: JSON.stringify({
        action,
        token: state.token,
        payload,
        clientKey: CLIENT_KEY
      })
    });

    const data = await res.json();
    if (!data.success) throw new Error(data.message);
    return data.data;

  } catch (err) {
    
    if (err.message.includes('Rate limit')) {
    alert(err.message);
    return null;
  }
    if (err.message === 'Unauthorized') {
      if (state.mode !== 'admin') return null;

      if (!sessionExpiredHandled) {
        sessionExpiredHandled = true;
        alert('Session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ login ‡πÉ‡∏´‡∏°‡πà');
        logoutAdmin();
      }
      return null;
    }

    state.error = err.message || 'Server error';
    return null;
  }
}
  /* ===== API WRAPPERS ===== */

  function apiListProducts() {
    return apiRequest('list');
  }

  function apiLogin(username, password) {
    return apiRequest('login', { username, password });
  }

  function apiAddProduct(product) {
    return apiRequest('add', product);
  }

  function apiUpdateProduct(product) {
    return apiRequest('update', product);
  }

  function apiUpdateStock(code, diff) {
    return apiRequest('updateStock', { code, diff });
  }

  function apiStockHistory(code) {
    return apiRequest('stockHistory', { code });
  }
  
  function apiDashboardSummary() {
    return apiRequest('dashboardSummary');
  }

  function apiListLogs(filters = {}) {
    return apiRequest('listLogs', filters);
  }

  function apiLogout() {
  return apiRequest('logout');
  }

  function apiForceLogout(username) {
  return apiRequest('forceLogout', { username });
  }

  function apiPing() {
  return apiRequest('ping');
  }



  function apiResetPassword(username, newPassword) {
  return apiRequest('resetPassword', {
    username,
    newPassword
  });
}

function apiChangePassword(oldPassword, newPassword) {
  return apiRequest('changePassword', {
    oldPassword,
    newPassword
  });
}

</script>
    
<script>
  /* ===== USER MANAGEMENT (STEP 4.1) ===== */

  /* =========================
   USER MANAGEMENT UI
========================= */

async function renderUserManagement() {
  if (state.role !== 'admin') return;

  const app = document.getElementById('app');
  app.innerHTML = `
    <div class="header">
      <h1>üë• User Management</h1>
      <button class="badge" onclick="renderUI()">Back</button>
    </div>
    <div id="user-list"></div>
  `;

  const users = await apiListUsers();
  if (!users) return;

  const list = document.getElementById('user-list');
  list.innerHTML = '';

  users.forEach(u => {
  const isSelf = u.username === state.username;
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <b>${u.username}</b><br/>
      <select
  ${isSelf ? 'disabled' : ''}
  onchange="changeUserRole('${u.username}', this.value)">
        ${['viewer','staff','admin']
          .map(r => `<option value="${r}" ${u.role===r?'selected':''}>${r}</option>`)
          .join('')}
          </select>

    <button
  style="margin-top:8px"
  onclick="openResetPassword('${u.username}')">
  üîë Reset Password
</button>

${u.username !== state.username ? `
<button
  style="margin-top:8px;background:#ef4444;color:white"
  onclick="confirmForceLogout('${u.username}')">
  üö™ Force Logout
</button>
` : ''}
  `;

    list.appendChild(card);
  });
}

async function changeUserRole(username, role) {
  const ok = confirm(`‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ${username} ‡πÄ‡∏õ‡πá‡∏ô ${role}?`);
  if (!ok) return;

  if (state.submitting) return;

  let res = null;
  try {
    state.submitting = true;
    res = await apiUpdateUserRole(username, role);
  } finally {
    state.submitting = false;
  }

  if (res) {
    alert('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
    renderUserManagement();
  }
}

  function apiListUsers() {
    return apiRequest('listUsers');
  }

  function apiUpdateUserRole(username, role) {
    return apiRequest('updateUserRole', { username, role });
  }

  function openResetPassword(username) {
  const app = document.getElementById('app');

  app.innerHTML = `
    <div class="header">
      <h1>üîë Reset Password</h1>
      <button class="badge" onclick="renderUserManagement()">Back</button>
    </div>

    <div class="card">
      <p>User: <b>${username}</b></p>

      <input
        id="new-pass"
        type="password"
        placeholder="New password (min 8 chars)"
        style="width:100%;padding:10px;margin-top:8px"
      />

      <button
        style="margin-top:12px;width:100%;padding:12px;background:#38bdf8"
        onclick="submitResetPassword('${username}')">
        Reset Password
      </button>
    </div>
  `;
}

  async function submitResetPassword(username) {
  const pass = document.getElementById('new-pass').value;

  if (!pass || pass.length < 8) {
    alert('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 8 ‡∏ï‡∏±‡∏ß');
    return;
  }

  const ok = confirm(`‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á ${username}?`);
  if (!ok) return;

  const res = await apiResetPassword(username, pass);

  if (res) {
    alert('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
    renderUserManagement();
  }
}

  async function confirmForceLogout(username) {
  const ok = confirm(`‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö logout ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ${username}?`);
  if (!ok) return;

  const res = await apiForceLogout(username);

  if (res) {
    alert(`‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ${username} ‡∏ñ‡∏π‡∏Å logout ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`);
    renderUserManagement();
  }
}


</script>

    <!-- ===== IMAGE UPLOAD ===== -->
<script>
  async function apiUploadImage(file) {
  try {
    const base64 = await fileToBase64(file);

    const res = await fetch(API_URL, {
      method: 'POST',
      body: JSON.stringify({
        action: 'upload',
        token: state.token,
        clientKey: CLIENT_KEY,
        payload: {
          filename: file.name,
          mimeType: file.type,
          data: base64
        }
      })
    });

    const json = await res.json();
    if (!json.success) throw new Error(json.message);

    return json.data.url;

  } catch (e) {
    alert(e.message || '‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    return null;
  }
}

  function fileToBase64(file) {
    return new Promise(res => {
      const reader = new FileReader();
      reader.onload = () => res(reader.result.split(',')[1]);
      reader.readAsDataURL(file);
    });
  }
</script>

    <!-- ===== PRODUCTION HELPERS ===== -->
<script>
  function validateProduct(p) {
    if (!p.code) return '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
    if (!p.name || !p.name.trim()) return '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
    if (isNaN(p.price) || p.price < 0) return '‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ú‡∏¥‡∏î';
    if (isNaN(p.stock)) return '‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏ú‡∏¥‡∏î';
    if (!p.category) return '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏°‡∏ß‡∏î';
    return null;
  }

</script>

    
   <script>
/* =========================
   SAFE DOM VALUE HELPER
   (SPA / Prevent null crash)
========================= */
const getVal = (id) => {
  const el = document.getElementById(id);
  return el ? el.value : '';
};
</script>

<!-- ========================= -->
<!-- RENDER FUNCTIONS -->
<!-- ========================= -->
    <script>
function showToast(text, type = 'success') {
  const div = document.createElement('div');
  div.textContent = text;

  div.style = `
    position:fixed;
    bottom:24px;
    left:50%;
    transform:translateX(-50%);
    padding:14px 22px;
    border-radius:999px;
    background:${type === 'success'
      ? 'linear-gradient(90deg,#fde68a,#facc15)'
      : '#ef4444'};
    color:#4a044e;
    font-weight:700;
    box-shadow:0 0 30px rgba(250,204,21,.5);
    z-index:9999;
  `;

  document.body.appendChild(div);
  setTimeout(() => div.remove(), 2200);
}
</script>

  <script>
function showConfirm({ title, message, onConfirm }) {
  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay';

  const card = document.createElement('div');
  card.className = 'modal-card';

  card.innerHTML = `
    <h3>${title}</h3>
    <p style="margin:10px 0">${message}</p>

    <div style="display:flex;gap:10px">
      <button class="admin-stock-btn" id="confirmBtn">
        <span class="loading-btn-content">
          <span class="btn-text">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</span>
        </span>
      </button>
      <button class="badge" id="cancelBtn">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>
  `;

  const confirmBtn = card.querySelector('#confirmBtn');
  const cancelBtn = card.querySelector('#cancelBtn');
  const textSpan = card.querySelector('.btn-text');

  confirmBtn.onclick = async () => {
  confirmBtn.classList.add('loading-btn');
  cancelBtn.disabled = true;

  textSpan.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';

  const spinner = document.createElement('div');
  spinner.className =
    'spinner ' + (message.includes('‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤') ? 'in' : 'out');

  textSpan.before(spinner);

  await onConfirm();
  overlay.remove();
};


  cancelBtn.onclick = () => overlay.remove();

  overlay.appendChild(card);
  document.body.appendChild(overlay);
}
</script>

<script>
function openOrderSlip(p) {
  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  overlay.onclick = () => overlay.remove();

  const card = document.createElement('div');
  card.className = 'modal-card';
  card.onclick = e => e.stopPropagation();

  card.innerHTML = `
  <h3 style="margin-bottom:12px">üßæ ‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h3>

  <div class="modal-img"
    style="background-image:url('${p.image || ''}')">
  </div>

  <p><b>${p.name}</b></p>
  <p style="font-size:0.8rem;color:#94a3b8">
    ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: ${p.code}
  </p>

  <input
    id="order-by"
    placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡∏±‡πà‡∏á / ‡∏£‡πâ‡∏≤‡∏ô / ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤"
    style="width:100%;padding:12px;margin:10px 0;border-radius:12px;border:none;"
  />

  <input
    id="order-note"
    placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)"
    style="width:100%;padding:12px;margin-bottom:10px;border-radius:12px;border:none;"
  />

  <input
    id="order-qty"
    type="number"
    min="1"
    placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á"
    style="width:100%;padding:12px;margin-bottom:12px;border-radius:12px;border:none;"
  />

  <button
    class="admin-stock-btn"
    style="width:100%"
    onclick="createOrderSlip(${JSON.stringify(p).replace(/"/g,'&quot;')})">
    üìÑ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
  </button>
`;

  overlay.appendChild(card);
  document.body.appendChild(overlay);
}

function createOrderSlip(p) {
  const qty = Number(document.getElementById('order-qty').value);
  const by = document.getElementById('order-by').value.trim();
  const note = document.getElementById('order-note').value.trim();

  if (!by) {
    showToast('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡∏±‡πà‡∏á', 'error');
    return;
  }

  if (!qty || qty <= 0) {
    showToast('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô', 'error');
    return;
  }

  if (qty > p.stock) {
    showToast('‚ùå ‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏û‡∏≠', 'error');
    return;
  }

  const order = {
    id: 'ORD-' + Date.now(),
    code: p.code,
    name: p.name,
    qty,
    image: p.image || '',
    orderedBy: by,
    note,
    createdAt: Date.now()
  };

  state.pendingOrders.push(order);
  localStorage.setItem('pendingOrders', JSON.stringify(state.pendingOrders));

  document.querySelector('.modal-overlay')?.remove();
  showToast('üïì ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô');
}


/* ===== Helper: Rounded Rect ===== */
function roundRect(ctx, x, y, w, h, r, fill, stroke) {
  ctx.beginPath();
  ctx.moveTo(x + r, y);
  ctx.lineTo(x + w - r, y);
  ctx.quadraticCurveTo(x + w, y, x + w, y + r);
  ctx.lineTo(x + w, y + h - r);
  ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
  ctx.lineTo(x + r, y + h);
  ctx.quadraticCurveTo(x, y + h, x, y + h - r);
  ctx.lineTo(x, y + r);
  ctx.quadraticCurveTo(x, y, x + r, y);
  ctx.closePath();
  if (fill) ctx.fill();
  if (stroke) ctx.stroke();
}
</script>


<script>
function openStockAdjustModal(code) {
  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  overlay.onclick = () => overlay.remove();

  const card = document.createElement('div');
  card.className = 'modal-card';
  card.onclick = e => e.stopPropagation();

  card.innerHTML = `
    <h3>üì¶ ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å (${code})</h3>

    <select id="stock-type" style="width:100%;padding:10px;margin-top:8px">
      <option value="in">üì• ‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤</option>
      <option value="out">üì§ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å</option>
    </select>

    <input
      id="stock-qty"
      type="number"
      min="1"
      placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô"
      style="width:100%;padding:10px;margin-top:8px"
    />

   <button
  class="admin-stock-btn"
  style="margin-top:12px;width:100%"
  onclick="submitStockAdjust('${code}')">
  ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
</button>
  `;

  overlay.appendChild(card);
  document.body.appendChild(overlay);
}

async function submitStockAdjust(code) {
  const type = document.getElementById('stock-type').value;
  const qty = Number(document.getElementById('stock-qty').value);

  if (!qty || qty <= 0) {
    showToast('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
    return;
  }

  const diff = type === 'in' ? qty : -qty;
  document.querySelector('.modal-overlay')?.remove();
  
  showConfirm({
    title: 'üì¶ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å',
    message: `
      <div style="text-align:center">
        <b>${type === 'in' ? '‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤' : '‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å'}</b><br/>
        ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô <b>${qty}</b> ‡∏ä‡∏¥‡πâ‡∏ô
      </div>
    `,
    onConfirm: async () => {
      await adjustStock(code, diff);
    }
  });
}
</script>

    
    <script>
/* =========================
   SEARCH FIX (NO FULL RERENDER)
========================= */

let searchTimer = null;

function onSearch(value) {
  state.search = value;

  clearTimeout(searchTimer);
  searchTimer = setTimeout(() => {
    applyFilter();
    renderProductGridOnly(); // ‚úÖ render ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ grid
  }, 150);
}

function renderProductGridOnly() {
  const oldGrid = document.querySelector('.grid');
  if (!oldGrid) return;

  const newGrid = renderProductGrid();
  oldGrid.replaceWith(newGrid);
}
</script>
    
<script>
    function toggleSidebar() {
  document.getElementById('sidebar')
    .classList.toggle('show');
}
</script>
    
<script>
function openProductDetail(p) {
  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  overlay.onclick = () => overlay.remove();

  const card = document.createElement('div');
  card.className = 'modal-card';
  card.onclick = e => e.stopPropagation(); // ‡∏Å‡∏±‡∏ô‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏∞‡∏•‡∏∏

  card.innerHTML = `
    <div class="modal-close" onclick="this.closest('.modal-overlay').remove()">
      ‚úï ‡∏õ‡∏¥‡∏î
    </div>

    <div class="modal-img"
      style="background-image:url('${p.image || ''}')">
    </div>

    <h3 style="margin:4px 0">${p.name}</h3>

    <div class="product-price">‡∏ø${p.price}</div>

    <p>üì¶ ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: <b>${p.stock}</b></p>
    <p>üè∑Ô∏è ‡∏´‡∏°‡∏ß‡∏î: ${p.category}</p>
    <p>üöö ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${p.status || '-'}</p>

    <p style="font-size:0.75rem;color:#94a3b8">
      ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:
      ${p.updatedAt
        ? new Date(p.updatedAt).toLocaleString('th-TH')
        : '-'}
    </p>
  `;

  overlay.appendChild(card);
  document.body.appendChild(overlay);
}
</script>

    
<script>
  /* =========================
     VIEWER SUPPORT
  ========================= */
async function adjustStock(code, diff) {
  if (state.submitting) return;
  state.submitting = true;

  try {
    const res = await apiUpdateStock(code, diff);
    if (!res) throw new Error();

    const p = state.products.find(p => p.code === code);
    if (p) {
      p.stock += diff;
      p.updatedAt = Date.now(); // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
    }

    showToast('üì¶ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß');
  } catch {
    showToast('‚ùå ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
  } finally {
    state.submitting = false;
    renderUI();
  }
}
  
  async function loadProducts() {
  state.loading = true;
  renderUI();

  const data = await apiListProducts();
  if (data) {
    state.products = data;
    applyFilter();
  }

  state.loading = false;
  renderUI();
}


  function applyFilter() {
    state.filteredProducts = state.products.filter(p => {
      const keyword = state.search.toLowerCase();

const matchSearch =
  p.name.toLowerCase().includes(keyword) ||
  p.code.toLowerCase().includes(keyword);

      const matchCategory =
  state.category === 'all' ||
  p.category.toLowerCase() === state.category.toLowerCase();
      return matchSearch && matchCategory;
    });
  }

 
  function onFilterCategory(value) {
    state.category = value;
    applyFilter();
    renderUI();
  }

  function renderCategoryOptions() {
    const categories = [
  ...new Set(state.products.map(p => p.category.toLowerCase()))
];
    return categories.map(c => `<option value="${c}">${c}</option>`).join('');
  }

/* =========================
   DASHBOARD (STEP 15)
========================= */

async function renderDashboard() {

  // üîê ROLE GUARD ‚Äî ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
  if (state.role !== 'admin') {
    alert('‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠');
    return;
  }

  const app = document.getElementById('app');
  app.innerHTML = '';

  const header = document.createElement('div');
  header.className = 'header';
  header.innerHTML = `
    <h1>üìä Dashboard</h1>
    <button class="badge" onclick="renderUI()">Back</button>
  `;
  app.appendChild(header);

  const card = document.createElement('div');
  card.className = 'card';
  card.innerHTML = `<p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>`;
  app.appendChild(card);

  const data = await apiDashboardSummary();
  if (!data) return;

  card.innerHTML = `
    <p>üì¶ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: <b>${data.totalProducts}</b></p>
    <p>üìä ‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏£‡∏ß‡∏°: <b>${data.totalStock}</b></p>
    <p>‚ö†Ô∏è ‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î: <b>${data.lowStock}</b></p>
    <p>üí∞ ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡∏ï‡πä‡∏≠‡∏Å: <b>‡∏ø${data.stockValue}</b></p>
  `;

  drawDashboardChart(data.history || []);
}

function drawDashboardChart(history) {
  if (!history.length) return;

  const canvas = document.createElement('canvas');
  canvas.width = 300;
  canvas.height = 200;

  const card = document.createElement('div');
  card.className = 'card';
  card.appendChild(canvas);
  document.getElementById('app').appendChild(card);

  const ctx = canvas.getContext('2d');
  const padding = 30;

  const max = Math.max(...history.map(h => h.totalStock));
  const min = Math.min(...history.map(h => h.totalStock));
  const xStep = (canvas.width - padding * 2) / (history.length - 1 || 1);
  const yScale = (canvas.height - padding * 2) / (max - min || 1);

  ctx.strokeStyle = '#38bdf8';
  ctx.lineWidth = 2;
  ctx.beginPath();

  history.forEach((p, i) => {
    const x = padding + i * xStep;
    const y = canvas.height - padding - (p.totalStock - min) * yScale;
    if (i === 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  });

  ctx.stroke();
}  
  /* =========================
     ADMIN LOGIN
  ========================= */

  function renderAdminLogin() {
    const app = document.getElementById('app');
    app.innerHTML = '';

    const header = document.createElement('div');
    header.className = 'header';
    header.innerHTML = `
      <h1>üîê Admin Login</h1>
      <button class="badge" onclick="renderUI()">Back</button>
    `;

    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <input id="login-user" placeholder="Username"
        style="width:100%;padding:10px;margin-bottom:8px;" />
      <input id="login-pass" type="password" placeholder="Password"
        style="width:100%;padding:10px;margin-bottom:8px;" />
      <button onclick="submitLogin()"
        style="width:100%;padding:12px;background:#38bdf8;">
        Login
      </button>
    `;

    app.appendChild(header);
    app.appendChild(card);
  }

  async function submitLogin() {
  const u = document.getElementById('login-user').value;
  const p = document.getElementById('login-pass').value;

  const data = await apiLogin(u, p);
  if (!data) return;

  const now = Date.now();

  localStorage.setItem('admin_token', data.token);
  localStorage.setItem('admin_role', data.role);
  localStorage.setItem('admin_username', u.toLowerCase());
  localStorage.setItem('admin_login_time', now); // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°

  state.token = data.token;
  state.role = data.role;
  state.username = u.toLowerCase();
  state.mode = 'admin';
    
  sessionExpiredHandled = false; // ‚úÖ reset flag
  startSessionWatcher(); // ‚úÖ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤
  startPingSession();      // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ  
  renderUI();
}


   function renderChangePassword() {
  const app = document.getElementById('app');
  app.innerHTML = `
    <div class="header">
      <h1>üîë ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</h1>
      <button class="badge" onclick="renderUI()">Back</button>
    </div>

    <div class="card">
      <input
        id="old-pass"
        type="password"
        placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏î‡∏¥‡∏°"
        style="width:100%;padding:10px;margin-bottom:8px;"
      />

      <input
        id="new-pass"
        type="password"
        placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 8 ‡∏ï‡∏±‡∏ß)"
        style="width:100%;padding:10px;margin-bottom:8px;"
      />

      <button
        style="width:100%;padding:12px;background:#38bdf8;"
        onclick="submitChangePassword()">
        ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
      </button>
    </div>
  `;
}

  async function submitChangePassword() {
  const oldPass = document.getElementById('old-pass').value;
  const newPass = document.getElementById('new-pass').value;

  if (!oldPass || !newPass) {
    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');
    return;
  }

  if (newPass.length < 8) {
    alert('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 8 ‡∏ï‡∏±‡∏ß');
    return;
  }

  const ok = confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô?');
  if (!ok) return;

  const res = await apiChangePassword(oldPass, newPass);

  if (res) {
    alert('‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ login ‡πÉ‡∏´‡∏°‡πà');
    logoutAdmin(); // üîê backend clear token ‡πÅ‡∏•‡πâ‡∏ß ‚Üí logout ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    sessionExpiredHandled = false; // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°
    
  }
}

  /* =========================
     MAIN RENDER
  ========================= */

  function renderUI() {
    const app = document.getElementById('app');
    app.innerHTML = '';

    if (state.mode === 'viewer') renderViewer(app);
    if (state.mode === 'admin') renderAdmin(app);

    if (state.loading || state.submitting) {
      renderOverlay(app);
    }
  }

  /* =========================
     VIEWER
  ========================= */

  async function renderViewer(root) {
    const header = document.createElement('div');
header.className = 'header';
header.innerHTML = `
  <div class="brand-title">
    ‚≠ê ‡∏•‡πâ‡∏≠‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå ‚≠ê
  </div>
  <button class="badge" onclick="renderAdminLogin()">Admin</button>
`;
root.appendChild(header);


    if (state.loading) return root.appendChild(renderLoading());
    if (state.error) return root.appendChild(renderError());

    if (state.products.length === 0) {
      await loadProducts();
      return;
    }
 

    const searchCard = document.createElement('div');
    searchCard.className = 'card';
    searchCard.innerHTML = `
      <input placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤..."
        value="${state.search}"
        oninput="onSearch(this.value)"
        style="width:100%;padding:10px;border-radius:12px;border:none;" />
      <select onchange="onFilterCategory(this.value)"
        style="width:100%;margin-top:10px;padding:10px;border-radius:12px;border:none;">
        <option value="all">‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏ß‡∏î</option>
        ${renderCategoryOptions()}
      </select>
    `;
    root.appendChild(searchCard);
    root.appendChild(renderProductGrid());
  }

  /* =========================
   CATEGORY ‚Üí COLOR CLASS
========================= */
function getCategoryClass(category = '') {
  const c = category.toLowerCase();

  if (c.includes('‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤')) return 'code-bag';
  if (c.includes('‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏î‡∏±‡∏ö')) return 'code-jewelry';
  if (c.includes('‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ')) return 'code-utility';
  if (c.includes('‡∏ï‡∏∏‡πä‡∏Å‡∏ï‡∏≤') || c.includes('‡∏ü‡∏¥‡∏Å')) return 'code-doll';

  return 'code-other';
}
  function renderProductGrid() {
  const grid = document.createElement('div');
  grid.className = 'grid';

  state.filteredProducts.forEach(p => {
    const card = document.createElement('div');
    card.className = 'product-card';
    card.onclick = () => openProductDetail(p);

    // ‚úÖ ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì class ‡∏™‡∏µ‡∏´‡∏°‡∏ß‡∏î
    const cls = getCategoryClass(p.category);

    card.innerHTML = `
      <div class="product-img"
        style="background-image:url('${p.image || ''}');">
      </div>

      <div class="product-name">${p.name}</div>

      <div class="product-code ${cls}">
        üÜî ${p.code}
      </div>

      <div class="product-category ${cls}">
        üè∑Ô∏è ${p.category}
      </div>

      <div class="product-price">‡∏ø${p.price}</div>

      <div class="product-meta">
        <div class="meta-pill meta-stock">
          üì¶ ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${p.stock}
        </div>
        <div class="meta-pill meta-status">
          üöö ${p.status || '-'}
        </div>
      </div>

      <!-- üßæ ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÄ‡∏´‡πá‡∏ô) -->
      <div
        class="order-fab"
        onclick="event.stopPropagation(); openOrderSlip(${JSON.stringify(p).replace(/"/g,'&quot;')})">
        üßæ
      </div>
    `;

    grid.appendChild(card);
  });

  return grid;
}

  /* =========================
     ADMIN DASHBOARD
  ========================= */

  async function renderAdmin(root) {
  // ===== HEADER =====
  const header = document.createElement('div');
header.className = 'header';
header.innerHTML = `
  <h1>üßë‚Äçüíº Admin</h1>
  <div class="hamburger" onclick="toggleSidebar()">‚ò∞</div>
`;
root.appendChild(header);

/* ===== PRIMARY ACTIONS ===== */
const main = document.createElement('div');
main.className = 'card';
main.innerHTML = `
  <button style="width:100%;margin-bottom:12px"
    onclick="openProductForm()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</button>

  <button style="width:100%"
    onclick="exportCSV()">üì§ Export CSV</button>
`;root.appendChild(main);

// ‚úÖ STEP 3: ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
renderPendingOrders(root);

// ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
if (state.products.length === 0 && !state.loading) {
  state.loading = true;
  renderUI();

  const data = await apiListProducts();
  if (data) {
    state.products = data;
    applyFilter();
  }

  state.loading = false;
  renderUI();
  return;
}


  state.products.forEach(p => {
  const card = document.createElement('div');
  card.className = 'card admin';

  card.innerHTML = `
    <div style="display:flex; gap:18px; align-items:stretch;">
      
      <!-- LEFT: INFO -->
      <div style="flex:1;">
        <b>${p.name}</b> (${p.code})<br/>
        ‡∏™‡∏ï‡πä‡∏≠‡∏Å: <b>${p.stock}</b><br/>
        ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${p.status}<br/><br/>

        <button
  class="admin-stock-btn"
  onclick="openStockAdjustModal('${p.code}')">
  üì¶ ‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ / ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
</button>

        ${state.role === 'admin'
          ? `<button onclick="showStockHistory('${p.code}')">üìä History</button>
             <button onclick="openProductForm(${JSON.stringify(p).replace(/"/g,'&quot;')})">‚úèÔ∏è</button>`
          : ''}
      </div>

     <!-- RIGHT: IMAGE -->
<div class="admin-product-img"
  style="background-image:url('${p.image || ''}')">
</div>

    </div>
  `;

  root.appendChild(card);
});

    }

  function renderPendingOrders(root) {
  if (!state.pendingOrders.length) return;

  const box = document.createElement('div');
  box.className = 'card';
  box.innerHTML = `<h3>üïì ‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</h3>`;

  state.pendingOrders.forEach(o => {
    const item = document.createElement('div');
    item.style.marginBottom = '14px';

    item.innerHTML = `
      <div style="display:flex;gap:12px;align-items:center">
        <div style="
          width:64px;
          height:64px;
          background:url('${o.image || ''}') center/contain no-repeat;
          background-color:rgba(255,255,255,.2);
          border-radius:12px">
        </div>

        <div style="flex:1;font-size:.85rem">
          <b>${o.name}</b><br/>
          ‡∏£‡∏´‡∏±‡∏™: ${o.code}<br/>
          ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: <b>${o.qty}</b><br/>
          üë§ ‡∏ú‡∏π‡πâ‡∏™‡∏±‡πà‡∏á: <b>${o.orderedBy}</b><br/>
          ${o.note ? `üìù ${o.note}<br/>` : ''}
          üïí ${new Date(o.createdAt).toLocaleString('th-TH')}
        </div>
      </div>

      <div style="display:flex;gap:8px;margin-top:8px">
        <button
          class="admin-stock-btn"
          onclick="approveOrder('${o.id}')">
          ‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏´‡∏±‡∏Å‡∏™‡∏ï‡πä‡∏≠‡∏Å
        </button>

        <button
          style="background:#ef4444;color:white"
          onclick="rejectOrder('${o.id}')">
          ‚ùå ‡∏•‡∏ö‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á
        </button>
      </div>
    `;

    box.appendChild(item);
  });

  root.appendChild(box);
}
 async function approveOrder(orderId) {
  const order = state.pendingOrders.find(o => o.id === orderId);
  if (!order) return;

  const product = state.products.find(p => p.code === order.code);
  if (!product || product.stock < order.qty) {
    showToast('‚ùå ‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠', 'error');
    return;
  }

  showConfirm({
    title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏´‡∏±‡∏Å‡∏™‡∏ï‡πä‡∏≠‡∏Å',
    message: `
      <div style="text-align:center">
        ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ <b>${order.name}</b><br/>
        ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô <b>${order.qty}</b> ‡∏ä‡∏¥‡πâ‡∏ô
      </div>
    `,
    onConfirm: async () => {
      try {
        await apiUpdateStock(order.code, -order.qty);

        product.stock -= order.qty;
        product.updatedAt = Date.now();

        state.pendingOrders =
          state.pendingOrders.filter(o => o.id !== orderId);

        localStorage.setItem(
          'pendingOrders',
          JSON.stringify(state.pendingOrders)
        );

        showToast('‚úÖ ‡∏´‡∏±‡∏Å‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
        renderUI();
      } catch {
        showToast('‚ùå ‡∏´‡∏±‡∏Å‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
      }
    }
  });
}

function rejectOrder(orderId) {
  const ok = confirm('‡∏•‡∏ö‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ô‡∏µ‡πâ?');
  if (!ok) return;

  state.pendingOrders =
    state.pendingOrders.filter(o => o.id !== orderId);

  localStorage.setItem(
    'pendingOrders',
    JSON.stringify(state.pendingOrders)
  );

  showToast('üóëÔ∏è ‡∏•‡∏ö‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏•‡πâ‡∏ß');
  renderUI();
}

  /* =========================
     PRODUCT FORM
  ========================= */

  function openProductForm(product = null) {
    const app = document.getElementById('app');
    app.innerHTML = '';

    const isEdit = !!product;

    const header = document.createElement('div');
    header.className = 'header';
    header.innerHTML = `
      <h1>${isEdit ? '‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' : '‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'}</h1>
      <button class="badge" onclick="renderUI()">Back</button>
    `;

    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <input id="p-code" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤"
        value="${product?.code || ''}" ${isEdit ? 'disabled' : ''} />
      <input id="p-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" value="${product?.name || ''}" />
      <input id="p-price" type="number" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤" value="${product?.price || ''}" />
      <input id="p-stock" type="number" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô" value="${product?.stock || 0}" />
      <input id="p-category" placeholder="‡∏´‡∏°‡∏ß‡∏î" value="${product?.category || ''}" />

      <select id="p-status">
        ${['‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á','‡∏´‡∏°‡∏î','‡πÇ‡∏Å‡∏î‡∏±‡∏á‡πÑ‡∏ó‡∏¢','‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á']
          .map(s => `<option ${product?.status===s?'selected':''}>${s}</option>`).join('')}
      </select>

      <input id="p-image" type="file" accept="image/*" />
      ${product?.image ? `<img src="${product.image}" style="width:100%;border-radius:12px;margin-top:8px;" />` : ''}

      <button
  ${state.submitting ? 'disabled' : ''}
  style="margin-top:12px;width:100%;padding:12px;background:#38bdf8;"
  onclick="submitProduct(${isEdit})"
>
  ${isEdit ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'}
</button>

    `;
    app.appendChild(header);
    app.appendChild(card);
  }

async function submitProduct(isEdit = false) {
  if (state.submitting) return;
  state.submitting = true;

  try {
    const code = getVal('p-code');

    const product = {
      code,
      name: getVal('p-name'),
      price: Number(getVal('p-price')),
      stock: Number(getVal('p-stock')),
      category: getVal('p-category'),
      status: getVal('p-status'),
      image: ''
    };

    const err = validateProduct(product);
    if (err) {
      alert(err);
      return;
    }

    // ===== IMAGE =====
    const fileInput = document.getElementById('p-image');
    const file = fileInput?.files?.[0] || null;

    if (file) {
      const imageUrl = await apiUploadImage(file);
      if (!imageUrl) throw new Error('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      product.image = imageUrl;
    } else if (isEdit) {
      product.image =
        state.products.find(p => p.code === code)?.image || '';
    }

    // ===== SAVE =====
    if (isEdit) {
      await apiUpdateProduct(product);

      const idx = state.products.findIndex(p => p.code === code);
      if (idx !== -1) {
        state.products[idx] = { ...state.products[idx], ...product };
      }
    } else {
      const saved = await apiAddProduct(product);
      if (saved && saved.code) {
        state.products.push(saved);
        applyFilter();
      } else {
        await loadProducts();
      }
    }

  } catch (e) {
    console.error(e);
    alert(e.message || '‡πÄ‡∏û‡∏¥‡πà‡∏° / ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
  } finally {
    state.submitting = false;
    renderUI();
  }
}


   
   /* =========================
     COMMON
  ========================= */

  function renderLoading() {
    const div = document.createElement('div');
    div.className = 'card';
    div.innerHTML = `<p>‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>`;
    return div;
  }

  function renderError() {
  if (!state.error) return document.createElement('div');

  const msg = state.error;
  state.error = null;

  const div = document.createElement('div');
  div.className = 'card';
  div.innerHTML = `<p>‚ùå ${msg}</p>`;
  return div;
}

    function renderOverlay(root) {
    const overlay = document.createElement('div');
    overlay.style = `
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.5);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:9999;
    `;
    overlay.innerHTML = `
      <div class="card">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</div>
    `;
    root.appendChild(overlay);
  }

  function exportCSV() {
  if (!state.products.length) {
    alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤');
    return;
  }

  const headers = [
    'code','name','price','stock','category','status','image'
  ];

  const rows = state.products.map(p =>
    headers.map(h =>
      `"${(p[h] ?? '').toString().replace(/"/g,'""')}"`
    ).join(',')
  );

  const csv = [headers.join(','), ...rows].join('\n');

  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);

  const a = document.createElement('a');
  a.href = url;
  a.download = `stock_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();

  URL.revokeObjectURL(url);
}

  async function showStockHistory(code) {
    const app = document.getElementById('app');
    app.innerHTML = '';

    const header = document.createElement('div');
    header.className = 'header';
    header.innerHTML = `
      <h1>üìä Stock History (${code})</h1>
      <button class="badge" onclick="renderUI()">Back</button>
    `;

    app.appendChild(header);

    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <canvas id="historyChart" width="300" height="200"></canvas>
    `;
    app.appendChild(card);

    const data = await apiStockHistory(code);
    if (!data || !data.length) {
      card.innerHTML += `<p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</p>`;
      return;
    }

    drawStockChart(data);
  }

  async function renderAuditLogs() {
  if (state.role !== 'admin') return;

  const app = document.getElementById('app');
  app.innerHTML = '';

  app.innerHTML = `
    <div class="header">
      <h1>üßæ Audit Logs</h1>
      <button class="badge" onclick="renderUI()">Back</button>
    </div>

    <div class="card">
      <input id="log-user" placeholder="username" />
      <input id="log-action" placeholder="action" />
      <input id="log-keyword" placeholder="keyword" />

      <input id="log-from" type="date" />
      <input id="log-to" type="date" />

      <button onclick="loadLogs()">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
    </div>

    <div id="log-list"></div>
  `;

  loadLogs();
}

async function loadLogs() {
  const filters = {
    username: document.getElementById('log-user')?.value,
    action: document.getElementById('log-action')?.value,
    keyword: document.getElementById('log-keyword')?.value,
    dateFrom: document.getElementById('log-from')?.value,
    dateTo: document.getElementById('log-to')?.value
  };

  const logs = await apiListLogs(filters);
  if (!logs) return;

  const list = document.getElementById('log-list');
  list.innerHTML = '';

  logs.forEach(l => {
    const div = document.createElement('div');
    div.className = 'card';
    div.innerHTML = `
      <b>${l.action}</b> ‚Äî ${l.target || ''}<br/>
      üë§ ${l.user} (${l.role})<br/>
      üïí ${new Date(l.time).toLocaleString()}<br/>
      <small>${l.detail || ''}</small>
    `;
    list.appendChild(div);
  });
}

  function drawStockChart(data) {
    const canvas = document.getElementById('historyChart');
    const ctx = canvas.getContext('2d');

    ctx.clearRect(0, 0, canvas.width, canvas.height);

    const padding = 30;
    const maxStock = Math.max(...data.map(d => d.stock));
    const minStock = Math.min(...data.map(d => d.stock));

    const xStep = (canvas.width - padding * 2) / (data.length - 1 || 1);
    const yScale = (canvas.height - padding * 2) / (maxStock - minStock || 1);

    ctx.strokeStyle = '#38bdf8';
    ctx.lineWidth = 2;
    ctx.beginPath();

    data.forEach((point, i) => {
      const x = padding + i * xStep;
      const y = canvas.height - padding - (point.stock - minStock) * yScale;

      if (i === 0) ctx.moveTo(x, y);
      else ctx.lineTo(x, y);
    });

    ctx.stroke();

    ctx.fillStyle = '#38bdf8';
    data.forEach((point, i) => {
      const x = padding + i * xStep;
      const y = canvas.height - padding - (point.stock - minStock) * yScale;
      ctx.beginPath();
      ctx.arc(x, y, 3, 0, Math.PI * 2);
      ctx.fill();
    });
  }
  
</script>
<!-- ========================= -->
<!-- APP START -->
<!-- ========================= -->
<script>
  initState();
  renderUI();
</script>

    <!-- ========================= -->
<!-- ADMIN SIDEBAR -->
<!-- ========================= -->
<div id="sidebar" class="sidebar">
  <h3>üßë‚Äçüíº Admin Menu</h3>

  <button onclick="toggleSidebar(); renderDashboard();">
    üìä Dashboard Overview
  </button>

  <button onclick="toggleSidebar(); renderAuditLogs();">
    üßæ Audit Logs
  </button>

  <button onclick="toggleSidebar(); renderUserManagement();">
    üë• User Management
  </button>

  <button onclick="toggleSidebar(); renderChangePassword();">
    üîë ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
  </button>

  <button
    style="background:#ef4444;color:white"
    onclick="toggleSidebar(); logoutAdmin();">
    üö™ Logout
  </button>
</div>

</body>
</html>
