<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>StockBuilder</title>
  <link rel="icon" href="data:,">  
</head>
  <body>
  <!-- ========================= -->
<!-- UI STYLE (STEP 2) -->
<!-- ========================= -->
<style>
  :root {
    --bg: #0b1020;
    --glass: rgba(255,255,255,0.08);
    --glass-border: rgba(255,255,255,0.18);
    --glow: 0 0 30px rgba(56,189,248,0.25);
    --primary: #38bdf8;
    --text-muted: #94a3b8;
  }

  * {
    box-sizing: border-box;
  }

  body {
    margin: 0;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    background: radial-gradient(circle at top, #0f172a, var(--bg));
    color: #fff;
    min-height: 100vh;
  }

  #app {
    padding: 16px;
    max-width: 480px;
    margin: 0 auto;
  }

  h1 {
    font-size: 1.4rem;
    margin: 0 0 12px;
  }

  p {
    margin: 0;
    color: var(--text-muted);
    font-size: 0.9rem;
  }

  /* ===== Glass Card ===== */
  .card {
    background: var(--glass);
    border: 1px solid var(--glass-border);
    border-radius: 18px;
    padding: 16px;
    margin-bottom: 14px;
    backdrop-filter: blur(14px);
    -webkit-backdrop-filter: blur(14px);
    box-shadow: var(--glow);
  }

  /* ===== Header ===== */
  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 16px;
  }

  .badge {
    background: rgba(56,189,248,0.15);
    color: var(--primary);
    padding: 4px 10px;
    border-radius: 999px;
    font-size: 0.75rem;
    border: 1px solid rgba(56,189,248,0.4);
  }

  /* ===== Product Grid (‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÑ‡∏ß‡πâ STEP 5) ===== */
  .grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
  }

  .product-card {
    background: var(--glass);
    border: 1px solid var(--glass-border);
    border-radius: 16px;
    padding: 12px;
    backdrop-filter: blur(12px);
    box-shadow: 0 0 20px rgba(0,0,0,0.3);
  }

  .product-img {
  width: 100%;
  aspect-ratio: 1 / 1;      /* üî≤ ‡∏™‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏° */
  background-color: #020617;
  border-radius: 12px;
  margin-bottom: 8px;

  background-size: contain; /* ‚úÖ ‡πÄ‡∏´‡πá‡∏ô‡∏†‡∏≤‡∏û‡πÄ‡∏ï‡πá‡∏° ‡πÑ‡∏°‡πà‡πÇ‡∏î‡∏ô‡∏ï‡∏±‡∏î */
  background-repeat: no-repeat;
  background-position: center;
}


  .product-name {
    font-size: 0.9rem;
    margin-bottom: 4px;
  }

  .product-price {
    color: var(--primary);
    font-weight: 600;
    font-size: 0.95rem;
  }

  /* ===== Admin Accent ===== */
  .admin {
    border-left: 3px solid var(--primary);
  }
</style>


  <!-- ========================= -->
  <!-- APP ROOT -->
  <!-- ========================= -->
  <div id="app"></div>

<!-- ========================= -->
<!-- GLOBAL STATE -->
<!-- ========================= -->
<script>
  let sessionExpiredHandled = false; // ‚úÖ ‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ

  const state = {
    mode: 'viewer',
    token: null,
    role: 'viewer',
    username: null,

    products: [],
    filteredProducts: [],

    search: '',
    category: 'all',

    loading: false,
    error: null,

    submitting: false,
    logs: []
  };

  const SESSION_MAX_AGE = 24 * 60 * 60 * 1000;
  const SESSION_WARN_BEFORE = 5 * 60 * 1000;
  
  let sessionTimer = null;
  let pingTimer = null;
</script>

      
    <script>
function startSessionWatcher() {
  clearInterval(sessionTimer);

  sessionTimer = setInterval(() => {
    const loginTime = Number(localStorage.getItem('admin_login_time'));
    if (!loginTime) return;

    const now = Date.now();
    const age = now - loginTime;

    // ‚õî session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏
    if (age >= SESSION_MAX_AGE) {

  // üõë ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤ admin ‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
  if (state.mode !== 'admin') {
    clearInterval(sessionTimer);
    return;
  }

  if (!sessionExpiredHandled) {
    sessionExpiredHandled = true;
    alert('Session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ login ‡πÉ‡∏´‡∏°‡πà');
    logoutAdmin();
  }
  clearInterval(sessionTimer);
  return;
}

    // ‚ö†Ô∏è ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏
    if (SESSION_MAX_AGE - age <= SESSION_WARN_BEFORE) {
      console.warn('Session ‡∏à‡∏∞‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÉ‡∏ô‡πÑ‡∏°‡πà‡∏Å‡∏µ‡πà‡∏ô‡∏≤‡∏ó‡∏µ');
      // (‡∏ñ‡πâ‡∏≤‡∏à‡∏∞‡∏ó‡∏≥ popup ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô ‚Üí ‡∏ó‡∏≥‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ)
    }

  }, 60 * 1000); // ‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏∏‡∏Å 1 ‡∏ô‡∏≤‡∏ó‡∏µ
}      
</script>

<script>
  
    let pingRunning = false;

function startPingSession() {
  if (pingRunning) return;
  pingRunning = true;

  clearInterval(pingTimer);

  pingTimer = setInterval(async () => {
    if (state.mode !== 'admin' || !state.token) {
      clearInterval(pingTimer);
      pingRunning = false;
      return;
    }

    try {
      await apiPing();
    } catch (e) {
      if (!sessionExpiredHandled) {
        sessionExpiredHandled = true;
        alert('Session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ login ‡πÉ‡∏´‡∏°‡πà');
        logoutAdmin();
      }
    }
  }, 5 * 60 * 1000);
}

 </script>
  

  <!-- ========================= -->
<!-- API CONFIG -->
<!-- ========================= -->
<script>
  const API_URL = 'https://script.google.com/macros/s/AKfycby8s440W72bqx8khrsDZnCo0FQelouKbs8bdFoNfqDkUPfXwdshGg16K3sbJbxRKArf3A/exec';

  // ‚úÖ STEP 29.1 ‚Äî Client Signature
  const CLIENT_KEY = 'stockbuilder-v1';
</script>


  <!-- ========================= -->
<!-- STATE INIT -->
<!-- ========================= -->
<script>
  function initState() {
  const savedToken = localStorage.getItem('admin_token');
  const savedRole  = localStorage.getItem('admin_role');
  const savedUser  = localStorage.getItem('admin_username');

  if (savedToken && savedRole && savedUser) {
    state.mode = 'admin';
    state.token = savedToken;
    state.role = savedRole;
    state.username = savedUser;

    startSessionWatcher(); // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
    startPingSession();   // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°
  } else {
    state.mode = 'viewer';
    state.token = null;
    state.role = 'viewer';
    state.username = null;
  }
}

  async function logoutAdmin() {
  if (state.token) {
    try {
      await apiLogout();
    } catch (e) {
      console.warn('Logout backend failed:', e.message);
    }
  }

  clearInterval(sessionTimer); // ‚úÖ ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç
  clearInterval(pingTimer); // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°  

  localStorage.removeItem('admin_token');
  localStorage.removeItem('admin_role');
  localStorage.removeItem('admin_username');
  localStorage.removeItem('admin_login_time');

  state.mode = 'viewer';
  state.token = null;
  state.role = 'viewer';
  state.username = null;

  sessionExpiredHandled = false;  
  renderUI();
}

</script>


<!-- ========================= -->
<!-- API FUNCTIONS -->
<!-- ========================= -->
<script>
  async function apiRequest(action, payload = {}) {
  try {
    const res = await fetch(API_URL, {
      method: 'POST',
      body: JSON.stringify({
        action,
        token: state.token,
        payload,
        clientKey: CLIENT_KEY
      })
    });

    const data = await res.json();
    if (!data.success) throw new Error(data.message);
    return data.data;

  } catch (err) {
    
    if (err.message.includes('Rate limit')) {
    alert(err.message);
    return null;
  }
    if (err.message === 'Unauthorized') {
      if (state.mode !== 'admin') return null;

      if (!sessionExpiredHandled) {
        sessionExpiredHandled = true;
        alert('Session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ login ‡πÉ‡∏´‡∏°‡πà');
        logoutAdmin();
      }
      return null;
    }

    state.error = err.message || 'Server error';
    return null;
  }
}
  /* ===== API WRAPPERS ===== */

  function apiListProducts() {
    return apiRequest('list');
  }

  function apiLogin(username, password) {
    return apiRequest('login', { username, password });
  }

  function apiAddProduct(product) {
    return apiRequest('add', product);
  }

  function apiUpdateProduct(product) {
    return apiRequest('update', product);
  }

  function apiUpdateStock(code, diff) {
    return apiRequest('updateStock', { code, diff });
  }

  function apiStockHistory(code) {
    return apiRequest('stockHistory', { code });
  }
  
  function apiDashboardSummary() {
    return apiRequest('dashboardSummary');
  }

  function apiListLogs(filters = {}) {
    return apiRequest('listLogs', filters);
  }

  function apiLogout() {
  return apiRequest('logout');
  }

  function apiForceLogout(username) {
  return apiRequest('forceLogout', { username });
  }

  function apiPing() {
  return apiRequest('ping');
  }



  function apiResetPassword(username, newPassword) {
  return apiRequest('resetPassword', {
    username,
    newPassword
  });
}

function apiChangePassword(oldPassword, newPassword) {
  return apiRequest('changePassword', {
    oldPassword,
    newPassword
  });
}

</script>
    
<script>
  /* ===== USER MANAGEMENT (STEP 4.1) ===== */

  /* =========================
   USER MANAGEMENT UI
========================= */

async function renderUserManagement() {
  if (state.role !== 'admin') return;

  const app = document.getElementById('app');
  app.innerHTML = `
    <div class="header">
      <h1>üë• User Management</h1>
      <button class="badge" onclick="renderUI()">Back</button>
    </div>
    <div id="user-list"></div>
  `;

  const users = await apiListUsers();
  if (!users) return;

  const list = document.getElementById('user-list');
  list.innerHTML = '';

  users.forEach(u => {
  const isSelf = u.username === state.username;
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <b>${u.username}</b><br/>
      <select
  ${isSelf ? 'disabled' : ''}
  onchange="changeUserRole('${u.username}', this.value)">
        ${['viewer','staff','admin']
          .map(r => `<option value="${r}" ${u.role===r?'selected':''}>${r}</option>`)
          .join('')}
          </select>

    <button
  style="margin-top:8px"
  onclick="openResetPassword('${u.username}')">
  üîë Reset Password
</button>

${u.username !== state.username ? `
<button
  style="margin-top:8px;background:#ef4444;color:white"
  onclick="confirmForceLogout('${u.username}')">
  üö™ Force Logout
</button>
` : ''}
  `;

    list.appendChild(card);
  });
}

async function changeUserRole(username, role) {
  const ok = confirm(`‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ${username} ‡πÄ‡∏õ‡πá‡∏ô ${role}?`);
  if (!ok) return;

  if (state.submitting) return;

  let res = null;
  try {
    state.submitting = true;
    res = await apiUpdateUserRole(username, role);
  } finally {
    state.submitting = false;
  }

  if (res) {
    alert('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
    renderUserManagement();
  }
}

  function apiListUsers() {
    return apiRequest('listUsers');
  }

  function apiUpdateUserRole(username, role) {
    return apiRequest('updateUserRole', { username, role });
  }

  function openResetPassword(username) {
  const app = document.getElementById('app');

  app.innerHTML = `
    <div class="header">
      <h1>üîë Reset Password</h1>
      <button class="badge" onclick="renderUserManagement()">Back</button>
    </div>

    <div class="card">
      <p>User: <b>${username}</b></p>

      <input
        id="new-pass"
        type="password"
        placeholder="New password (min 8 chars)"
        style="width:100%;padding:10px;margin-top:8px"
      />

      <button
        style="margin-top:12px;width:100%;padding:12px;background:#38bdf8"
        onclick="submitResetPassword('${username}')">
        Reset Password
      </button>
    </div>
  `;
}

  async function submitResetPassword(username) {
  const pass = document.getElementById('new-pass').value;

  if (!pass || pass.length < 8) {
    alert('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 8 ‡∏ï‡∏±‡∏ß');
    return;
  }

  const ok = confirm(`‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á ${username}?`);
  if (!ok) return;

  const res = await apiResetPassword(username, pass);

  if (res) {
    alert('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
    renderUserManagement();
  }
}

  async function confirmForceLogout(username) {
  const ok = confirm(`‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö logout ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ${username}?`);
  if (!ok) return;

  const res = await apiForceLogout(username);

  if (res) {
    alert(`‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ${username} ‡∏ñ‡∏π‡∏Å logout ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`);
    renderUserManagement();
  }
}


</script>

    <!-- ===== IMAGE UPLOAD ===== -->
<script>
  async function apiUploadImage(file) {
  try {
    const base64 = await fileToBase64(file);

    const res = await fetch(API_URL, {
      method: 'POST',
      body: JSON.stringify({
        action: 'upload',
        token: state.token,
        clientKey: CLIENT_KEY,
        payload: {
          filename: file.name,
          mimeType: file.type,
          data: base64
        }
      })
    });

    const json = await res.json();
    if (!json.success) throw new Error(json.message);

    return json.data.url;

  } catch (e) {
    alert(e.message || '‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    return null;
  }
}

  function fileToBase64(file) {
    return new Promise(res => {
      const reader = new FileReader();
      reader.onload = () => res(reader.result.split(',')[1]);
      reader.readAsDataURL(file);
    });
  }
</script>

    <!-- ===== PRODUCTION HELPERS ===== -->
<script>
  function validateProduct(p) {
    if (!p.code) return '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
    if (!p.name || !p.name.trim()) return '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
    if (isNaN(p.price) || p.price < 0) return '‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ú‡∏¥‡∏î';
    if (isNaN(p.stock)) return '‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏ú‡∏¥‡∏î';
    if (!p.category) return '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏°‡∏ß‡∏î';
    return null;
  }

</script>

    
   <script>
/* =========================
   SAFE DOM VALUE HELPER
   (SPA / Prevent null crash)
========================= */
const getVal = (id) => {
  const el = document.getElementById(id);
  return el ? el.value : '';
};
</script>

<!-- ========================= -->
<!-- RENDER FUNCTIONS -->
<!-- ========================= -->
<script>
  /* =========================
     VIEWER SUPPORT
  ========================= */
async function adjustStock(code, diff) {
  if (state.role !== 'admin' && state.role !== 'staff') {
    alert('‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠');
    return;
  }

  if (state.submitting) return;
  state.submitting = true;
  renderUI();

  try {
    const res = await apiUpdateStock(code, diff);
    if (!res) {
      alert('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    }
  } finally {
    state.submitting = false;
    renderUI();
  }
}
  
  async function loadProducts() {
  state.loading = true;
  renderUI();

  const data = await apiListProducts();
  if (data) {
    state.products = data;
    applyFilter();
  }

  state.loading = false;
  renderUI();
}


  function applyFilter() {
    state.filteredProducts = state.products.filter(p => {
      const matchSearch =
        p.name.toLowerCase().includes(state.search.toLowerCase());
      const matchCategory =
        state.category === 'all' || p.category === state.category;
      return matchSearch && matchCategory;
    });
  }

  function onSearch(value) {
    state.search = value;
    applyFilter();
    renderUI();
  }

  function onFilterCategory(value) {
    state.category = value;
    applyFilter();
    renderUI();
  }

  function renderCategoryOptions() {
    const categories = [
  ...new Set(state.products.map(p => p.category.toLowerCase()))
];
    return categories.map(c => `<option value="${c}">${c}</option>`).join('');
  }

/* =========================
   DASHBOARD (STEP 15)
========================= */

async function renderDashboard() {

  // üîê ROLE GUARD ‚Äî ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
  if (state.role !== 'admin') {
    alert('‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠');
    return;
  }

  const app = document.getElementById('app');
  app.innerHTML = '';

  const header = document.createElement('div');
  header.className = 'header';
  header.innerHTML = `
    <h1>üìä Dashboard</h1>
    <button class="badge" onclick="renderUI()">Back</button>
  `;
  app.appendChild(header);

  const card = document.createElement('div');
  card.className = 'card';
  card.innerHTML = `<p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>`;
  app.appendChild(card);

  const data = await apiDashboardSummary();
  if (!data) return;

  card.innerHTML = `
    <p>üì¶ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: <b>${data.totalProducts}</b></p>
    <p>üìä ‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏£‡∏ß‡∏°: <b>${data.totalStock}</b></p>
    <p>‚ö†Ô∏è ‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î: <b>${data.lowStock}</b></p>
    <p>üí∞ ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡∏ï‡πä‡∏≠‡∏Å: <b>‡∏ø${data.stockValue}</b></p>
  `;

  drawDashboardChart(data.history || []);
}

function drawDashboardChart(history) {
  if (!history.length) return;

  const canvas = document.createElement('canvas');
  canvas.width = 300;
  canvas.height = 200;

  const card = document.createElement('div');
  card.className = 'card';
  card.appendChild(canvas);
  document.getElementById('app').appendChild(card);

  const ctx = canvas.getContext('2d');
  const padding = 30;

  const max = Math.max(...history.map(h => h.totalStock));
  const min = Math.min(...history.map(h => h.totalStock));
  const xStep = (canvas.width - padding * 2) / (history.length - 1 || 1);
  const yScale = (canvas.height - padding * 2) / (max - min || 1);

  ctx.strokeStyle = '#38bdf8';
  ctx.lineWidth = 2;
  ctx.beginPath();

  history.forEach((p, i) => {
    const x = padding + i * xStep;
    const y = canvas.height - padding - (p.totalStock - min) * yScale;
    if (i === 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  });

  ctx.stroke();
}  
  /* =========================
     ADMIN LOGIN
  ========================= */

  function renderAdminLogin() {
    const app = document.getElementById('app');
    app.innerHTML = '';

    const header = document.createElement('div');
    header.className = 'header';
    header.innerHTML = `
      <h1>üîê Admin Login</h1>
      <button class="badge" onclick="renderUI()">Back</button>
    `;

    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <input id="login-user" placeholder="Username"
        style="width:100%;padding:10px;margin-bottom:8px;" />
      <input id="login-pass" type="password" placeholder="Password"
        style="width:100%;padding:10px;margin-bottom:8px;" />
      <button onclick="submitLogin()"
        style="width:100%;padding:12px;background:#38bdf8;">
        Login
      </button>
    `;

    app.appendChild(header);
    app.appendChild(card);
  }

  async function submitLogin() {
  const u = document.getElementById('login-user').value;
  const p = document.getElementById('login-pass').value;

  const data = await apiLogin(u, p);
  if (!data) return;

  const now = Date.now();

  localStorage.setItem('admin_token', data.token);
  localStorage.setItem('admin_role', data.role);
  localStorage.setItem('admin_username', u.toLowerCase());
  localStorage.setItem('admin_login_time', now); // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°

  state.token = data.token;
  state.role = data.role;
  state.username = u.toLowerCase();
  state.mode = 'admin';
    
  sessionExpiredHandled = false; // ‚úÖ reset flag
  startSessionWatcher(); // ‚úÖ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤
  startPingSession();      // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ  
  renderUI();
}


   function renderChangePassword() {
  const app = document.getElementById('app');
  app.innerHTML = `
    <div class="header">
      <h1>üîë ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</h1>
      <button class="badge" onclick="renderUI()">Back</button>
    </div>

    <div class="card">
      <input
        id="old-pass"
        type="password"
        placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏î‡∏¥‡∏°"
        style="width:100%;padding:10px;margin-bottom:8px;"
      />

      <input
        id="new-pass"
        type="password"
        placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 8 ‡∏ï‡∏±‡∏ß)"
        style="width:100%;padding:10px;margin-bottom:8px;"
      />

      <button
        style="width:100%;padding:12px;background:#38bdf8;"
        onclick="submitChangePassword()">
        ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
      </button>
    </div>
  `;
}

  async function submitChangePassword() {
  const oldPass = document.getElementById('old-pass').value;
  const newPass = document.getElementById('new-pass').value;

  if (!oldPass || !newPass) {
    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');
    return;
  }

  if (newPass.length < 8) {
    alert('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 8 ‡∏ï‡∏±‡∏ß');
    return;
  }

  const ok = confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô?');
  if (!ok) return;

  const res = await apiChangePassword(oldPass, newPass);

  if (res) {
    alert('‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ login ‡πÉ‡∏´‡∏°‡πà');
    logoutAdmin(); // üîê backend clear token ‡πÅ‡∏•‡πâ‡∏ß ‚Üí logout ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    sessionExpiredHandled = false; // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°
    
  }
}

  /* =========================
     MAIN RENDER
  ========================= */

  function renderUI() {
    const app = document.getElementById('app');
    app.innerHTML = '';

    if (state.mode === 'viewer') renderViewer(app);
    if (state.mode === 'admin') renderAdmin(app);

    if (state.loading || state.submitting) {
      renderOverlay(app);
    }
  }

  /* =========================
     VIEWER
  ========================= */

  async function renderViewer(root) {
    const header = document.createElement('div');
    header.className = 'header';
    header.innerHTML = `
      <h1>üì¶ StockBuilder</h1>
      <button class="badge" onclick="renderAdminLogin()">Admin</button>
    `;
    root.appendChild(header);

    if (state.loading) return root.appendChild(renderLoading());
    if (state.error) return root.appendChild(renderError());

    if (state.products.length === 0) {
      await loadProducts();
      return;
    }
 

    const searchCard = document.createElement('div');
    searchCard.className = 'card';
    searchCard.innerHTML = `
      <input placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤..."
        value="${state.search}"
        oninput="onSearch(this.value)"
        style="width:100%;padding:10px;border-radius:12px;border:none;" />
      <select onchange="onFilterCategory(this.value)"
        style="width:100%;margin-top:10px;padding:10px;border-radius:12px;border:none;">
        <option value="all">‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏ß‡∏î</option>
        ${renderCategoryOptions()}
      </select>
    `;
    root.appendChild(searchCard);
    root.appendChild(renderProductGrid());
  }

  function renderProductGrid() {
    const grid = document.createElement('div');
    grid.className = 'grid';

    state.filteredProducts.forEach(p => {
      const card = document.createElement('div');
      card.className = 'product-card';
      card.innerHTML = `
  <div class="product-img"
    style="background-image:url('${p.image || ''}');">
  </div>

  <div class="product-name">${p.name}</div>

  <div class="product-price">‡∏ø${p.price}</div>

  <div style="font-size:0.8rem;color:#cbd5f5;margin-top:4px;">
    ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: <b>${p.stock}</b>
  </div>

  <div style="font-size:0.8rem;color:#a5b4fc;">
    ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${p.status || '-'}
  </div>

  <div style="
    font-size:0.7rem;
    color:#94a3b8;
    margin-top:6px;
  ">
    ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:
    ${p.updatedAt
      ? new Date(p.updatedAt).toLocaleString('th-TH')
      : '-'}
  </div>
`;

      grid.appendChild(card);
    });

    return grid;
  }

  /* =========================
     ADMIN DASHBOARD
  ========================= */

  async function renderAdmin(root) {
  // ===== HEADER =====
  const header = document.createElement('div');
  header.className = 'header';
  header.innerHTML = `
    <h1>üßë‚Äçüíº Dashboard (${state.role})</h1>
    <button class="badge" onclick="logoutAdmin()">Logout</button>
  `;
  root.appendChild(header);

  // ===== ADMIN MENU =====
  if (state.role === 'admin') {
    const dashBtn = document.createElement('button');
    dashBtn.className = 'card';
    dashBtn.innerHTML = 'üìä Dashboard Overview';
    dashBtn.onclick = renderDashboard;
    root.appendChild(dashBtn);

    const logBtn = document.createElement('button');
    logBtn.className = 'card';
    logBtn.innerHTML = 'üßæ Audit Logs';
    logBtn.onclick = renderAuditLogs;
    root.appendChild(logBtn);

    const userBtn = document.createElement('button');
    userBtn.className = 'card';
    userBtn.innerHTML = 'üë• User Management';
    userBtn.onclick = renderUserManagement;
    root.appendChild(userBtn);

    const passBtn = document.createElement('button');
    passBtn.className = 'card';
    passBtn.innerHTML = 'üîë ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô';
    passBtn.onclick = renderChangePassword;
    root.appendChild(passBtn);
  }

  // ===== ADMIN ACTIONS =====
  if (state.role === 'admin') {
    const addBtn = document.createElement('button');
    addBtn.className = 'card';
    addBtn.innerHTML = '‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà';
    addBtn.onclick = () => openProductForm();
    root.appendChild(addBtn);

    const exportBtn = document.createElement('button');
    exportBtn.className = 'card';
    exportBtn.innerHTML = 'üì§ Export CSV';
    exportBtn.onclick = exportCSV;
    root.appendChild(exportBtn);
  }

 // ===== LOAD PRODUCTS (once) =====
if (state.products.length === 0 && !state.loading) {
  state.loading = true;
  renderUI(); // ‚¨ÖÔ∏è ‡πÉ‡∏´‡πâ overlay ‡πÅ‡∏™‡∏î‡∏á

  const data = await apiListProducts();
  if (data) {
    state.products = data;
    applyFilter();
  }

  state.loading = false;
  renderUI(); // ‚úÖ ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å
  return;
}


  // ===== PRODUCT LIST =====
  state.products.forEach(p => {
    const card = document.createElement('div');
    card.className = 'card admin';
    card.innerHTML = `
      <b>${p.name}</b> (${p.code})<br/>
      ‡∏™‡∏ï‡πä‡∏≠‡∏Å: <b>${p.stock}</b><br/>
      ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${p.status}<br/><br/>

      <button onclick="adjustStock('${p.code}', 1)">Ôºã</button>
      <button onclick="adjustStock('${p.code}', -1)">Ôºç</button>

      ${state.role === 'admin'
        ? `<button onclick="showStockHistory('${p.code}')">üìä History</button>
           <button onclick="openProductForm(${JSON.stringify(p).replace(/"/g, '&quot;')})">‚úèÔ∏è</button>`
        : ''}
    `;
    root.appendChild(card);
  });
}

  /* =========================
     PRODUCT FORM
  ========================= */

  function openProductForm(product = null) {
    const app = document.getElementById('app');
    app.innerHTML = '';

    const isEdit = !!product;

    const header = document.createElement('div');
    header.className = 'header';
    header.innerHTML = `
      <h1>${isEdit ? '‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' : '‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'}</h1>
      <button class="badge" onclick="renderUI()">Back</button>
    `;

    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <input id="p-code" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤"
        value="${product?.code || ''}" ${isEdit ? 'disabled' : ''} />
      <input id="p-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" value="${product?.name || ''}" />
      <input id="p-price" type="number" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤" value="${product?.price || ''}" />
      <input id="p-stock" type="number" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô" value="${product?.stock || 0}" />
      <input id="p-category" placeholder="‡∏´‡∏°‡∏ß‡∏î" value="${product?.category || ''}" />

      <select id="p-status">
        ${['‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á','‡∏´‡∏°‡∏î','‡πÇ‡∏Å‡∏î‡∏±‡∏á‡πÑ‡∏ó‡∏¢','‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á']
          .map(s => `<option ${product?.status===s?'selected':''}>${s}</option>`).join('')}
      </select>

      <input id="p-image" type="file" accept="image/*" />
      ${product?.image ? `<img src="${product.image}" style="width:100%;border-radius:12px;margin-top:8px;" />` : ''}

      <button
  ${state.submitting ? 'disabled' : ''}
  style="margin-top:12px;width:100%;padding:12px;background:#38bdf8;"
  onclick="submitProduct(${isEdit})"
>
  ${isEdit ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'}
</button>

    `;
    app.appendChild(header);
    app.appendChild(card);
  }

async function submitProduct(isEdit = false) {
  if (state.submitting) return;
  state.submitting = true;

  try {
    const code = getVal('p-code');

    const product = {
      code,
      name: getVal('p-name'),
      price: Number(getVal('p-price')),
      stock: Number(getVal('p-stock')),
      category: getVal('p-category'),
      status: getVal('p-status'),
      image: ''
    };

    const err = validateProduct(product);
    if (err) {
      alert(err);
      return;
    }

    // ===== IMAGE =====
    const fileInput = document.getElementById('p-image');
    const file = fileInput?.files?.[0] || null;

    if (file) {
      const imageUrl = await apiUploadImage(file);
      if (!imageUrl) throw new Error('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      product.image = imageUrl;
    } else if (isEdit) {
      product.image =
        state.products.find(p => p.code === code)?.image || '';
    }

    // ===== SAVE =====
    if (isEdit) {
      await apiUpdateProduct(product);

      const idx = state.products.findIndex(p => p.code === code);
      if (idx !== -1) {
        state.products[idx] = { ...state.products[idx], ...product };
      }
    } else {
      const saved = await apiAddProduct(product);
      if (saved && saved.code) {
        state.products.push(saved);
        applyFilter();
      } else {
        await loadProducts();
      }
    }

  } catch (e) {
    console.error(e);
    alert(e.message || '‡πÄ‡∏û‡∏¥‡πà‡∏° / ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
  } finally {
    state.submitting = false;
    renderUI();
  }
}


   
   /* =========================
     COMMON
  ========================= */

  function renderLoading() {
    const div = document.createElement('div');
    div.className = 'card';
    div.innerHTML = `<p>‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>`;
    return div;
  }

  function renderError() {
  if (!state.error) return document.createElement('div');

  const msg = state.error;
  state.error = null;

  const div = document.createElement('div');
  div.className = 'card';
  div.innerHTML = `<p>‚ùå ${msg}</p>`;
  return div;
}

    function renderOverlay(root) {
    const overlay = document.createElement('div');
    overlay.style = `
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.5);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:9999;
    `;
    overlay.innerHTML = `
      <div class="card">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...</div>
    `;
    root.appendChild(overlay);
  }

  function exportCSV() {
  if (!state.products.length) {
    alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤');
    return;
  }

  const headers = [
    'code','name','price','stock','category','status','image'
  ];

  const rows = state.products.map(p =>
    headers.map(h =>
      `"${(p[h] ?? '').toString().replace(/"/g,'""')}"`
    ).join(',')
  );

  const csv = [headers.join(','), ...rows].join('\n');

  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);

  const a = document.createElement('a');
  a.href = url;
  a.download = `stock_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();

  URL.revokeObjectURL(url);
}

  async function showStockHistory(code) {
    const app = document.getElementById('app');
    app.innerHTML = '';

    const header = document.createElement('div');
    header.className = 'header';
    header.innerHTML = `
      <h1>üìä Stock History (${code})</h1>
      <button class="badge" onclick="renderUI()">Back</button>
    `;

    app.appendChild(header);

    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <canvas id="historyChart" width="300" height="200"></canvas>
    `;
    app.appendChild(card);

    const data = await apiStockHistory(code);
    if (!data || !data.length) {
      card.innerHTML += `<p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</p>`;
      return;
    }

    drawStockChart(data);
  }

  async function renderAuditLogs() {
  if (state.role !== 'admin') return;

  const app = document.getElementById('app');
  app.innerHTML = '';

  app.innerHTML = `
    <div class="header">
      <h1>üßæ Audit Logs</h1>
      <button class="badge" onclick="renderUI()">Back</button>
    </div>

    <div class="card">
      <input id="log-user" placeholder="username" />
      <input id="log-action" placeholder="action" />
      <input id="log-keyword" placeholder="keyword" />

      <input id="log-from" type="date" />
      <input id="log-to" type="date" />

      <button onclick="loadLogs()">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
    </div>

    <div id="log-list"></div>
  `;

  loadLogs();
}

async function loadLogs() {
  const filters = {
    username: document.getElementById('log-user')?.value,
    action: document.getElementById('log-action')?.value,
    keyword: document.getElementById('log-keyword')?.value,
    dateFrom: document.getElementById('log-from')?.value,
    dateTo: document.getElementById('log-to')?.value
  };

  const logs = await apiListLogs(filters);
  if (!logs) return;

  const list = document.getElementById('log-list');
  list.innerHTML = '';

  logs.forEach(l => {
    const div = document.createElement('div');
    div.className = 'card';
    div.innerHTML = `
      <b>${l.action}</b> ‚Äî ${l.target || ''}<br/>
      üë§ ${l.user} (${l.role})<br/>
      üïí ${new Date(l.time).toLocaleString()}<br/>
      <small>${l.detail || ''}</small>
    `;
    list.appendChild(div);
  });
}

  function drawStockChart(data) {
    const canvas = document.getElementById('historyChart');
    const ctx = canvas.getContext('2d');

    ctx.clearRect(0, 0, canvas.width, canvas.height);

    const padding = 30;
    const maxStock = Math.max(...data.map(d => d.stock));
    const minStock = Math.min(...data.map(d => d.stock));

    const xStep = (canvas.width - padding * 2) / (data.length - 1 || 1);
    const yScale = (canvas.height - padding * 2) / (maxStock - minStock || 1);

    ctx.strokeStyle = '#38bdf8';
    ctx.lineWidth = 2;
    ctx.beginPath();

    data.forEach((point, i) => {
      const x = padding + i * xStep;
      const y = canvas.height - padding - (point.stock - minStock) * yScale;

      if (i === 0) ctx.moveTo(x, y);
      else ctx.lineTo(x, y);
    });

    ctx.stroke();

    ctx.fillStyle = '#38bdf8';
    data.forEach((point, i) => {
      const x = padding + i * xStep;
      const y = canvas.height - padding - (point.stock - minStock) * yScale;
      ctx.beginPath();
      ctx.arc(x, y, 3, 0, Math.PI * 2);
      ctx.fill();
    });
  }
  
</script>
<!-- ========================= -->
<!-- APP START -->
<!-- ========================= -->
<script>
  initState();
  renderUI();
</script>

</body>
</html>
