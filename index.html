<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>StockBuilder</title>
  <link rel="icon" href="data:,">  
</head>
  <body>
 <!-- ========================= -->
<!-- UI STYLE (STEP 2) -->
<!-- Rose Gold + Glass Luxury -->
<!-- ========================= -->
<style>
@import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700;800&display=swap');

/* =========================
   DESIGN TOKENS (ROSE GOLD)
========================= */
:root {
  --bg-main: radial-gradient(
    circle at top,
    #f7d9e3,
    #f1c6d3 35%,
    #e8b4c2 60%,
    #d8a1b1
  );

  --glass: rgba(255,255,255,0.38);
  --glass-strong: rgba(255,255,255,0.55);
  --glass-border: rgba(255,255,255,0.65);

  --rose-soft: #fde7ef;
  --rose-gold: #f3b6c8;
  --rose-deep: #b76e79;

  --text-main: #4a1d2f;
  --text-muted: rgba(74,29,47,0.65);

  --glow-soft: 0 0 20px rgba(243,182,200,0.45);
  --glow: 0 0 36px rgba(243,182,200,0.75);

  --primary-gold: #f3b6c8;
  --primary-admin: #e879a7;
}

/* =========================
   BASE
========================= */
* { box-sizing: border-box; }

body {
  margin: 0;
  font-family: 'Sarabun', system-ui, sans-serif;
  background: var(--bg-main);
  color: var(--text-main);
  min-height: 100vh;
}

#app {
  padding: 18px;
  max-width: 480px;
  margin: 0 auto;
}

/* =========================
   TYPO
========================= */
h1 {
  font-size: 1.6rem;
  margin: 0 0 14px;
  font-weight: 800;
  letter-spacing: .3px;
}

p {
  margin: 0;
  font-size: .95rem;
  color: var(--text-muted);
}

/* =========================
   GLASS CARD
========================= */
.card {
  background: linear-gradient(
    180deg,
    rgba(255,255,255,0.65),
    rgba(255,255,255,0.28)
  );
  border: 1px solid var(--glass-border);
  border-radius: 22px;
  padding: 16px;
  margin-bottom: 14px;
  backdrop-filter: blur(22px);
  -webkit-backdrop-filter: blur(22px);
  box-shadow: var(--glow-soft);
}

/* =========================
   HEADER
========================= */
.header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 16px;
}

/* =========================
   BUTTON / BADGE
========================= */
button,
.badge {
  font-family: inherit;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,0.75);
  background: linear-gradient(
    160deg,
    #fff0f6,
    #f3b6c8
  );
  color: #6b2239;
  padding: 10px 18px;
  font-size: .85rem;
  font-weight: 700;
  cursor: pointer;
  box-shadow: var(--glow-soft);
  transition: all .25s ease;
}

button:hover,
.badge:hover {
  transform: translateY(-1px) scale(1.03);
  box-shadow: var(--glow);
}

/* =========================
   BRAND TITLE
========================= */
.brand-title {
  padding: 10px 26px;
  border-radius: 999px;
  font-weight: 900;
  font-size: 1.15rem;
  letter-spacing: 1px;
  color: #7a2e44;
  background: linear-gradient(
    90deg,
    #fff5f9,
    #f3b6c8
  );
  border: 2px solid rgba(255,255,255,0.9);
  box-shadow: 0 0 40px rgba(243,182,200,.85);
}

/* =========================
   GRID / PRODUCT CARD
========================= */
.grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 14px;
}

.product-card {
  position: relative;
  background: linear-gradient(
    180deg,
    rgba(255,255,255,0.6),
    rgba(255,255,255,0.25)
  );
  border: 1px solid var(--glass-border);
  border-radius: 22px;
  padding: 16px;
  backdrop-filter: blur(20px);
  box-shadow: var(--glow-soft);
  transition: all .25s ease;
}

.product-card:hover {
  transform: translateY(-2px);
  box-shadow: var(--glow);
}

.product-img {
  width: 100%;
  aspect-ratio: 1/1;
  border-radius: 14px;
  background-color: rgba(255,255,255,.45);
  background-size: contain;
  background-repeat: no-repeat;
  background-position: center;
  margin-bottom: 8px;
}

.product-name {
  font-size: 1rem;
  font-weight: 800;
  margin: 6px 0 4px;
}

.product-price {
  font-size: 1.05rem;
  font-weight: 900;
  color: var(--rose-deep);
  text-shadow: 0 0 12px rgba(243,182,200,.7);
}

/* =========================
   ORDER FAB
========================= */
.order-fab {
  position: absolute;
  bottom: 52px;
  right: 16px;
  width: 48px;
  height: 48px;
  border-radius: 16px;
  background: linear-gradient(135deg,#fff5f9,#f3b6c8);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 22px;
  cursor: pointer;
  box-shadow: 0 0 28px rgba(243,182,200,.85);
  transition: all .25s ease;
}

.order-fab:hover {
  transform: translateY(-2px) scale(1.05);
  box-shadow: 0 0 40px rgba(243,182,200,1);
}

/* =========================
   STEP 2.3 ‚Äî ORDER FAB PREMIUM
========================= */

/* ===== BASE ENHANCE ===== */
/* =========================
   STEP 2.6 ‚Äî ORDER FAB (SMALLER)
========================= */
.order-fab {
  width: 40px;
  height: 40px;
  border-radius: 12px;

  bottom: 48px;
  right: 14px;

  font-size: 18px;

  box-shadow:
    inset 0 0 0 1px rgba(255,255,255,0.7),
    0 0 16px rgba(243,182,200,0.55);
}

.order-fab:hover {
  transform: translateY(-1px) scale(1.03);
  box-shadow: 0 0 22px rgba(243,182,200,0.75);
}

/* ===== LABEL HINT ===== */
.order-fab::after {
  content: '‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠';
  position: absolute;

  right: 54px;
  top: 50%;
  transform: translateY(-50%) translateX(6px);

  padding: 6px 12px;
  border-radius: 999px;

  font-size: 0.65rem;
  font-weight: 800;
  letter-spacing: .3px;

  color: #7a2e44;
  background: linear-gradient(
    90deg,
    #fff5f9,
    #f3b6c8
  );

  white-space: nowrap;
  opacity: 0;
  pointer-events: none;

  box-shadow: 0 0 20px rgba(243,182,200,.75);

  transition:
    opacity .25s ease,
    transform .25s ease;
}

/* ‡πÅ‡∏™‡∏î‡∏á label ‡πÄ‡∏°‡∏∑‡πà‡∏≠ hover / tap */
.order-fab:hover::after {
  opacity: 1;
  transform: translateY(-50%) translateX(0);
}

/* ===== SOFT ATTENTION (FIRST LOAD) ===== */
@keyframes fabPulse {
  0%   { box-shadow: 0 0 0 rgba(243,182,200,0); }
  50%  { box-shadow: 0 0 32px rgba(243,182,200,.9); }
  100% { box-shadow: 0 0 0 rgba(243,182,200,0); }
}

/* pulse ‡πÅ‡∏Ñ‡πà‡πÄ‡∏ö‡∏≤ ‡πÜ */
.order-fab {
  animation: fabPulse 1.8s ease-out 1;
}  

/* =========================
   ADMIN ACCENT
========================= */
.admin {
  border-left: 4px solid var(--rose-deep);
}

/* =========================
   STEP 2.4 ‚Äî HEADER SMART
========================= */

/* header ‡∏õ‡∏Å‡∏ï‡∏¥ */
.header {
  position: sticky;
  top: 0;
  z-index: 100;
  transition:
    padding .25s ease,
    transform .25s ease,
    backdrop-filter .25s ease,
    background .25s ease;
}

/* ‡∏ï‡∏≠‡∏ô‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏•‡∏á */
.header.header--compact {
  padding-top: 6px;
  padding-bottom: 6px;

  backdrop-filter: blur(14px);
  background: linear-gradient(
    180deg,
    rgba(255,255,255,0.75),
    rgba(255,255,255,0.55)
  );
}

/* ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î title ‡∏ï‡∏≠‡∏ô compact */
.header.header--compact h1,
.header.header--compact .brand-title {
  transform: scale(0.9);
  opacity: 0.85;
}

.header {
  will-change: padding, transform;
}


  /* =========================
   EMPTY STATE ‚Äî UX POLISH
========================= */
.empty-state {
  animation: fadeUp .35s ease;
}

@keyframes fadeUp {
  from {
    opacity: 0;
    transform: translateY(6px);
  }
  to {
    opacity: 1;
    transform: none;
  }
}  


/* =========================
   STEP 2.6 ‚Äî CLEAN META STRIP
========================= */

/* ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ */
.product-code {
  background: transparent !important;
  box-shadow: none !important;
  padding: 0 !important;
  font-size: 0.65rem;
  opacity: 0.75;
}

/* ‡∏´‡∏°‡∏ß‡∏î */
.product-category {
  background: transparent !important;
  box-shadow: none !important;
  padding: 0 !important;
  font-weight: 700;
}

/* meta (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô / ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞) */
.meta-pill {
  background: transparent !important;
  box-shadow: none !important;
  padding: 0 !important;
}  

  </style>

    <!-- ===== FORM INPUT BEAUTIFY ===== -->
<style>
/* ===== INPUT / SELECT / FILE ===== */
.card input,
.card select {
  width: 100%;
  padding: 12px 14px;
  margin-bottom: 10px;

  border-radius: 14px;
  border: 1px solid rgba(255,255,255,0.55);

  background: linear-gradient(
    180deg,
    rgba(255,255,255,0.75),
    rgba(255,255,255,0.35)
  );

  font-family: inherit;
  font-size: 0.9rem;
  color: var(--text-main);

  box-shadow:
    inset 0 0 0 1px rgba(255,255,255,0.4),
    0 6px 16px rgba(183,110,121,0.25);

  transition: all .25s ease;
}

.card input:focus,
.card select:focus {
  outline: none;
  border-color: var(--rose-gold);
  box-shadow:
    0 0 0 2px rgba(243,182,200,0.45),
    0 10px 24px rgba(243,182,200,0.35);
}

/* ===== FILE INPUT ===== */
.card input[type="file"] {
  padding: 10px;
  background: rgba(255,255,255,0.45);
  cursor: pointer;
}
</style>

    <!-- ===== CONFIRM BUTTON ALIGN ===== -->
<style>
.modal-card .action-row {
  display: flex;
  gap: 12px;
  margin-top: 14px;
}

.modal-card .action-row button {
  flex: 1;
  padding: 12px;
  font-weight: 800;
}
</style>

  <!--
    <style>
/* =========================
   STEP 2.8 ‚Äî MOBILE GRID FIX
   ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ 1 ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡πà‡∏≠‡πÅ‡∏ñ‡∏ß (‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠)
========================= */

/* üì± Mobile */
@media (max-width: 520px) {
  .grid {
    grid-template-columns: 1fr;
    gap: 18px;
  }
}

/* üíª Tablet / Desktop (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) */
@media (min-width: 521px) {
  .grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

      body[data-theme="dark"] {
  --bg-main: radial-gradient(
    circle at top,
    #1e1b2e,
    #141225 45%,
    #0f0d1a
  );

  --glass: rgba(30,30,50,0.45);
  --glass-strong: rgba(40,40,65,0.6);
  --glass-border: rgba(255,255,255,0.12);

  --rose-soft: #2a243f;
  --rose-gold: #9f7aea;
  --rose-deep: #c4b5fd;

  --text-main: #f8fafc;              /* üëà ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏´‡∏•‡∏±‡∏Å (‡∏ä‡∏±‡∏î) */
  --text-muted: rgba(248,250,252,.65);

  --glow-soft: 0 0 18px rgba(167,139,250,.35);
  --glow: 0 0 32px rgba(167,139,250,.65);

  --primary-gold: #a78bfa;
  --primary-admin: #818cf8;
}

/* ‡∏õ‡∏£‡∏±‡∏ö‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á body */
body[data-theme="dark"] {
  background: var(--bg-main);
  color: var(--text-main);
}
      
</style>
    -->
    
<!-- =========================
   MOBILE UI FIX (STEP 2.X)
   - Header buttons spacing
   - Brand single line
   - Product 1 column
========================= -->
<!--
    <style>

/* =========================
   üì± MOBILE ONLY
========================= */
@media (max-width: 520px) {

  /* ===== HEADER LAYOUT ===== */
  .header {
    gap: 10px;
  }

  .header-actions {
    gap: 8px;
  }

  /* ===== BRAND TITLE ‚Äî ONE LINE ONLY ===== */
  .brand-title {
    padding: 8px 16px;
    font-size: 0.95rem;
    white-space: nowrap;      /* üëà ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß */
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* ===== DARK MODE + ADMIN BUTTON ===== */
  .header-actions .badge {
    padding: 6px 12px;        /* üëà ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡∏õ‡∏∏‡πà‡∏° */
    font-size: 0.75rem;
    min-width: auto;
  }

  /* ===== PRODUCT GRID ‚Üí 1 COLUMN ===== */
  .grid {
    grid-template-columns: 1fr !important; /* üëà 1 ‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏™‡∏°‡∏≠ */
    gap: 16px;
  }

  /* ===== PRODUCT CARD SPACING ===== */
  .product-card {
    padding: 14px;
  }

  /* ===== ORDER FAB ‚Äî SMALLER ===== */
  .order-fab {
    width: 36px;
    height: 36px;
    font-size: 16px;
    bottom: 44px;
    right: 12px;
  }

  .order-fab::after {
    font-size: 0.6rem;
    padding: 5px 10px;
  }
}

</style>
-->
    <!-- =========================
   STEP 2.9 ‚Äî PRODUCT CARD LUXURY
   Glass / Depth / Calm Motion
   (OVERRIDE ONLY)
========================= -->
<style>

/* =========================
   CARD ‚Äî DEPTH & LAYER
========================= */
.product-card {
  background: linear-gradient(
    180deg,
    rgba(255,255,255,0.75),
    rgba(255,255,255,0.35)
  );
  box-shadow:
    inset 0 0 0 1px rgba(255,255,255,0.55),
    0 18px 40px rgba(183,110,121,0.25);
}

/* =========================
   IMAGE ‚Äî HERO FEEL
========================= */
.product-img {
  position: relative;
  box-shadow:
    0 12px 28px rgba(0,0,0,0.18);
}

/* vignette ‡πÄ‡∏ö‡∏≤ ‡πÜ */
.product-img::after {
  content: '';
  position: absolute;
  inset: 0;
  border-radius: inherit;
  background: radial-gradient(
    circle at center,
    rgba(255,255,255,0) 60%,
    rgba(0,0,0,0.25)
  );
  pointer-events: none;
}

/* =========================
   TYPO ‚Äî CALM HIERARCHY
========================= */
.product-name {
  font-weight: 700;
  letter-spacing: .15px;
}

.product-price {
  letter-spacing: .3px;
}

/* =========================
   META ‚Äî QUIET
========================= */
.product-meta {
  opacity: 0.9;
}

/* =========================
   HOVER ‚Äî PREMIUM MOTION
========================= */
.product-card {
  transition:
    transform .35s ease,
    box-shadow .35s ease;
}

.product-card:hover {
  transform: translateY(-3px);
  box-shadow:
    inset 0 0 0 1px rgba(255,255,255,0.65),
    0 28px 60px rgba(183,110,121,0.35);
}

/* =========================
   ORDER FAB ‚Äî SUBTLE
========================= */
.order-fab {
  background: linear-gradient(
    135deg,
    rgba(255,255,255,0.9),
    var(--rose-gold)
  );
  opacity: 0.92;
}

.product-card:hover .order-fab {
  opacity: 1;
  box-shadow:
    0 0 28px rgba(243,182,200,0.85);
}

  .product-img {
  box-shadow: none !important;
}

.product-img::after {
  display: none !important;
}
</style>

    
    <style>
/* ===== PRODUCT DETAIL MODAL ===== */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  backdrop-filter: blur(6px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.modal-card {
  background: var(--glass);
  border: 1px solid var(--glass-border);
  border-radius: 20px;
  width: 92%;
  max-width: 420px;
  padding: 16px;
  box-shadow: var(--glow);
}

.modal-img {
  width: 100%;
  aspect-ratio: 1 / 1;
  border-radius: 14px;
  background-size: contain;
  background-repeat: no-repeat;
  background-position: center;
  background-color: #020617;
  margin-bottom: 12px;
}

.modal-close {
  text-align: right;
  font-size: 0.8rem;
  color: var(--primary-gold);
  cursor: pointer;
}

     /* =========================
   SPINNER (ORIGINAL STYLE)
========================= */
.spinner {
  width: 32px;
  height: 32px;
  border-radius: 50%;

  border: 4px solid rgba(243,182,200,0.35);
  border-top-color: #b76e79;

  animation: spin 0.9s linear infinite;

  box-shadow:
    0 0 12px rgba(243,182,200,0.6),
    inset 0 0 6px rgba(255,255,255,0.4);
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* ===== VARIANT (KEEP LOGIC SAFE) ===== */
.spinner.in {
  border-top-color: #b76e79;
}

.spinner.out {
  border-top-color: #b76e79;
}

/* =========================
   SIDEBAR (HAMBURGER ONLY)
========================= */
.sidebar {
  position: fixed;
  top: 0;
  right: -280px;        /* ‡∏ã‡πà‡∏≠‡∏ô‡∏™‡∏ô‡∏¥‡∏ó */
  width: 260px;
  height: 100vh;

  background: linear-gradient(
    180deg,
    #fff0f6,
    #f3b6c8
  );

  padding: 20px;
  z-index: 10000;

  transition: right 0.3s ease;
  box-shadow: -10px 0 40px rgba(0,0,0,0.25);
}

/* ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô‡∏Å‡∏î ‚ò∞ */
.sidebar.show {
  right: 0;
}

/* ‡∏õ‡∏∏‡πà‡∏°‡πÉ‡∏ô sidebar */
.sidebar button {
  width: 100%;
  margin-bottom: 10px;
  border-radius: 999px;
}      

.sidebar-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.25);
  backdrop-filter: blur(2px);
  z-index: 9999;
}

/* =========================
   CATEGORY COLORS
========================= */
.code-bag {
  background: linear-gradient(90deg,#fde7ef,#f3b6c8);
  color: #7a2e44;
}

.code-jewelry {
  background: linear-gradient(90deg,#fff5c3,#facc15);
  color: #7a5c00;
}

.code-utility {
  background: linear-gradient(90deg,#e0f2fe,#bae6fd);
  color: #075985;
}

.code-doll {
  background: linear-gradient(90deg,#ede9fe,#ddd6fe);
  color: #4c1d95;
}

.code-other {
  background: linear-gradient(90deg,#f1f5f9,#e5e7eb);
  color: #334155;
}

/* =========================
   HAMBURGER (ADMIN MENU)
========================= */
.hamburger {
  font-size: 1.6rem;
  line-height: 1;
  cursor: pointer;

  padding: 10px 14px;
  border-radius: 14px;

  background: linear-gradient(
    160deg,
    rgba(255,255,255,0.7),
    rgba(255,255,255,0.35)
  );

  border: 1px solid rgba(255,255,255,0.8);

  box-shadow:
    0 0 18px rgba(243,182,200,0.6),
    inset 0 0 0 1px rgba(255,255,255,0.6);

  transition: all .25s ease;
}

.hamburger:hover {
  transform: translateY(-1px) scale(1.05);
  box-shadow:
    0 0 30px rgba(243,182,200,0.9),
    inset 0 0 0 1px rgba(255,255,255,0.8);
}

      /* =========================
   HEADER ACTION GROUP FIX
========================= */
.header {
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.header-actions {
  display: flex;
  align-items: center;
  gap: 10px;
}

/* =========================
   UI POLISH ‚Äî PREMIUM HIERARCHY
   (STEP 2.2)
========================= */

/* ===== PRODUCT NAME ===== */
.product-name {
  font-size: 1.05rem;
  font-weight: 800;
  line-height: 1.4;
  margin-bottom: 6px;
  letter-spacing: .2px;
}

/* ===== PRICE (HERO) ===== */
.product-price {
  font-size: 1.2rem;          /* ‚¨ÜÔ∏è ‡πÄ‡∏î‡πà‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô */
  font-weight: 900;
  margin: 8px 0 6px;
  color: var(--rose-deep);

  text-shadow:
    0 0 14px rgba(243,182,200,.9),
    0 0 32px rgba(243,182,200,.6);
}

/* ===== PRODUCT CODE (DE-EMPHASIZE) ===== */
.product-code {
  font-size: 0.65rem;
  font-weight: 600;
  opacity: 0.75;
  margin: 2px 0 6px;
}

/* ===== CATEGORY BADGE (SOFTER) ===== */
.product-category {
  font-size: 0.65rem;
  font-weight: 700;
  opacity: 0.85;
  margin-bottom: 6px;

  box-shadow:
    inset 0 0 0 1px rgba(255,255,255,0.55),
    0 0 10px rgba(243,182,200,0.25);
}

/* ===== META (STOCK + STATUS) ===== */
.product-meta {
  display: flex;
  justify-content: space-between;
  gap: 8px;
  margin-top: 6px;
}

.meta-pill {
  font-size: 0.7rem;
  font-weight: 700;
  color: #7a2e44;
  opacity: 0.9;
}

/* ===== CARD BREATHING SPACE ===== */
.product-card {
  padding-bottom: 20px; /* ‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏î‡∏π‡πÇ‡∏õ‡∏£‡πà‡∏á‡∏Ç‡∏∂‡πâ‡∏ô */
}     

</style>

<!-- =========================
   STEP 2.9.1 ‚Äî TYPOGRAPHY NORMALIZE
   Readable / Calm / Equal
========================= -->
<style>
.product-name,
.product-price,
.product-code,
.product-category,
.meta-pill {
  font-size: 0.85rem;
  line-height: 1.45;
  letter-spacing: .15px;
}

.product-name {
  font-weight: 700;
  margin-bottom: 4px;
}

.product-price {
  font-weight: 700;
  color: var(--text-main);
  text-shadow: none !important;
  margin: 6px 0;
}

.meta-pill {
  font-weight: 600;
  opacity: 0.85;
}

  /* =========================
   PRICE ALIGN FIX
========================= */
.product-price {
  display: flex;
  align-items: center;
  gap: 6px;           /* ‡∏£‡∏∞‡∏¢‡∏∞ icon ‡∏Å‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç */
}

</style>


  <!-- ========================= -->
  <!-- APP ROOT -->
  <!-- ========================= -->
  <div id="app"></div>

<script>
/* =========================
   GLOBAL STATE (PRODUCTION)
========================= */

let sessionTimer = null;
let pingTimer = null;
let sessionExpiredHandled = false;

const state = {
  mode: 'viewer',
  token: null,
  role: 'viewer',
  username: null,

  products: [],
  filteredProducts: [],
  pendingOrders: [],

  search: '',
  category: 'all',

  loading: false,
  error: null,

  submittingForm: false,
  submittingStock: false,
  submittingAuth: false,

productsLoaded: false
};
</script>

<script>
/* =========================
   SESSION CONFIG (PRODUCTION)
========================= */

// ‡∏≠‡∏≤‡∏¢‡∏∏ session (‡πÄ‡∏ä‡πà‡∏ô 2 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á)
const SESSION_MAX_AGE = 2 * 60 * 60 * 1000;

// ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ (‡πÄ‡∏ä‡πà‡∏ô 5 ‡∏ô‡∏≤‡∏ó‡∏µ)
const SESSION_WARN_BEFORE = 5 * 60 * 1000;
</script>

      
    <script>
function startSessionWatcher() {
  clearInterval(sessionTimer);

  sessionTimer = setInterval(() => {
    const loginTime = Number(localStorage.getItem('admin_login_time'));
    if (!loginTime) return;

    const now = Date.now();
    const age = now - loginTime;

    // ‚õî session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏
    if (age >= SESSION_MAX_AGE) {

  // üõë ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏ô‡πâ‡∏≤ admin ‡πÅ‡∏•‡πâ‡∏ß ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
  if (state.mode !== 'admin') {
    clearInterval(sessionTimer);
    return;
  }

  if (!sessionExpiredHandled) {
    sessionExpiredHandled = true;
    alert('Session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ login ‡πÉ‡∏´‡∏°‡πà');
    logoutAdmin();
  }
  clearInterval(sessionTimer);
  return;
}

    // ‚ö†Ô∏è ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏
    if (SESSION_MAX_AGE - age <= SESSION_WARN_BEFORE) {
      console.warn('Session ‡∏à‡∏∞‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÉ‡∏ô‡πÑ‡∏°‡πà‡∏Å‡∏µ‡πà‡∏ô‡∏≤‡∏ó‡∏µ');
      // (‡∏ñ‡πâ‡∏≤‡∏à‡∏∞‡∏ó‡∏≥ popup ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô ‚Üí ‡∏ó‡∏≥‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ)
    }

  }, 60 * 1000); // ‡∏ï‡∏£‡∏ß‡∏à‡∏ó‡∏∏‡∏Å 1 ‡∏ô‡∏≤‡∏ó‡∏µ
}      
</script>

<script>
  
    let pingRunning = false;

function startPingSession() {
  if (pingRunning) return;
  pingRunning = true;

  clearInterval(pingTimer);

  pingTimer = setInterval(async () => {
    if (state.mode !== 'admin' || !state.token) {
      clearInterval(pingTimer);
      pingRunning = false;
      return;
    }

    try {
      await apiPing();
    } catch (e) {
      if (!sessionExpiredHandled) {
        sessionExpiredHandled = true;
        alert('Session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ login ‡πÉ‡∏´‡∏°‡πà');
        logoutAdmin();
      }
    }
  }, 5 * 60 * 1000);
}

 </script>
  

  <!-- ========================= -->
<!-- API CONFIG -->
<!-- ========================= -->
<script>
  const API_URL = 'https://script.google.com/macros/s/AKfycby8s440W72bqx8khrsDZnCo0FQelouKbs8bdFoNfqDkUPfXwdshGg16K3sbJbxRKArf3A/exec';

  // ‚úÖ STEP 29.1 ‚Äî Client Signature
  const CLIENT_KEY = 'stockbuilder-v1';
</script>


  <!-- ========================= -->
<!-- STATE INIT -->
<!-- ========================= -->
<script>
  function initState() {
  const savedToken = localStorage.getItem('admin_token');
  const savedRole  = localStorage.getItem('admin_role');
  const savedUser  = localStorage.getItem('admin_username');
    const savedOrders = localStorage.getItem('pendingOrders');
if (savedOrders) {
  state.pendingOrders = JSON.parse(savedOrders);
}

  if (savedToken && savedRole && savedUser) {
    state.mode = 'admin';
    state.token = savedToken;
    state.role = savedRole;
    state.username = savedUser;

    startSessionWatcher(); // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ
    startPingSession();   // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°
  } else {
    state.mode = 'viewer';
    state.token = null;
    state.role = 'viewer';
    state.username = null;
  }
}

  async function logoutAdmin() {
  if (state.submittingAuth) return;
  state.submittingAuth = true;

  showGlobalLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö');

  try {
    if (state.token) {
      try { await apiLogout(); } catch {}
    }

    clearInterval(sessionTimer);
    clearInterval(pingTimer);

    localStorage.removeItem('admin_token');
    localStorage.removeItem('admin_role');
    localStorage.removeItem('admin_username');
    localStorage.removeItem('admin_login_time');

    state.mode = 'viewer';
    state.token = null;
    state.role = 'viewer';
    state.username = null;
    state.error = null;

    sessionExpiredHandled = false;
    renderUI();
  } finally {
    state.submittingAuth = false;
    hideGlobalLoading();
  }
}

</script>


<!-- ========================= -->
<!-- API FUNCTIONS -->
<!-- ========================= -->
<script>
 async function apiRequest(action, payload = {}) {
  try {
    const controller = new AbortController();
    setTimeout(() => controller.abort(), 15000);

    const res = await fetch(API_URL, {
      method: 'POST',
      signal: controller.signal,
      body: JSON.stringify({
        action,
        token: state.token,
        payload,
        clientKey: CLIENT_KEY
      })
    });

    const data = await res.json();
    if (!data.success) throw new Error(data.message);
    return data.data;

  } catch (err) {
    // ‚è±Ô∏è timeout
    if (err.name === 'AbortError') {
      if (state.mode === 'admin' && !state.submittingAuth) {
        showToast('‚è±Ô∏è ‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ï‡∏≠‡∏ö‡∏ä‡πâ‡∏≤', 'error');
      }
      return null;
    }

    // üîê token ‡∏´‡∏°‡∏î / logout ‡πÅ‡∏•‡πâ‡∏ß ‚Üí ‡πÄ‡∏á‡∏µ‡∏¢‡∏ö
    if (err.message === 'Unauthorized') {
      if (state.mode === 'admin') logoutAdmin();
      return null;
    }

    // ‚ùå network error
    console.error(err);

    // üëâ ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô admin ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á
    if (state.mode === 'admin' && !state.submittingAuth) {
      showToast('‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ', 'error');
    }

    return null;
  }
}
  /* ===== API WRAPPERS ===== */

  function apiListProducts() {
    return apiRequest('list');
  }

  function apiLogin(username, password) {
    return apiRequest('login', { username, password });
  }

  function apiAddProduct(product) {
    return apiRequest('add', product);
  }

  function apiUpdateProduct(product) {
    return apiRequest('update', product);
  }

  function apiUpdateStock(code, diff) {
    return apiRequest('updateStock', { code, diff });
  }

  function apiStockHistory(code) {
    return apiRequest('stockHistory', { code });
  }
  
  function apiDashboardSummary() {
    return apiRequest('dashboardSummary');
  }

  function apiListLogs(filters = {}) {
    return apiRequest('listLogs', filters);
  }

  function apiLogout() {
  return apiRequest('logout');
  }

  function apiForceLogout(username) {
  return apiRequest('forceLogout', { username });
  }

  function apiPing() {
  return apiRequest('ping');
  }



  function apiResetPassword(username, newPassword) {
  return apiRequest('resetPassword', {
    username,
    newPassword
  });
}

function apiChangePassword(oldPassword, newPassword) {
  return apiRequest('changePassword', {
    oldPassword,
    newPassword
  });
}

</script>
    
<script>
  /* ===== USER MANAGEMENT (STEP 4.1) ===== */

  /* =========================
   USER MANAGEMENT UI
========================= */

async function renderUserManagement() {
  if (state.role !== 'admin') return;

  const app = document.getElementById('app');
  app.innerHTML = `
    <div class="header">
      <h1>üë• User Management</h1>
      <button class="badge" onclick="renderUI()">Back</button>
    </div>
    <div id="user-list"></div>
  `;

  const users = await apiListUsers();
  if (!users) return;

  const list = document.getElementById('user-list');
  list.innerHTML = '';

  users.forEach(u => {
  const isSelf = u.username === state.username;
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <b>${u.username}</b><br/>
      <select
  ${isSelf ? 'disabled' : ''}
  onchange="changeUserRole('${u.username}', this.value)">
        ${['viewer','staff','admin']
          .map(r => `<option value="${r}" ${u.role===r?'selected':''}>${r}</option>`)
          .join('')}
          </select>

    <button
  style="margin-top:8px"
  onclick="openResetPassword('${u.username}')">
  üîë Reset Password
</button>

${u.username !== state.username ? `
<button
  style="margin-top:8px;background:#ef4444;color:white"
  onclick="confirmForceLogout('${u.username}')">
  üö™ Force Logout
</button>
` : ''}
  `;

    list.appendChild(card);
  });
}

async function changeUserRole(username, role) {
  const ok = confirm(`‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô ${username} ‡πÄ‡∏õ‡πá‡∏ô ${role}?`);
  if (!ok) return;

  if (state.submittingAuth) return;

  let res = null;
  try {
    state.submittingAuth = true;
    res = await apiUpdateUserRole(username, role);
  } finally {
    state.submittingAuth = false;
  }

  if (res) {
    alert('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
    renderUserManagement();
  }
}

  function apiListUsers() {
    return apiRequest('listUsers');
  }

  function apiUpdateUserRole(username, role) {
    return apiRequest('updateUserRole', { username, role });
  }

  function openResetPassword(username) {
  const app = document.getElementById('app');

  app.innerHTML = `
    <div class="header">
      <h1>üîë Reset Password</h1>
      <button class="badge" onclick="renderUserManagement()">Back</button>
    </div>

    <div class="card">
      <p>User: <b>${username}</b></p>

      <input
        id="new-pass"
        type="password"
        placeholder="New password (min 8 chars)"
        style="width:100%;padding:10px;margin-top:8px"
      />

      <button
        style="margin-top:12px;width:100%;padding:12px;background:#38bdf8"
        onclick="submitResetPassword('${username}')">
        Reset Password
      </button>
    </div>
  `;
}

  async function submitResetPassword(username) {
  const pass = document.getElementById('new-pass').value;

  if (!pass || pass.length < 8) {
    alert('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 8 ‡∏ï‡∏±‡∏ß');
    return;
  }

  const ok = confirm(`‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á ${username}?`);
  if (!ok) return;

  const res = await apiResetPassword(username, pass);

  if (res) {
    alert('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
    renderUserManagement();
  }
}

  async function confirmForceLogout(username) {
  const ok = confirm(`‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö logout ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ${username}?`);
  if (!ok) return;

  const res = await apiForceLogout(username);

  if (res) {
    alert(`‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ${username} ‡∏ñ‡∏π‡∏Å logout ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`);
    renderUserManagement();
  }
}


</script>

    <!-- ===== IMAGE UPLOAD ===== -->
<script>
async function apiUploadImage(file, oldImageUrl = '') {
  try {
    const base64 = await fileToBase64(file);

    const res = await fetch(API_URL, {
      method: 'POST',
      body: JSON.stringify({
        action: 'upload',
        token: state.token,
        clientKey: CLIENT_KEY,
        payload: {
          filename: file.name,
          mimeType: file.type,
          data: base64,

          // ‚úÖ ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
          oldImageUrl: oldImageUrl || ''
        }
      })
    });

    const json = await res.json();
    if (!json.success) throw new Error(json.message);

    return json.data.url;

  } catch (e) {
    alert(e.message || '‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    return null;
  }
}
</script>


    <!-- ===== PRODUCTION HELPERS ===== -->
    <script>
/* =========================
   FILE ‚Üí BASE64 HELPER
========================= */
function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();

    reader.onload = () => {
      const result = reader.result;
      const base64 = result.split(',')[1]; // ‡∏ï‡∏±‡∏î prefix ‡∏≠‡∏≠‡∏Å
      resolve(base64);
    };

    reader.onerror = () => reject(new Error('‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'));
    reader.readAsDataURL(file);
  });
}
</script>

<script>
  function validateProduct(p) {
    if (!p.code) return '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
    if (!p.name || !p.name.trim()) return '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
    if (isNaN(p.price) || p.price < 0) return '‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ú‡∏¥‡∏î';
    if (isNaN(p.stock)) return '‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏ú‡∏¥‡∏î';
    if (!p.category) return '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏°‡∏ß‡∏î';
    return null;
  }

</script>

    
   <script>
/* =========================
   SAFE DOM VALUE HELPER
   (SPA / Prevent null crash)
========================= */
const getVal = (id) => {
  const el = document.getElementById(id);
  return el ? el.value : '';
};
</script>

<!-- ========================= -->
<!-- RENDER FUNCTIONS -->
<!-- ========================= -->
    <script>
/* =========================
   AUDIT LOG TRANSLATOR
========================= */
function translateAction(action) {
  if (!action) return '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥';

  if (action.startsWith('updateStock')) return '‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
  if (action.startsWith('add')) return '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà';
  if (action.startsWith('update')) return '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
  if (action.startsWith('login')) return '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
  if (action.startsWith('logout')) return '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö';

  return action; // fallback
}

function formatLogTime(time) {
  if (!time) return '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤';

  const d = new Date(time);
  if (isNaN(d.getTime())) return '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤';

  return d.toLocaleString('th-TH', {
    dateStyle: 'medium',
    timeStyle: 'short'
  });
}
</script>

    <script>
/* =========================
   IMAGE PREVIEW LIGHTBOX
========================= */
function openImagePreview(url) {
  if (!url) return;

  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  overlay.onclick = () => overlay.remove();

  const card = document.createElement('div');
  card.className = 'modal-card';
  card.onclick = e => e.stopPropagation();

  card.innerHTML = `
    <div class="modal-close" onclick="this.closest('.modal-overlay').remove()">‚úï ‡∏õ‡∏¥‡∏î</div>
    <img
      src="${url}"
      style="
        width:100%;
        max-height:70vh;
        object-fit:contain;
        border-radius:16px;
        background:#020617;
      "
    />
  `;

  overlay.appendChild(card);
  document.body.appendChild(overlay);
}
</script>

    <script>
/* =========================
   THEME TOGGLE (LIGHT / DARK)
========================= */
function setTheme(theme) {
  document.body.setAttribute('data-theme', theme);
  localStorage.setItem('ui_theme', theme);
}

function toggleTheme() {
  const current = document.body.getAttribute('data-theme') || 'light';
  setTheme(current === 'dark' ? 'light' : 'dark');
}

/* ‡πÇ‡∏´‡∏•‡∏î theme ‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤ */
(function initTheme() {
  const saved = localStorage.getItem('ui_theme');
  if (saved) {
    document.body.setAttribute('data-theme', saved);
  }
})();
</script>

    <script>
/* =========================
   GLOBAL LOADING OVERLAY
========================= */
function showGlobalLoading(text = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...') {
  let overlay = document.getElementById('global-loading');
  if (overlay) return;

  overlay = document.createElement('div');
  overlay.id = 'global-loading';
  overlay.style = `
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.55);
    display:flex;
    align-items:center;
    justify-content:center;
    z-index:10000;
  `;

  overlay.innerHTML = `
    <div class="card" style="text-align:center">
      <div class="spinner" style="margin:0 auto 12px"></div>
      <b>${text}</b>
    </div>
  `;

  document.body.appendChild(overlay);
}

function hideGlobalLoading() {
  document.getElementById('global-loading')?.remove();
}
</script>

    <script>
function showToast(text, type = 'success') {
  const div = document.createElement('div');
  div.textContent = text;

  div.style = `
    position:fixed;
    bottom:24px;
    left:50%;
    transform:translateX(-50%);
    padding:14px 24px;
    border-radius:999px;
    background:${
      type === 'success'
        ? 'linear-gradient(90deg,#fff5f9,#f3b6c8)'
        : 'linear-gradient(90deg,#fda4af,#fb7185)'
    };
    color:#6b2239;
    font-weight:800;
    box-shadow:0 0 32px rgba(243,182,200,.9);
    z-index:9999;
  `;

  document.body.appendChild(div);
  setTimeout(() => div.remove(), 2200);
}
</script>

 <script>
function showConfirm({ title, message, type = 'out', onConfirm }) {
  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay';

  const card = document.createElement('div');
  card.className = 'modal-card';

  card.innerHTML = `
    <h3>${title}</h3>
    <p style="margin:10px 0">${message}</p>

    <div class="action-row">
  <button class="admin-stock-btn" id="confirmBtn">
    <span class="loading-btn-content">
      <span class="btn-text">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</span>
    </span>
  </button>
  <button class="badge" id="cancelBtn">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
</div>
  `;

  const confirmBtn = card.querySelector('#confirmBtn');
  const cancelBtn = card.querySelector('#cancelBtn');
  const textSpan = card.querySelector('.btn-text');

  confirmBtn.onclick = async () => {
    confirmBtn.classList.add('loading-btn');
    cancelBtn.disabled = true;

    textSpan.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';

    const spinner = document.createElement('div');
    spinner.className = 'spinner ' + (type === 'in' ? 'in' : 'out');
    textSpan.before(spinner);

    try {
      await onConfirm();
    } finally {
      overlay.remove();
    }
  };

  cancelBtn.onclick = () => overlay.remove();

  overlay.appendChild(card);
  document.body.appendChild(overlay);
}
</script>


<script>
function openOrderSlip(p) {
  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  overlay.onclick = () => overlay.remove();

  const card = document.createElement('div');
  card.className = 'modal-card';
  card.onclick = e => e.stopPropagation();

  card.innerHTML = `
  <h3 style="margin-bottom:12px">üßæ ‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h3>

  <img
  src="${p.image || ''}"
  style="
    width:100%;
    aspect-ratio:1/1;
    object-fit:contain;
    border-radius:14px;
    background:#020617;
    margin-bottom:12px;
  "
/>

  <p><b>${p.name}</b></p>
  <p style="font-size:0.8rem;color:#94a3b8">
    ‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: ${p.code}
  </p>

  <input
    id="order-by"
    placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡∏±‡πà‡∏á / ‡∏£‡πâ‡∏≤‡∏ô / ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤"
    style="width:100%;padding:12px;margin:10px 0;border-radius:12px;border:none;"
  />

  <input
    id="order-note"
    placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)"
    style="width:100%;padding:12px;margin-bottom:10px;border-radius:12px;border:none;"
  />

  <input
    id="order-qty"
    type="number"
    min="1"
    placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á"
    style="width:100%;padding:12px;margin-bottom:12px;border-radius:12px;border:none;"
  />

  <button
    class="admin-stock-btn"
    style="width:100%"
    onclick="createOrderSlip(${JSON.stringify(p).replace(/"/g,'&quot;')})">
    üìÑ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
  </button>
`;

  overlay.appendChild(card);
  document.body.appendChild(overlay);
}

async function createOrderSlip(p) {
  const qty = Number(document.getElementById('order-qty').value);
  const by = document.getElementById('order-by').value.trim();
  const note = document.getElementById('order-note').value.trim();

  if (!by) {
    showToast('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡∏±‡πà‡∏á', 'error');
    return;
  }
  if (!qty || qty <= 0) {
    showToast('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô', 'error');
    return;
  }
  if (qty > p.stock) {
    showToast('‚ùå ‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏û‡∏≠', 'error');
    return;
  }

  const order = {
    id: 'ORD-' + Date.now(),
    code: p.code,
    name: p.name,
    qty,
    image: p.image || '',
    orderedBy: by,
    note,
    createdAt: Date.now()
  };

  // ‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
  state.pendingOrders.push(order);
  localStorage.setItem('pendingOrders', JSON.stringify(state.pendingOrders));

  // ‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏û‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠
  await generateOrderSlipImage(order);

  document.querySelector('.modal-overlay')?.remove();
  showToast('üßæ ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏•‡πâ‡∏ß');
}

/* =========================
   ORDER SLIP IMAGE (CANVAS)
========================= */
  async function ensureFontLoaded() {
  if (document.fonts) {
    await document.fonts.load('14px Sarabun');
    await document.fonts.load('bold 22px Sarabun');
  }
}
  
async function generateOrderSlipImage(order) {
  await ensureFontLoaded();

  const canvas = document.createElement('canvas');
  canvas.width = 360;
  canvas.height = 560;
  const ctx = canvas.getContext('2d');

  /* ===== BACKGROUND (Luxury Dark Rose) ===== */
  const bg = ctx.createLinearGradient(0, 0, 0, canvas.height);
  bg.addColorStop(0, '#f8dce6');
  bg.addColorStop(1, '#b76e79');
  ctx.fillStyle = bg;
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  /* ===== CARD ===== */
  roundRect(ctx, 18, 18, 324, 524, 22, true);
  ctx.fillStyle = 'rgba(255,255,255,0.92)';
  ctx.fill();

  /* ===== TITLE ===== */
  ctx.fillStyle = '#7a2e44';
  ctx.font = 'bold 22px Sarabun';
  ctx.textAlign = 'center';
  ctx.fillText('‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠', canvas.width / 2, 52);

  /* ===== IMAGE ===== */
  if (order.image) {
    const img = await loadImage(order.image);
    ctx.drawImage(img, 100, 72, 160, 160);
  }

  /* ===== TEXT ===== */
  ctx.textAlign = 'left';
  let y = 260;

  ctx.fillStyle = '#1f2937';        // ‡∏ï‡∏±‡∏ß‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏´‡∏•‡∏±‡∏Å (‡∏ä‡∏±‡∏î‡∏°‡∏≤‡∏Å)
  ctx.font = 'bold 16px Sarabun';
  ctx.fillText(`‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: ${order.name}`, 36, y);
  y += 30;

  ctx.font = '14px Sarabun';
  ctx.fillStyle = '#374151';
  ctx.fillText(`‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: ${order.code}`, 36, y);
  y += 26;

  ctx.fillText(`‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏±‡πà‡∏á: ${order.qty} ‡∏ä‡∏¥‡πâ‡∏ô`, 36, y);
  y += 26;

  /* ===== DATE ===== */
  ctx.fillStyle = '#7a2e44';
  ctx.font = '13px Sarabun';
  ctx.fillText(
    `‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${new Date(order.createdAt).toLocaleString('th-TH')}`,
    36,
    y + 10
  );

  /* ===== DOWNLOAD ===== */
  const link = document.createElement('a');
  link.download = `ORDER_${order.code}_${order.createdAt}.png`;
  link.href = canvas.toDataURL('image/png');
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}



/* ===== LOAD IMAGE (CORS SAFE) ===== */
async function loadImage(url) {
  // üîê ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏õ‡πá‡∏ô blob ‡∏Å‡πà‡∏≠‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á CORS
  const res = await fetch(url);
  const blob = await res.blob();

  const objectUrl = URL.createObjectURL(blob);

  return new Promise((resolve, reject) => {
    const img = new Image();
    img.onload = () => {
      URL.revokeObjectURL(objectUrl);
      resolve(img);
    };
    img.onerror = reject;
    img.src = objectUrl;
  });
}


/* ===== Helper: Rounded Rect ===== */
function roundRect(ctx, x, y, w, h, r, fill, stroke) {
  ctx.beginPath();
  ctx.moveTo(x + r, y);
  ctx.lineTo(x + w - r, y);
  ctx.quadraticCurveTo(x + w, y, x + w, y + r);
  ctx.lineTo(x + w, y + h - r);
  ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
  ctx.lineTo(x + r, y + h);
  ctx.quadraticCurveTo(x, y + h, x, y + h - r);
  ctx.lineTo(x, y + r);
  ctx.quadraticCurveTo(x, y, x + r, y);
  ctx.closePath();
  if (fill) ctx.fill();
  if (stroke) ctx.stroke();
}
</script>


<script>
function openStockAdjustModal(code) {
  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  overlay.onclick = () => overlay.remove();

  const card = document.createElement('div');
  card.className = 'modal-card';
  card.onclick = e => e.stopPropagation();

  card.innerHTML = `
    <h3>üì¶ ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å (${code})</h3>

    <select id="stock-type" style="width:100%;padding:10px;margin-top:8px">
      <option value="in">üì• ‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤</option>
      <option value="out">üì§ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å</option>
    </select>

    <input
      id="stock-qty"
      type="number"
      min="1"
      placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô"
      style="width:100%;padding:10px;margin-top:8px"
    />

   <button
  class="admin-stock-btn"
  style="margin-top:12px;width:100%"
  onclick="submitStockAdjust('${code}')">
  ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
</button>
  `;

  overlay.appendChild(card);
  document.body.appendChild(overlay);
}

async function submitStockAdjust(code) {
  const type = document.getElementById('stock-type').value;
  const qty = Number(document.getElementById('stock-qty').value);

  if (!qty || qty <= 0) {
    showToast('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
    return;
  }

  const diff = type === 'in' ? qty : -qty;
  document.querySelector('.modal-overlay')?.remove();
  
  showConfirm({
    title: 'üì¶ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏ï‡πä‡∏≠‡∏Å',
    message: `
      <div style="text-align:center">
        <b>${type === 'in' ? '‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤' : '‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å'}</b><br/>
        ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô <b>${qty}</b> ‡∏ä‡∏¥‡πâ‡∏ô
      </div>
    `,
    onConfirm: async () => {
      await adjustStock(code, diff);
    }
  });
}
</script>

    
    <script>
/* =========================
   SEARCH FIX (NO FULL RERENDER)
========================= */

let searchTimer = null;

function onSearch(value) {
  state.search = value;

  clearTimeout(searchTimer);
  searchTimer = setTimeout(() => {
    applyFilter();
    renderProductGridOnly(); // ‚úÖ render ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ grid
  }, 150);
}

function renderProductGridOnly() {
  const container =
    document.querySelector('.grid') ||
    document.querySelector('.card'); // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö empty state

  if (!container) return;

  const newView = renderProductGrid();
  container.replaceWith(newView);
}
</script>
    
<script>
function toggleSidebar() {
  const sidebar = document.getElementById('sidebar');
  const isOpen = sidebar.classList.toggle('show');

  if (isOpen) {
    if (!document.getElementById('sidebar-bg')) {
      const bg = document.createElement('div');
      bg.className = 'sidebar-backdrop';
      bg.id = 'sidebar-bg';
      bg.onclick = toggleSidebar;
      document.body.appendChild(bg);
    }
  } else {
    document.getElementById('sidebar-bg')?.remove();
  }
}
</script>

    
<script>
function openProductDetail(p) {
  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  overlay.onclick = () => overlay.remove();

  const card = document.createElement('div');
  card.className = 'modal-card';
  card.onclick = e => e.stopPropagation(); // ‡∏Å‡∏±‡∏ô‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏∞‡∏•‡∏∏

  card.innerHTML = `
    <div class="modal-close" onclick="this.closest('.modal-overlay').remove()">
      ‚úï ‡∏õ‡∏¥‡∏î
    </div>

    <img
  src="${p.image || ''}"
  style="
    width:100%;
    aspect-ratio:1/1;
    object-fit:contain;
    border-radius:14px;
    background:#020617;
    margin-bottom:12px;
  "
/>

    <h3 style="margin:4px 0">${p.name}</h3>

    <div class="product-price">
  üí∞ ‡∏ø${p.price}
</div>


    <p>üì¶ ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: <b>${p.stock}</b></p>
    <p>üè∑Ô∏è ‡∏´‡∏°‡∏ß‡∏î: ${p.category}</p>
    <p>üöö ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${p.status || '-'}</p>

    <p style="font-size:0.75rem;color:#94a3b8">
      ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:
      ${p.updatedAt
        ? new Date(p.updatedAt).toLocaleString('th-TH')
        : '-'}
    </p>
  `;

  overlay.appendChild(card);
  document.body.appendChild(overlay);
}
</script>

    
<script>
  /* =========================
     VIEWER SUPPORT
  ========================= */
async function adjustStock(code, diff) {
  if (state.submittingStock) return;
  state.submittingStock = true;

  try {
    const res = await apiUpdateStock(code, diff);
    if (!res) throw new Error();

    const p = state.products.find(p => p.code === code);
    if (p) {
      p.stock += diff;
      p.updatedAt = Date.now();
    }

    showToast('üì¶ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß');
  } catch {
    showToast('‚ùå ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
  } finally {
    state.submittingStock = false;
    renderUI();
  }
}
  
  async function loadProducts() {
  if (state.productsLoaded) return; // ‚úÖ ‡∏Å‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏ã‡πâ‡∏≥

  state.loading = true;
  renderUI();

  const data = await apiListProducts();

  state.products = Array.isArray(data) ? data : [];
  applyFilter();

  state.loading = false;
  state.productsLoaded = true; // ‚úÖ ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
  renderUI();
}


  function applyFilter() {
    state.filteredProducts = state.products.filter(p => {
      const keyword = state.search.toLowerCase();

const matchSearch =
  p.name.toLowerCase().includes(keyword) ||
  p.code.toLowerCase().includes(keyword);

      const matchCategory =
  state.category === 'all' ||
  p.category.toLowerCase() === state.category.toLowerCase();
      return matchSearch && matchCategory;
    });
  }

 
  function onFilterCategory(value) {
  state.category = value;
  applyFilter();
  renderProductGridOnly(); // ‚úÖ ‡πÑ‡∏°‡πà render ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏ô‡πâ‡∏≤
}

  function renderCategoryOptions() {
    const categories = [
  ...new Set(state.products.map(p => p.category.toLowerCase()))
];
    return categories.map(c => `<option value="${c}">${c}</option>`).join('');
  }

/* =========================
   DASHBOARD (STEP 15)
========================= */

async function renderDashboard() {

  // üîê ROLE GUARD ‚Äî ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô admin ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
  if (state.role !== 'admin') {
    alert('‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠');
    return;
  }

  const app = document.getElementById('app');
  app.innerHTML = '';

  const header = document.createElement('div');
  header.className = 'header';
  header.innerHTML = `
    <h1>üìä Dashboard</h1>
    <button class="badge" onclick="renderUI()">Back</button>
  `;
  app.appendChild(header);

  const card = document.createElement('div');
  card.className = 'card';
  card.innerHTML = `<p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>`;
  app.appendChild(card);

  const data = await apiDashboardSummary();
  if (!data) return;

  card.innerHTML = `
    <p>üì¶ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤: <b>${data.totalProducts}</b></p>
    <p>üìä ‡∏™‡∏ï‡πä‡∏≠‡∏Å‡∏£‡∏ß‡∏°: <b>${data.totalStock}</b></p>
    <p>‚ö†Ô∏è ‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î: <b>${data.lowStock}</b></p>
    <p>üí∞ ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡∏™‡∏ï‡πä‡∏≠‡∏Å: <b>‡∏ø${data.stockValue}</b></p>
  `;

  drawDashboardChart(data.history || []);
}

function drawDashboardChart(history) {
  if (!history.length) return;

  const canvas = document.createElement('canvas');
  canvas.width = 300;
  canvas.height = 200;

  const card = document.createElement('div');
  card.className = 'card';
  card.appendChild(canvas);
  document.getElementById('app').appendChild(card);

  const ctx = canvas.getContext('2d');
  const padding = 30;

  const max = Math.max(...history.map(h => h.totalStock));
  const min = Math.min(...history.map(h => h.totalStock));
  const xStep = (canvas.width - padding * 2) / (history.length - 1 || 1);
  const yScale = (canvas.height - padding * 2) / (max - min || 1);

  /* ===== ROSE GOLD LINE ===== */
  ctx.strokeStyle = '#b76e79';
  ctx.lineWidth = 3;
  ctx.shadowColor = '#f3b6c8';
  ctx.shadowBlur = 10;

  ctx.beginPath();
  history.forEach((p, i) => {
    const x = padding + i * xStep;
    const y = canvas.height - padding - (p.totalStock - min) * yScale;
    if (i === 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  });
  ctx.stroke();

  /* ===== ROSE GOLD DOTS ===== */
  ctx.fillStyle = '#b76e79';
  ctx.shadowBlur = 0;

  history.forEach((p, i) => {
    const x = padding + i * xStep;
    const y = canvas.height - padding - (p.totalStock - min) * yScale;
    ctx.beginPath();
    ctx.arc(x, y, 4, 0, Math.PI * 2);
    ctx.fill();
  });
}

  /* =========================
     ADMIN LOGIN
  ========================= */

  function renderAdminLogin() {
    const app = document.getElementById('app');
    app.innerHTML = '';

    const header = document.createElement('div');
    header.className = 'header';
    header.innerHTML = `
      <h1>üîê Admin Login</h1>
      <button class="badge" onclick="renderUI()">Back</button>
    `;

    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <input id="login-user" placeholder="Username"
        style="width:100%;padding:10px;margin-bottom:8px;" />
      <input id="login-pass" type="password" placeholder="Password"
        style="width:100%;padding:10px;margin-bottom:8px;" />
      <button onclick="submitLogin()"
        style="width:100%;padding:12px;background:#38bdf8;">
        Login
      </button>
    `;

    app.appendChild(header);
    app.appendChild(card);
  }

  async function submitLogin() {
  if (state.submittingAuth) return;
  state.submittingAuth = true;

  showGlobalLoading('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö');

  try {
    const u = document.getElementById('login-user').value;
    const p = document.getElementById('login-pass').value;

    const data = await apiLogin(u, p);
    if (!data) return;

    const now = Date.now();
    localStorage.setItem('admin_token', data.token);
    localStorage.setItem('admin_role', data.role);
    localStorage.setItem('admin_username', u.toLowerCase());
    localStorage.setItem('admin_login_time', now);

    state.token = data.token;
    state.role = data.role;
    state.username = u.toLowerCase();
    state.mode = 'admin';

    sessionExpiredHandled = false;
    startSessionWatcher();
    startPingSession();

    renderUI();
  } finally {
    state.submittingAuth = false;
    hideGlobalLoading();
  }
}


   function renderChangePassword() {
  const app = document.getElementById('app');
  app.innerHTML = `
    <div class="header">
      <h1>üîë ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</h1>
      <button class="badge" onclick="renderUI()">Back</button>
    </div>

    <div class="card">
      <input
        id="old-pass"
        type="password"
        placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏î‡∏¥‡∏°"
        style="width:100%;padding:10px;margin-bottom:8px;"
      />

      <input
        id="new-pass"
        type="password"
        placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 8 ‡∏ï‡∏±‡∏ß)"
        style="width:100%;padding:10px;margin-bottom:8px;"
      />

      <button
        style="width:100%;padding:12px;background:#38bdf8;"
        onclick="submitChangePassword()">
        ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
      </button>
    </div>
  `;
}

  async function submitChangePassword() {
  const oldPass = document.getElementById('old-pass').value;
  const newPass = document.getElementById('new-pass').value;

  if (!oldPass || !newPass) {
    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö');
    return;
  }

  if (newPass.length < 8) {
    alert('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 8 ‡∏ï‡∏±‡∏ß');
    return;
  }

  const ok = confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô?');
  if (!ok) return;

  const res = await apiChangePassword(oldPass, newPass);

  if (res) {
    alert('‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ login ‡πÉ‡∏´‡∏°‡πà');
    logoutAdmin(); // üîê backend clear token ‡πÅ‡∏•‡πâ‡∏ß ‚Üí logout ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    sessionExpiredHandled = false; // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°
    
  }
}

  /* =========================
     MAIN RENDER
  ========================= */

  function renderUI() {
  const app = document.getElementById('app');
  app.innerHTML = '';

  try {
    if (state.mode === 'viewer') renderViewer(app);
    if (state.mode === 'admin') renderAdmin(app);
  } catch (e) {
    console.error(e);
    app.innerHTML = `
      <div class="card">
        ‚ùå ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤
      </div>
    `;
  }
}
  /* =========================
     VIEWER
  ========================= */

  async function renderViewer(root) {
    const header = document.createElement('div');
header.className = 'header';
header.innerHTML = `
  <div class="brand-title">
    ‚≠ê ‡∏•‡πâ‡∏≠‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå ‚≠ê
  </div>
  <div class="header-actions">
    <button class="badge" onclick="toggleTheme()">üåô</button>
    <button class="badge" onclick="renderAdminLogin()">Admin</button>
  </div>
`;
root.appendChild(header);

    if (state.loading) return root.appendChild(renderLoading());
    if (state.error && state.mode !== 'viewer') {
  return root.appendChild(renderError());
}
    if (!state.productsLoaded) {
  await loadProducts();
  return;
}
 

    const searchCard = document.createElement('div');
    searchCard.className = 'card';
    searchCard.innerHTML = `
      <input placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤..."
        value="${state.search}"
        oninput="onSearch(this.value)"
        style="width:100%;padding:10px;border-radius:12px;border:none;" />
      <select onchange="onFilterCategory(this.value)"
        style="width:100%;margin-top:10px;padding:10px;border-radius:12px;border:none;">
        <option value="all">‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏ß‡∏î</option>
        ${renderCategoryOptions()}
      </select>
    `;
    root.appendChild(searchCard);
    root.appendChild(renderProductGrid());
  }

  /* =========================
   CATEGORY ‚Üí COLOR CLASS
========================= */
function getCategoryClass(category = '') {
  const c = category.toLowerCase();

  if (c.includes('‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤')) return 'code-bag';
  if (c.includes('‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏î‡∏±‡∏ö')) return 'code-jewelry';
  if (c.includes('‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ')) return 'code-utility';
  if (c.includes('‡∏ï‡∏∏‡πä‡∏Å‡∏ï‡∏≤') || c.includes('‡∏ü‡∏¥‡∏Å')) return 'code-doll';

  return 'code-other';
}
  function renderProductGrid() {
  // =========================
  // STEP 2.5 ‚Äî EMPTY / SEARCH UX
  // =========================

  // ‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏•‡∏¢
  if (state.products.length === 0) {
    const div = document.createElement('div');
    div.className = 'card empty-state';
    div.style.textAlign = 'center';
    div.innerHTML = `
      <div style="font-size:2rem">üõçÔ∏è</div>
      <b>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</b>
      <p style="margin-top:6px">
        ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
      </p>
    `;
    return div;
  }

  // üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ / ‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠
  if (state.filteredProducts.length === 0) {
    const div = document.createElement('div');
    div.className = 'card empty-state';
    div.style.textAlign = 'center';
    div.innerHTML = `
      <div style="font-size:2rem">üîç</div>
      <b>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</b>
      <p style="margin-top:6px">
        ‡∏•‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏≠‡∏∑‡πà‡∏ô
      </p>
    `;
    return div;
  }


  // =========================
  // NORMAL GRID (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
  // =========================
  const grid = document.createElement('div');
  grid.className = 'grid';

  state.filteredProducts.forEach(p => {
    const card = document.createElement('div');
    card.className = 'product-card';
    card.onclick = () => openProductDetail(p);

    const cls = getCategoryClass(p.category);

    card.innerHTML = `
      <div class="product-img"
        style="background-image:url('${p.image || ''}');">
      </div>

      <div class="product-name">${p.name}</div>

      <div class="product-code ${cls}">
        üÜî ${p.code}
      </div>

      <div class="product-category ${cls}">
        üè∑Ô∏è ${p.category}
      </div>

     <div class="product-price">
  üí∞ ‡∏ø${p.price}
</div>

      <div class="product-meta">
        <div class="meta-pill">
          üì¶ ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${p.stock}
        </div>
        <div class="meta-pill">
          üöö ${p.status || '-'}
        </div>
      </div>

      <div
        class="order-fab"
        onclick="event.stopPropagation(); openOrderSlip(${JSON.stringify(p).replace(/"/g,'&quot;')})">
        üßæ
      </div>
    `;

    grid.appendChild(card);
  });

  return grid;
}


  /* =========================
     ADMIN DASHBOARD
  ========================= */

  async function renderAdmin(root) {
  const header = document.createElement('div');
  header.className = 'header';
  header.innerHTML = `
    <h1>üßë‚Äçüíº Admin</h1>
    <div class="header-actions">
      <div class="hamburger" onclick="toggleSidebar()">‚ò∞</div>
    </div>
  `;
  root.appendChild(header);

  renderPendingOrders(root);

  if (!state.products.length) {
  const div = document.createElement('div');
  div.className = 'card';
  div.innerHTML = `
    <b>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</b>
    <p>‡∏Å‡∏î ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</p>
  `;
  root.appendChild(div);
  return;
}


  state.products.forEach(p => {
    const card = document.createElement('div');
    card.className = 'card admin';

    card.innerHTML = `
      <div style="display:flex; gap:14px; align-items:center;">
        
        <!-- INFO -->
        <div style="flex:1;">
          <b>${p.name}</b> (${p.code})<br/>
          üì¶ ‡∏™‡∏ï‡πä‡∏≠‡∏Å: <b>${p.stock}</b><br/>
          üöö ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${p.status}<br/><br/>

          <button class="admin-stock-btn"
            onclick="openStockAdjustModal('${p.code}')">
            üì¶ ‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤ / ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
          </button>

          ${state.role === 'admin'
            ? `<button onclick="openProductForm(${JSON.stringify(p).replace(/"/g,'&quot;')})">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>`
            : ''}
        </div>

        <!-- THUMBNAIL -->
        <div
          style="
            width:72px;
            height:72px;
            border-radius:12px;
            background:url('${p.image || ''}') center/contain no-repeat;
            background-color:rgba(255,255,255,0.25);
            border:1px solid rgba(255,255,255,0.5);
          ">
        </div>

      </div>
    `;

    root.appendChild(card);
  });
}


  function renderPendingOrders(root) {
  if (!state.pendingOrders.length) return;

  const box = document.createElement('div');
  box.className = 'card';
  box.innerHTML = `<h3>üïì ‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</h3>`;

  state.pendingOrders.forEach(o => {
    const item = document.createElement('div');
    item.style.marginBottom = '14px';

    item.innerHTML = `
      <div style="display:flex;gap:12px;align-items:center">
        <div style="
          width:64px;
          height:64px;
          background:url('${o.image || ''}') center/contain no-repeat;
          background-color:rgba(255,255,255,.2);
          border-radius:12px">
        </div>

        <div style="flex:1;font-size:.85rem">
          <b>${o.name}</b><br/>
          ‡∏£‡∏´‡∏±‡∏™: ${o.code}<br/>
          ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: <b>${o.qty}</b><br/>
          üë§ ‡∏ú‡∏π‡πâ‡∏™‡∏±‡πà‡∏á: <b>${o.orderedBy}</b><br/>
          ${o.note ? `üìù ${o.note}<br/>` : ''}
          üïí ${new Date(o.createdAt).toLocaleString('th-TH')}
        </div>
      </div>

      <div style="display:flex;gap:8px;margin-top:8px">
        <button
          class="admin-stock-btn"
          onclick="approveOrder('${o.id}')">
          ‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏´‡∏±‡∏Å‡∏™‡∏ï‡πä‡∏≠‡∏Å
        </button>

        <button
          style="background:#ef4444;color:white"
          onclick="rejectOrder('${o.id}')">
          ‚ùå ‡∏•‡∏ö‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á
        </button>
      </div>
    `;

    box.appendChild(item);
  });

  root.appendChild(box);
}
 async function approveOrder(orderId) {
  const order = state.pendingOrders.find(o => o.id === orderId);
  if (!order) return;

  const product = state.products.find(p => p.code === order.code);
  if (!product || product.stock < order.qty) {
    showToast('‚ùå ‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠', 'error');
    return;
  }

  showConfirm({
    title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏´‡∏±‡∏Å‡∏™‡∏ï‡πä‡∏≠‡∏Å',
    message: `
      <div style="text-align:center">
        ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ <b>${order.name}</b><br/>
        ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô <b>${order.qty}</b> ‡∏ä‡∏¥‡πâ‡∏ô
      </div>
    `,
    onConfirm: async () => {
      try {
        await apiUpdateStock(order.code, -order.qty);

        product.stock -= order.qty;
        product.updatedAt = Date.now();

        state.pendingOrders =
          state.pendingOrders.filter(o => o.id !== orderId);

        localStorage.setItem(
          'pendingOrders',
          JSON.stringify(state.pendingOrders)
        );

        showToast('‚úÖ ‡∏´‡∏±‡∏Å‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
        renderUI();
      } catch {
        showToast('‚ùå ‡∏´‡∏±‡∏Å‡∏™‡∏ï‡πä‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
      }
    }
  });
}

function rejectOrder(orderId) {
  const ok = confirm('‡∏•‡∏ö‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ô‡∏µ‡πâ?');
  if (!ok) return;

  state.pendingOrders =
    state.pendingOrders.filter(o => o.id !== orderId);

  localStorage.setItem(
    'pendingOrders',
    JSON.stringify(state.pendingOrders)
  );

  showToast('üóëÔ∏è ‡∏•‡∏ö‡πÉ‡∏ö‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÅ‡∏•‡πâ‡∏ß');
  renderUI();
}

  /* =========================
     PRODUCT FORM
  ========================= */

  function openProductForm(product = null) {
    const app = document.getElementById('app');
    app.innerHTML = '';

    const isEdit = !!product;

    const header = document.createElement('div');
    header.className = 'header';
    header.innerHTML = `
      <h1>${isEdit ? '‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' : '‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'}</h1>
      <button class="badge" onclick="renderUI()">Back</button>
    `;

    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <input id="p-code" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤"
        value="${product?.code || ''}" ${isEdit ? 'disabled' : ''} />
      <input id="p-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" value="${product?.name || ''}" />
      <input id="p-price" type="number" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤" value="${product?.price || ''}" />
      <input id="p-stock" type="number" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô" value="${product?.stock || 0}" />
      <input id="p-category" placeholder="‡∏´‡∏°‡∏ß‡∏î" value="${product?.category || ''}" />

      <select id="p-status">
        ${['‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡πà‡∏á','‡∏´‡∏°‡∏î','‡πÇ‡∏Å‡∏î‡∏±‡∏á‡πÑ‡∏ó‡∏¢','‡∏≠‡∏¢‡∏π‡πà‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏à‡∏±‡∏î‡∏™‡πà‡∏á']
          .map(s => `<option ${product?.status===s?'selected':''}>${s}</option>`).join('')}
      </select>

      <input id="p-image" type="file" accept="image/*" />
      ${product?.image ? `<img src="${product.image}" style="width:100%;border-radius:12px;margin-top:8px;" />` : ''}

      <button
  ${state.submittingForm ? 'disabled' : ''}
  style="margin-top:12px;width:100%;padding:12px;background:#38bdf8;"
  onclick="submitProduct(${isEdit})"
>
  ${isEdit ? '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'}
</button>

    `;
    app.appendChild(header);
    app.appendChild(card);
  }

async function submitProduct(isEdit = false) {
  if (state.submittingForm) return;
  state.submittingForm = true;

  showGlobalLoading(isEdit ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤' : '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤');

  try {
    const code = getVal('p-code');

    const product = {
      code,
      name: getVal('p-name'),
      price: Number(getVal('p-price')),
      stock: Number(getVal('p-stock')),
      category: getVal('p-category'),
      status: getVal('p-status'),
      image: ''
    };

    const err = validateProduct(product);
    if (err) throw new Error(err);

    const file = document.getElementById('p-image')?.files?.[0];
    if (file) {
      const oldImage =
  isEdit
    ? state.products.find(p => p.code === code)?.image || ''
    : '';

const imageUrl = await apiUploadImage(file, oldImage);
      if (!imageUrl) throw new Error('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      product.image = imageUrl;
    } else if (isEdit) {
      product.image =
        state.products.find(p => p.code === code)?.image || '';
    }

    if (isEdit) {
      await apiUpdateProduct(product);
      const i = state.products.findIndex(p => p.code === code);
      if (i !== -1) state.products[i] = { ...state.products[i], ...product };
    } else {
      const saved = await apiAddProduct(product);
      if (saved) state.products.push(saved);
    }

    applyFilter();
    renderUI();

  } catch (e) {
    alert(e.message);
  } finally {
    state.submittingForm = false;
    hideGlobalLoading();
  }
}
  
     
   /* =========================
     COMMON
  ========================= */

  function renderLoading() {
    const div = document.createElement('div');
    div.className = 'card';
    div.innerHTML = `<p>‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>`;
    return div;
  }

  function renderError() {
  if (!state.error) return document.createElement('div');

  const msg = state.error;
  state.error = null;

  const div = document.createElement('div');
  div.className = 'card';
  div.innerHTML = `<p>‚ùå ${msg}</p>`;
  return div;
}

  function exportCSV() {
  if (!state.products.length) {
    alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤');
    return;
  }

  const headers = [
    'code','name','price','stock','category','status','image'
  ];

  const rows = state.products.map(p =>
    headers.map(h =>
      `"${(p[h] ?? '').toString().replace(/"/g,'""')}"`
    ).join(',')
  );

  const csv = [headers.join(','), ...rows].join('\n');

  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);

  const a = document.createElement('a');
  a.href = url;
  a.download = `stock_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();

  URL.revokeObjectURL(url);
}

  
  async function renderAuditLogs() {
  if (state.role !== 'admin') return;

  const app = document.getElementById('app');
  app.innerHTML = '';

  app.innerHTML = `
    <div class="header">
      <h1>üßæ Audit Logs</h1>
      <button class="badge" onclick="renderUI()">Back</button>
    </div>

    <div class="card">
      <input id="log-user" placeholder="username" />
      <input id="log-action" placeholder="action" />
      <input id="log-keyword" placeholder="keyword" />

      <input id="log-from" type="date" />
      <input id="log-to" type="date" />

      <button onclick="loadLogs()">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
    </div>

    <div id="log-list"></div>
  `;

  loadLogs();
}

async function loadLogs() {
  const filters = {
    username: document.getElementById('log-user')?.value,
    action: document.getElementById('log-action')?.value,
    keyword: document.getElementById('log-keyword')?.value,
    dateFrom: document.getElementById('log-from')?.value,
    dateTo: document.getElementById('log-to')?.value
  };

  const logs = await apiListLogs(filters);
  if (!logs) return;

  const list = document.getElementById('log-list');
  list.innerHTML = '';

  logs.forEach(l => {
    const div = document.createElement('div');
    div.className = 'card';

    div.innerHTML = `
      <b>üìå ${translateAction(l.action)}</b><br/>

      üë§ ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: <b>${l.user}</b>
      <span style="opacity:.7">(${l.role})</span><br/>

      üïí ‡πÄ‡∏ß‡∏•‡∏≤: ${formatLogTime(l.time)}<br/>

      ${l.detail ? `
        <small style="opacity:.8">
          üìù ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î: ${l.detail}
        </small>
      ` : ''}
    `;

    /* ‚úÖ ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î‡∏´‡∏≤‡∏¢ */
    list.appendChild(div);
  });
}

 /* =========================
   HEADER SMART SCROLL LOGIC
========================= */
let lastScrollY = 0;

window.addEventListener('scroll', () => {
  const header = document.querySelector('#app .header');
  if (!header) return;

  const currentY = window.scrollY;

  if (currentY > lastScrollY && currentY > 24) {
    header.classList.add('header--compact');
  } else {
    header.classList.remove('header--compact');
  }

  lastScrollY = currentY;
}, { passive: true });
  
</script>
<!-- ========================= -->
<!-- APP START -->
<!-- ========================= -->
<script>
  initState();
  renderUI();
</script>

    <!-- ========================= -->
<!-- ADMIN SIDEBAR -->
<!-- ========================= -->
<div id="sidebar" class="sidebar">
  <h3>üßë‚Äçüíº Admin Menu</h3>

  <!-- ‚ûï ADD NEW PRODUCT -->
  <button
    style="
      background: linear-gradient(90deg,#34d399,#10b981);
      color: #064e3b;
      font-weight: 800;
    "
    onclick="toggleSidebar(); openProductForm()">
    ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà
  </button>

   <button onclick="toggleSidebar(); renderAuditLogs();">
    üßæ Audit Logs
  </button>

  <button onclick="toggleSidebar(); renderUserManagement();">
    üë• User Management
  </button>

  <button onclick="toggleSidebar(); renderChangePassword();">
    üîë ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
  </button>

  <button
    style="background:#ef4444;color:white"
    onclick="toggleSidebar(); logoutAdmin();">
    üö™ Logout
  </button>
</div>

    <!-- =========================
   DARK MODE ‚Äî SINGLE SOURCE (FINAL)
   readable / clean / future-proof
========================= -->
    <!--
<style>
/* ===== BASE ===== */
body[data-theme="dark"] {
  background: var(--bg-main);
  color: var(--text-main);
}

/* ===== TEXT ===== */
body[data-theme="dark"] h1,
body[data-theme="dark"] h2,
body[data-theme="dark"] h3,
body[data-theme="dark"] b {
  color: var(--text-main);
}

body[data-theme="dark"] p,
body[data-theme="dark"] small,
body[data-theme="dark"] label,
body[data-theme="dark"] .meta-pill,
body[data-theme="dark"] .product-code,
body[data-theme="dark"] .product-category {
  color: var(--text-muted) !important;
}

/* ===== CARD / MODAL / SIDEBAR ===== */
body[data-theme="dark"] .card,
body[data-theme="dark"] .modal-card,
body[data-theme="dark"] .sidebar {
  background: linear-gradient(
    180deg,
    rgba(30,30,50,0.65),
    rgba(20,20,40,0.45)
  );
  border-color: rgba(255,255,255,0.12);
}

/* ===== BUTTON / BADGE / HAMBURGER ===== */
body[data-theme="dark"] button,
body[data-theme="dark"] .badge,
body[data-theme="dark"] .hamburger {
  background: linear-gradient(
    160deg,
    rgba(255,255,255,0.18),
    rgba(255,255,255,0.05)
  );
  color: var(--text-main);
  border-color: rgba(255,255,255,0.18);
}

/* ===== INPUT ===== */
body[data-theme="dark"] input,
body[data-theme="dark"] select,
body[data-theme="dark"] textarea {
  background: rgba(255,255,255,0.08);
  color: var(--text-main);
  border: 1px solid rgba(255,255,255,0.18);
}

body[data-theme="dark"] input::placeholder {
  color: rgba(248,250,252,0.45);
}

/* ===== CATEGORY BADGE ===== */
body[data-theme="dark"] .code-bag,
body[data-theme="dark"] .code-jewelry,
body[data-theme="dark"] .code-utility,
body[data-theme="dark"] .code-doll,
body[data-theme="dark"] .code-other {
  background: rgba(255,255,255,0.12);
  color: var(--text-main);
  box-shadow: none;
}

/* ===== ORDER FAB ===== */
body[data-theme="dark"] .order-fab {
  background: linear-gradient(
    135deg,
    rgba(255,255,255,0.2),
    rgba(167,139,250,0.35)
  );
  color: var(--text-main);
  box-shadow: 0 0 22px rgba(167,139,250,.65);
}

body[data-theme="dark"] .order-fab::after {
  background: rgba(255,255,255,0.14);
  color: var(--text-main);
}

/* ===== SPINNER ===== */
body[data-theme="dark"] .spinner {
  border-color: rgba(255,255,255,0.25);
  border-top-color: var(--primary-gold);
}

/* ===== OVERLAY ===== */
body[data-theme="dark"] .modal-overlay {
  background: rgba(0,0,0,0.7);
  backdrop-filter: blur(8px);
}

/* ===== INLINE COLOR CLEANUP ===== */
body[data-theme="dark"] [style*="color:#94a3b8"],
body[data-theme="dark"] [style*="color:#6b2239"],
body[data-theme="dark"] [style*="color:#7a2e44"],
body[data-theme="dark"] [style*="color:#334155"] {
  color: var(--text-muted) !important;
}
</style>
    -->

    <!-- =========================
   DARK MODE ‚Äî FINAL POLISH
   text contrast / toast / edge case
========================= -->
    <!--
<style>

/* ===== TOAST FIX ===== */
body[data-theme="dark"] div[style*="linear-gradient(90deg,#fff5f9"] {
  background: linear-gradient(
    160deg,
    rgba(255,255,255,0.18),
    rgba(167,139,250,0.35)
  ) !important;
  color: var(--text-main) !important;
  box-shadow: 0 0 26px rgba(167,139,250,.75) !important;
}

/* ===== EMPTY / HINT TEXT ===== */
body[data-theme="dark"] .empty-state p {
  color: var(--text-muted);
}

/* ===== MODAL SMALL TEXT ===== */
body[data-theme="dark"] .modal-card p {
  color: var(--text-muted);
}

/* ===== FORCE INLINE TEXT (EXTRA SAFE) ===== */
body[data-theme="dark"] [style*="color:#94a3b8"],
body[data-theme="dark"] [style*="color:#6b2239"],
body[data-theme="dark"] [style*="color:#7a2e44"] {
  color: var(--text-muted) !important;
}

</style>
    -->
<!--
<style>
    /* =========================
   DARK MODE ‚Äî READABILITY BOOST
   (FINAL SAFE OVERRIDE)
========================= */

/* ---------- TEXT HIERARCHY ---------- */
body[data-theme="dark"] {
  color: #f8fafc; /* main text */
}

body[data-theme="dark"] b,
body[data-theme="dark"] strong,
body[data-theme="dark"] h1,
body[data-theme="dark"] h2,
body[data-theme="dark"] h3 {
  color: #ffffff;
}

/* ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏≠‡∏á */
body[data-theme="dark"] p,
body[data-theme="dark"] small,
body[data-theme="dark"] label,
body[data-theme="dark"] .meta-pill {
  color: rgba(248,250,252,0.7) !important;
}

/* ---------- PRODUCT CARD ---------- */
body[data-theme="dark"] .product-card {
  background: linear-gradient(
    180deg,
    rgba(30,30,50,0.75),
    rgba(18,18,35,0.55)
  );
}

/* ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ */
body[data-theme="dark"] .product-name {
  color: #f9fafb;
}

/* ‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ä‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î) */
body[data-theme="dark"] .product-price {
  color: #e9d5ff !important;
  font-weight: 800;
}

/* ‡∏£‡∏´‡∏±‡∏™ / ‡∏´‡∏°‡∏ß‡∏î */
body[data-theme="dark"] .product-code,
body[data-theme="dark"] .product-category {
  color: rgba(248,250,252,0.65) !important;
}

/* ---------- INPUT / SELECT ---------- */
body[data-theme="dark"] input,
body[data-theme="dark"] select,
body[data-theme="dark"] textarea {
  background: rgba(255,255,255,0.1);
  color: #f8fafc;
}

body[data-theme="dark"] input::placeholder {
  color: rgba(248,250,252,0.45);
}

/* ---------- INLINE COLOR KILLER (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å) ---------- */
body[data-theme="dark"] [style*="color:"] {
  color: rgba(248,250,252,0.7) !important;
}

/* ---------- MODAL ---------- */
body[data-theme="dark"] .modal-card p {
  color: rgba(248,250,252,0.7);
}

  </style>
    -->
    
   <!-- =========================
   MOBILE HARD OVERRIDE (FINAL)
   Fix header spacing + 1 column grid
========================= -->
    <!--
<style>
@media (max-width: 520px) {

  /* ===== HEADER ‚Äî FINAL FIX ===== */
  .header {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  /* ‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô: ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß 100% */
  .brand-title {
    flex: 1;
    max-width: calc(100% - 88px); /* ‡∏Å‡∏±‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏° */
    padding: 6px 12px;
    font-size: 0.85rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏Ç‡∏ß‡∏≤ */
  .header-actions {
    display: flex;
    gap: 4px;
    flex-shrink: 0;
  }

  /* ‡∏õ‡∏∏‡πà‡∏° üåô + Admin ‚Äî ‡πÄ‡∏•‡πá‡∏Å‡∏à‡∏£‡∏¥‡∏á */
  .header-actions .badge {
    padding: 5px 9px;
    font-size: 0.68rem;
    line-height: 1;
    border-radius: 999px;
  }

  /* ===== PRODUCT GRID ‚Äî 1 COLUMN LOCK ===== */
  .grid {
    display: grid !important;
    grid-template-columns: 1fr !important;
    gap: 16px !important;
  }
}
</style>
-->
    <!-- =========================
   MOBILE UI LOCK (FINAL)
   header / brand / buttons / grid
========================= -->
    <!--
<style>
@media (max-width: 520px) {

  /* ===== HEADER ===== */
  .header {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  /* ===== BRAND ‚Äî ONE LINE ONLY ===== */
  .brand-title {
    flex: 1;
    max-width: calc(100% - 90px); /* ‡∏Å‡∏±‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏°‡∏Ç‡∏ß‡∏≤ */
    padding: 6px 12px;
    font-size: 0.85rem;

    white-space: nowrap;        /* üîí ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß */
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* ===== HEADER ACTIONS ===== */
  .header-actions {
    display: flex;
    gap: 4px;
    flex-shrink: 0;             /* üîí ‡∏´‡πâ‡∏≤‡∏°‡πÇ‡∏î‡∏ô‡∏ö‡∏µ‡∏ö */
  }

  /* ===== DARK MODE + ADMIN BUTTON ===== */
  .header-actions .badge {
    padding: 5px 9px;
    font-size: 0.68rem;
    line-height: 1;
    border-radius: 999px;
  }

  /* ===== PRODUCT GRID ‚Äî FORCE 1 COLUMN ===== */
  .grid {
    display: grid !important;
    grid-template-columns: 1fr !important; /* üîí ‡∏•‡πá‡∏≠‡∏Å 1 ‡∏ä‡πà‡∏≠‡∏á */
    gap: 16px !important;
  }
}
</style>
-->
    <!-- =========================
   FINAL UI LOCK (PRODUCTION)
   Mobile + Dark Mode
========================= -->
<style>

/* =====================================================
   üì± MOBILE ‚Äî SINGLE SOURCE OF TRUTH
===================================================== */
@media (max-width: 520px) {

  /* HEADER */
  .header {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  /* BRAND ‚Äî ONE LINE */
  .brand-title {
    flex: 1;
    max-width: calc(100% - 90px);
    padding: 6px 12px;
    font-size: 0.85rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* HEADER ACTIONS */
  .header-actions {
    display: flex;
    gap: 4px;
    flex-shrink: 0;
  }

  .header-actions .badge {
    padding: 5px 9px;
    font-size: 0.68rem;
    line-height: 1;
  }

  /* PRODUCT GRID ‚Äî 1 COLUMN */
  .grid {
    display: grid !important;
    grid-template-columns: 1fr !important;
    gap: 16px !important;
  }

  /* ORDER FAB */
  .order-fab {
    width: 36px;
    height: 36px;
    font-size: 16px;
    bottom: 44px;
    right: 12px;
  }

  .order-fab::after {
    font-size: 0.6rem;
    padding: 5px 10px;
  }
}


/* =====================================================
   üåô DARK MODE ‚Äî SINGLE SOURCE (PRODUCTION)
===================================================== */
body[data-theme="dark"] {
  background: radial-gradient(
    circle at top,
    #1e1b2e,
    #141225 45%,
    #0f0d1a
  );
  color: #f8fafc;
}

/* TEXT */
body[data-theme="dark"] h1,
body[data-theme="dark"] h2,
body[data-theme="dark"] h3,
body[data-theme="dark"] b {
  color: #ffffff;
}

body[data-theme="dark"] p,
body[data-theme="dark"] small,
body[data-theme="dark"] .meta-pill {
  color: rgba(248,250,252,.7);
}

/* CARD / MODAL / SIDEBAR */
body[data-theme="dark"] .card,
body[data-theme="dark"] .modal-card,
body[data-theme="dark"] .sidebar {
  background: linear-gradient(
    180deg,
    rgba(30,30,50,0.65),
    rgba(20,20,40,0.45)
  );
  border-color: rgba(255,255,255,0.12);
}

/* BUTTON / BADGE */
body[data-theme="dark"] button,
body[data-theme="dark"] .badge,
body[data-theme="dark"] .hamburger {
  background: linear-gradient(
    160deg,
    rgba(255,255,255,0.18),
    rgba(255,255,255,0.05)
  );
  color: #f8fafc;
}

/* PRODUCT CARD */
body[data-theme="dark"] .product-card {
  background: linear-gradient(
    180deg,
    rgba(30,30,50,0.75),
    rgba(18,18,35,0.55)
  );
}

body[data-theme="dark"] .product-name {
  color: #f9fafb;
}

body[data-theme="dark"] .product-price {
  color: #e9d5ff;
  font-weight: 800;
}

/* INLINE COLOR KILL */
body[data-theme="dark"] [style*="color:"] {
  color: rgba(248,250,252,.7) !important;
}

</style>

       
</body>
</html>
